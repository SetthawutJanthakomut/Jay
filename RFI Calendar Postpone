// ===== POSTPONE RFI INSPECTION =====
// ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Calendar ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á
// ‚úÖ ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏≤ Requester + ‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ + ‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà

const SURVEY_SPREADSHEET_ID = '1rWMUNNDbbLbHljs2GsU6fzrJDjHsutS7nMvElGUNTQk';
const CALENDAR_ID = 'primary';

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI Inspection
 * 
 * @param {string} rfiNumber - RFI Number (‡πÄ‡∏ä‡πà‡∏ô "RFI #123")
 * @param {string} Description - ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ RFI
 * @param {string} newDate - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà (YYYY-MM-DD)
 * @param {string} newStartTime - ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (HH:MM)
 * @param {string} newEndTime - ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà (HH:MM)
 * @param {string} postponeReason - ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏ô
 * @param {string} requesterEmail - ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠
 * @param {string} guestEmails - ‡∏≠‡∏µ‡πÄ‡∏°‡∏• Guests (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)
 * @param {string} newLocation - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
 * @param {string} Assigned_Inspector - ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à
 * @param {boolean} sendEmail - ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 * @param {number} searchDays - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Calendar
 * @returns {Object} ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à
 */
function postponeRFIInspection(
  rfiNumber, 
  Description, 
  newDate, 
  newStartTime, 
  newEndTime, 
  postponeReason = '', 
  requesterEmail = '',
  guestEmails = '',
  newLocation = '', 
  Assigned_Inspector = '',
  sendEmail = true, 
  searchDays = 60
) {
  Logger.log(`üìÖ [POSTPONE] Starting RFI postponement for: ${rfiNumber}`);
  Logger.log(`üë• New Team: ${Assigned_Inspector}`);
  
  const validation = validatePostponeInputs(rfiNumber, Description, newDate, newStartTime, newEndTime);
  if (!validation.valid) {
    Logger.log(`‚ùå Validation failed: ${validation.error}`);
    return {
      success: false,
      error: validation.error,
      rfiNumber: rfiNumber,
      rfiDescription: Description,
      eventsFound: 0,
      eventsUpdated: 0,
      emailsSent: false
    };
  }

  const cleanRfiNumber = rfiNumber.trim();
  const cleanDescription = Description ? Description.trim() : '';
  
  let result = {
    success: false,
    rfiNumber: cleanRfiNumber,
    rfiDescription: cleanDescription,
    rfiEventsFound: 0,
    rfiEventsUpdated: 0,
    emailsSent: false,
    participants: [],
    updatedRFIEvents: [],
    error: null,
    message: '',
    originalDate: null,
    originalTeam: null,  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤
    newDate: newDate,
    newStartTime: newStartTime,
    newEndTime: newEndTime
  };

  try {
    // Step 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Calendar Events
    Logger.log("üîç Step 1: Searching Primary Calendar Events...");
    const rfiSearchResult = searchCalendarEventsByRFIAndDescription(cleanRfiNumber, cleanDescription, CALENDAR_ID, searchDays);
    
    if (rfiSearchResult.success && rfiSearchResult.events.length > 0) {
      result.rfiEventsFound = rfiSearchResult.events.length;
      result.originalDate = rfiSearchResult.events[0].startTime.toDateString();
      
      // ‚≠ê ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å Calendar Event title
      const originalTitle = rfiSearchResult.events[0].title || '';
      const originalTeam = extractInspectorFromTitle(originalTitle);
      result.originalTeam = originalTeam;
      
      Logger.log(`‚úÖ Found ${result.rfiEventsFound} RFI calendar events`);
      Logger.log(`üë• Original Team: ${originalTeam || 'N/A'}`);
    } else {
      result.error = `No calendar events found for RFI: ${cleanRfiNumber} / ${cleanDescription}`;
      result.message = result.error;
      Logger.log(‚ö†Ô∏è ${result.error}`);
      return result;
    }

    // Step 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà
    Logger.log("‚è∞ Step 2: Creating new date/time...");
    const newDateTime = createNewDateTime(newDate, newStartTime, newEndTime);
    
    if (!newDateTime.valid) {
      result.error = newDateTime.error;
      result.message = result.error;
      return result;
    }

    // Step 3: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Primary Calendar Events
    Logger.log("üìù Step 3: Updating Primary Calendar Events...");
    
    for (let i = 0; i < rfiSearchResult.events.length; i++) {
      const eventInfo = rfiSearchResult.events[i];
      
      try {
        // ‚≠ê ‡∏™‡πà‡∏á requesterEmail ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        const updateSuccess = updateCalendarEventV2(
          eventInfo,
          CALENDAR_ID,
          newDateTime.startTime,
          newDateTime.endTime,
          postponeReason,
          newLocation,
          Assigned_Inspector,
          requesterEmail  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter
        );
        
        if (updateSuccess.success) {
          result.rfiEventsUpdated++;
          result.updatedRFIEvents.push({
            eventId: eventInfo.eventId,
            title: updateSuccess.newTitle,
            calendarType: 'RFI'
          });
          Logger.log(`‚úÖ Event updated: "${eventInfo.title}"`);
        }
        
      } catch (updateError) {
        Logger.log(`‚ùå Error updating event: ${updateError.toString()}`);
      }
    }

    // Step 4: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà
    if (sendEmail && result.rfiEventsUpdated > 0) {
      Logger.log("üìß Step 4: Sending notification to Requester + OLD Team + NEW Team...");
      
      const scheduleInfo = {
        originalDate: result.originalDate || 'N/A',
        originalTime: rfiSearchResult.events[0] ? 
          `${formatTime(rfiSearchResult.events[0].startTime)} - ${formatTime(rfiSearchResult.events[0].endTime)}` : 'N/A',
        originalLocation: rfiSearchResult.events[0] ? (rfiSearchResult.events[0].location || '') : '',
        originalInspector: result.originalTeam || '',
        
        newDate: formatDateThai(newDate),
        newTime: `${newStartTime} - ${newEndTime}`,
        newLocation: newLocation || '',
        newInspector: Assigned_Inspector || ''
      };
      
      Logger.log('üìä Schedule Info:', JSON.stringify(scheduleInfo));
      
      // ‚≠ê ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      const emailResult = sendPostponementNotification(
        cleanRfiNumber,
        cleanDescription,
        postponeReason,
        result.updatedRFIEvents,
        requesterEmail,
        scheduleInfo,
        result.originalTeam  // ‚≠ê ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤
      );
      
      result.emailsSent = emailResult.success;
      Logger.log(`üìß Email: ${emailResult.success ? 'SENT' : 'FAILED'}`);
      Logger.log(`üìß Total recipients: ${emailResult.totalRecipients || 0} (Requester + OLD + NEW Team)`);
      
      if (emailResult.recipientsList && emailResult.recipientsList.length > 0) {
        Logger.log(`üìß Recipients: ${emailResult.recipientsList.join(', ')}`);
      }
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    result.success = result.rfiEventsUpdated > 0;
    
    if (result.success) {
      result.message = `‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à ${result.rfiEventsUpdated} event(s) ‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${newDate} ${newStartTime}-${newEndTime}`;
    } else {
      result.message = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI ${cleanRfiNumber} ‡πÑ‡∏î‡πâ`;
    }

  } catch (error) {
    result.error = error.toString();
    result.message = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI ${cleanRfiNumber}: ${result.error}`;
    Logger.log(`‚ùå Unexpected error: ${result.error}`);
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
  Logger.log("\n" + "=".repeat(50));
  Logger.log("üìÖ RFI POSTPONEMENT SUMMARY:");
  Logger.log(`üÜî RFI Number: ${result.rfiNumber}`);
  Logger.log(`üìÖ New Date: ${result.newDate} ${result.newStartTime}-${result.newEndTime}`);
  Logger.log(`üë• OLD Team: ${result.originalTeam || 'N/A'} ‚Üí ‚ö†Ô∏è REPLACED`);
  Logger.log(`üë• NEW Team: ${Assigned_Inspector || 'N/A'} ‚Üí ‚úÖ ASSIGNED`);
  Logger.log(`üìÖ Events Updated: ${result.rfiEventsUpdated}/${result.rfiEventsFound}`);
  Logger.log(`üë• Guest List: Updated (Requester + NEW Team only)`);
  Logger.log(`üìß Emails Sent: ${result.emailsSent ? 'YES (Requester + OLD + NEW)' : 'NO'}`);
  Logger.log(`‚úÖ Overall Success: ${result.success ? 'YES' : 'NO'}`);

  return result;
}

/**
 * ‚úÖ Validate Postpone Inputs
 */
function validatePostponeInputs(rfiNumber, description, newDate, newStartTime, newEndTime) {
  try {
    Logger.log('üîç Validating postpone inputs...');
    
    const errors = [];
    
    if (!rfiNumber || String(rfiNumber).trim() === '') {
      errors.push('RFI Number is required');
    }
    
    if (!newDate || String(newDate).trim() === '') {
      errors.push('New Date is required');
    } else {
      const dateObj = new Date(newDate + 'T00:00:00');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (isNaN(dateObj.getTime())) {
        errors.push('Invalid date format (must be YYYY-MM-DD)');
      } else if (dateObj < today) {
        errors.push('New Date must be today or in the future');
      }
    }
    
    if (!newStartTime || String(newStartTime).trim() === '') {
      errors.push('New Start Time is required');
    } else {
      const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
      if (!timePattern.test(newStartTime)) {
        errors.push('Invalid Start Time format (must be HH:MM)');
      }
    }
    
    if (!newEndTime || String(newEndTime).trim() === '') {
      errors.push('New End Time is required');
    } else {
      const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
      if (!timePattern.test(newEndTime)) {
        errors.push('Invalid End Time format (must be HH:MM)');
      }
      
      if (newStartTime) {
        const startMinutes = timeToMinutes(newStartTime);
        const endMinutes = timeToMinutes(newEndTime);
        
        if (endMinutes <= startMinutes) {
          errors.push('End Time must be after Start Time');
        }
      }
    }
    
    if (errors.length > 0) {
      Logger.log('‚ùå Validation failed:');
      errors.forEach(err => Logger.log(`   - ${err}`));
      
      return {
        valid: false,
        error: errors.join('; ')
      };
    }
    
    Logger.log('‚úÖ Validation passed');
    return {
      valid: true,
      error: null
    };
    
  } catch (error) {
    Logger.log(`‚ùå Validation error: ${error.toString()}`);
    return {
      valid: false,
      error: `Validation error: ${error.toString()}`
    };
  }
}

// ===== HELPER FUNCTIONS =====

/**
 * ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Calendar Events ‡∏ï‡∏≤‡∏° RFI Number ‡πÅ‡∏•‡∏∞ Description
 */
function searchCalendarEventsByRFIAndDescription(rfiNumber, description, calendarId, searchDays = 60) {
  Logger.log(`üîç Searching calendar "${calendarId}" for RFI Number: ${rfiNumber}`);
  
  try {
    const calendar = CalendarApp.getCalendarById(calendarId);
    if (!calendar) {
      throw new Error(`Cannot access calendar: ${calendarId}`);
    }

    const startDate = new Date();
    startDate.setDate(startDate.getDate() - searchDays);
    
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + searchDays);
    
    const allEvents = calendar.getEvents(startDate, endDate);
    Logger.log(`üìä Total events in range: ${allEvents.length}`);
    
    if (allEvents.length === 0) {
      return { success: false, message: 'No events found in date range', events: [] };
    }

    const matchingEvents = [];
    
    const rfiSearchPatterns = [
      `RFI #${rfiNumber}`,
      `RFI-${rfiNumber}`,
      `#${rfiNumber}`,
      rfiNumber
    ];
    
    allEvents.forEach((event, index) => {
      try {
        const title = event.getTitle() || '';
        const eventDescription = event.getDescription() || '';
        const searchableText = (title + ' ' + eventDescription).toLowerCase();
        
        const rfiMatch = rfiSearchPatterns.some(pattern => 
          searchableText.includes(pattern.toLowerCase())
        );
        
        if (rfiMatch) {
          Logger.log(`‚úÖ Found matching event: "${title}"`);
          
          matchingEvents.push({
            event: event,
            eventId: event.getId(),
            title: title,
            description: eventDescription,
            startTime: event.getStartTime(),
            endTime: event.getEndTime(),
            location: event.getLocation() || '',
            created: event.getDateCreated(),
            lastUpdated: event.getLastUpdated()
          });
        }
        
      } catch (eventError) {
        Logger.log(`‚ö†Ô∏è Error processing event ${index + 1}: ${eventError.toString()}`);
      }
    });
    
    matchingEvents.sort((a, b) => b.created - a.created);
    
    return {
      success: matchingEvents.length > 0,
      message: `Found ${matchingEvents.length} events for RFI: ${rfiNumber}`,
      events: matchingEvents
    };
    
  } catch (error) {
    Logger.log(`‚ùå Error searching calendar events: ${error.toString()}`);
    return { success: false, error: error.toString(), events: [] };
  }
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Calendar Event ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Guest List
 */
function updateCalendarEventV2(eventInfo, calendarId, newStartTime, newEndTime, postponeReason, newLocation, assignedInspector, requesterEmail) {
  Logger.log(`üìù Updating event in "${calendarId}": ${eventInfo.eventId}`);
  
  try {
    const calendar = CalendarApp.getCalendarById(calendarId);
    if (!calendar) {
      return { success: false, error: `Cannot access calendar: ${calendarId}` };
    }
    
    const event = calendar.getEventById(eventInfo.eventId);
    
    if (!event) {
      return { success: false, error: `Event not found: ${eventInfo.eventId}` };
    }

    const originalStartTime = event.getStartTime();
    const originalEndTime = event.getEndTime();
    const originalLocation = event.getLocation();
    const originalDescription = event.getDescription() || '';
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
    event.setTime(newStartTime, newEndTime);
    Logger.log(`‚úÖ Updated time: ${newStartTime} - ${newEndTime}`);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Location
    const finalLocation = newLocation && newLocation.trim() !== '' ? newLocation.trim() : originalLocation;
    if (finalLocation) {
      event.setLocation(finalLocation);
      Logger.log(`üìç Updated location: ${finalLocation}`);
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Title
    const currentTitle = event.getTitle();
    let newTitle = currentTitle;
    
    if (!currentTitle.includes('üìÖ POSTPONED')) {
      newTitle = `üìÖ POSTPONED - ${currentTitle}`;
      event.setTitle(newTitle);
      Logger.log(`üè∑Ô∏è Updated title: ${newTitle}`);
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ
    const teamMatch = currentTitle.match(/\[([^\]]+)\]$/);
    const currentTeam = teamMatch ? teamMatch[1] : null;
    
    if (assignedInspector && String(assignedInspector).trim() !== '') {
      const teams = String(assignedInspector).trim().split(',').map(t => t.trim());
      const teamColors = getTeamColors(assignedInspector);
      
      if (currentTeam && teams.includes(currentTeam) && teamColors[currentTeam]) {
        event.setColor(teamColors[currentTeam]);
        Logger.log(`üé® Updated color for team: ${currentTeam}`);
      } else if (teams.length > 0 && teamColors[teams[0]]) {
        event.setColor(teamColors[teams[0]]);
        Logger.log(`üé® Set color for team: ${teams[0]}`);
      }
      
      // ‚≠ê‚≠ê‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Guest List ‚≠ê‚≠ê‚≠ê
      Logger.log('üë• Updating Guest list...');
      
      // 1. ‡∏î‡∏∂‡∏á Guest list ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const currentGuests = event.getGuestList(true);
      Logger.log(`Current guests: ${currentGuests.length}`);
      
      // 2. ‡∏•‡∏ö Guest ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Requester)
      const requesterEmailClean = requesterEmail ? String(requesterEmail).trim().toLowerCase() : '';
      
      currentGuests.forEach(function(guest) {
        try {
          const guestEmail = guest.getEmail().toLowerCase();
          
          if (guestEmail !== requesterEmailClean) {
            event.removeGuest(guestEmail);
            Logger.log(`üóëÔ∏è Removed guest: ${guestEmail}`);
          }
        } catch (e) {
          Logger.log(`‚ö†Ô∏è Could not remove guest: ${e.toString()}`);
        }
      });
      
      // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° Requester (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
      if (requesterEmailClean && requesterEmailClean.includes('@')) {
        try {
          event.addGuest(requesterEmailClean);
          Logger.log(`‚úÖ Added Requester: ${requesterEmailClean}`);
        } catch (e) {
          Logger.log(`‚ö†Ô∏è Could not add Requester: ${e.toString()}`);
        }
      }
      
      // 4. ‡πÄ‡∏û‡∏¥‡πà‡∏° Team members ‡πÉ‡∏´‡∏°‡πà
      const teamEmails = getTeamEmailsByTeamNames(assignedInspector);
      Logger.log(`Team members to add: ${teamEmails.length}`);
      
      teamEmails.forEach(function(teamMember) {
        try {
          const teamEmail = String(teamMember.email).trim().toLowerCase();
          
          if (teamEmail !== requesterEmailClean) {
            event.addGuest(teamEmail);
            Logger.log(`‚úÖ Added team member: ${teamMember.name} (${teamEmail})`);
          }
        } catch (e) {
          Logger.log(`‚ö†Ô∏è Could not add team member: ${e.toString()}`);
        }
      });
      
      Logger.log('‚úÖ Guest list updated successfully');
      // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Guest List ‚≠ê‚≠ê‚≠ê
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Postponement Record
    const postponementRecord = `
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô (INSPECTION POSTPONED)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚è∞ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°:
   üìÖ ${originalStartTime.toLocaleDateString('th-TH', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
   })}
   üïê ${originalStartTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })} - ${originalEndTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })}
   üìç ${originalLocation || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'}

üîÑ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà:
   üìÖ ${newStartTime.toLocaleDateString('th-TH', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
   })}
   üïê ${newStartTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })} - ${newEndTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })}
   üìç ${finalLocation || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'}

${assignedInspector && String(assignedInspector).trim() !== '' ? `üë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à: ${assignedInspector}\n` : ''}
${postponeReason ? `üí¨ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:\n   ${postponeReason}\n` : ''}
üìå ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}
ü§ñ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢: RFI System

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
`;
    
    const newDescription = postponementRecord + '\n' + originalDescription;
    event.setDescription(newDescription);
    
    Logger.log(`‚úÖ Event updated successfully in ${calendarId}`);
    
    return {
      success: true,
      newTitle: newTitle,
      newLocation: finalLocation,
      guestsUpdated: true
    };
    
  } catch (error) {
    Logger.log(`‚ùå Error updating event: ${error.toString()}`);
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * ‚≠ê ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function sendPostponementNotification(rfiNumber, Description, postponeReason, updatedEvents, requesterEmail, scheduleInfo, originalTeamNames) {
  Logger.log('\n' + '='.repeat(50));
  Logger.log('üìß SENDING POSTPONEMENT NOTIFICATION (TH)');
  Logger.log('='.repeat(50));
  
  Logger.log(`üìß Requester: ${requesterEmail || 'NOT PROVIDED'}`);
  Logger.log(`üë• OLD Team: ${originalTeamNames || 'NOT PROVIDED'}`);
  Logger.log(`üë• NEW Team: ${scheduleInfo?.newInspector || 'NOT PROVIDED'}`);
  
  try {
    const quota = checkEmailQuota();
    Logger.log(`üìä Email quota remaining: ${quota}`);
    
    if (quota <= 0) {
      Logger.log('‚ùå Email quota exceeded');
      return { success: false, message: "Email quota exceeded" };
    }

    // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const oldTeamClean = (originalTeamNames || '').trim();
    const newTeamClean = (scheduleInfo?.newInspector || '').trim();
    const isTeamChanged = oldTeamClean !== newTeamClean && oldTeamClean !== '';
    
    Logger.log(`\nüîç Team changed: ${isTeamChanged}`);
    if (isTeamChanged) {
      Logger.log(`   OLD: "${oldTeamClean}"`);
      Logger.log(`   NEW: "${newTeamClean}"`);
    } else {
      Logger.log(`   Same team: "${newTeamClean}"`);
    }

    // ‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    const allRecipients = new Set();
    const oldTeamEmails = [];
    const newTeamEmails = [];
    
    // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° Requester
    if (requesterEmail && String(requesterEmail).trim() !== '' && String(requesterEmail).includes('@')) {
      const cleanEmail = String(requesterEmail).trim();
      allRecipients.add(cleanEmail);
      Logger.log(`‚úÖ Added Requester: ${cleanEmail}`);
    }
    
    // 2. ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°)
    if (isTeamChanged && oldTeamClean !== '') {
      Logger.log(`\nüë• Processing OLD Team (will be notified): ${oldTeamClean}`);
      
      const oldTeamResult = getTeamEmailsByTeamNames(oldTeamClean);
      
      if (oldTeamResult && oldTeamResult.length > 0) {
        oldTeamResult.forEach((teamMember, index) => {
          const teamEmail = teamMember.email;
          if (teamEmail && teamEmail.includes('@')) {
            allRecipients.add(teamEmail);
            oldTeamEmails.push(teamEmail);
            Logger.log(`‚úÖ Added OLD Team ${index + 1}: ${teamMember.name} -> ${teamEmail}`);
          }
        });
      }
    } else if (!isTeamChanged) {
      Logger.log(`\nüë• Team unchanged - OLD team will NOT receive separate notification`);
    }
    
    // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
    if (scheduleInfo && scheduleInfo.newInspector) {
      Logger.log(`\nüë• Processing ${isTeamChanged ? 'NEW' : 'Current'} Team: ${scheduleInfo.newInspector}`);
      
      const newTeamResult = getTeamEmailsByTeamNames(scheduleInfo.newInspector);
      
      if (newTeamResult && newTeamResult.length > 0) {
        newTeamResult.forEach((teamMember, index) => {
          const teamEmail = teamMember.email;
          if (teamEmail && teamEmail.includes('@')) {
            allRecipients.add(teamEmail);
            newTeamEmails.push(teamEmail);
            Logger.log(`‚úÖ Added ${isTeamChanged ? 'NEW' : 'Current'} Team ${index + 1}: ${teamMember.name} -> ${teamEmail}`);
          }
        });
      }
    }
    
    const finalRecipients = Array.from(allRecipients);
    
    Logger.log(`\nüìä FINAL: ${finalRecipients.length} recipients`);
    
    if (finalRecipients.length === 0) {
      Logger.log('‚ùå No recipients');
      return { 
        success: false, 
        message: "No recipients",
        totalRecipients: 0
      };
    }

    const subject = isTeamChanged 
      ? `üìÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô + ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏° - RFI #${rfiNumber}`
      : `üìÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô - RFI #${rfiNumber}`;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Events
    let eventsList = '<ul style="margin: 10px 0;">';
    updatedEvents.forEach(evt => {
      eventsList += `<li style="margin: 5px 0;"><strong>${evt.title}</strong></li>`;
    });
    eventsList += '</ul>';
    
    // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
    let scheduleComparisonHtml = '';
    if (scheduleInfo) {
      scheduleComparisonHtml = `
<h3>üìÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:</h3>
<table style="margin: 15px 0; width: 100%;">
<thead>
<tr style="background-color: #f8f9fa;">
  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">‡πÄ‡∏î‡∏¥‡∏°</th>
  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">‡πÉ‡∏´‡∏°‡πà</th>
</tr>
</thead>
<tbody>
<tr>
  <td style="padding: 10px; border: 1px solid #ddd;"><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</strong></td>
  <td style="padding: 10px; border: 1px solid #ddd;">${scheduleInfo.originalDate}</td>
  <td style="padding: 10px; border: 1px solid #ddd; background-color: #e7f3ff;"><strong>${scheduleInfo.newDate}</strong></td>
</tr>
<tr>
  <td style="padding: 10px; border: 1px solid #ddd;"><strong>üïê ‡πÄ‡∏ß‡∏•‡∏≤</strong></td>
  <td style="padding: 10px; border: 1px solid #ddd;">${scheduleInfo.originalTime}</td>
  <td style="padding: 10px; border: 1px solid #ddd; background-color: #e7f3ff;"><strong>${scheduleInfo.newTime}</strong></td>
</tr>
${scheduleInfo.originalLocation || scheduleInfo.newLocation ? `
<tr>
  <td style="padding: 10px; border: 1px solid #ddd;"><strong>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</strong></td>
  <td style="padding: 10px; border: 1px solid #ddd;">${scheduleInfo.originalLocation || '-'}</td>
  <td style="padding: 10px; border: 1px solid #ddd; background-color: #e7f3ff;"><strong>${scheduleInfo.newLocation || '-'}</strong></td>
</tr>
` : ''}
${scheduleInfo.originalInspector || scheduleInfo.newInspector ? `
<tr>
  <td style="padding: 10px; border: 1px solid #ddd;"><strong>üë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</strong></td>
  <td style="padding: 10px; border: 1px solid #ddd;">${scheduleInfo.originalInspector || '-'}</td>
  <td style="padding: 10px; border: 1px solid #ddd; background-color: #e7f3ff;"><strong>${scheduleInfo.newInspector || '-'}</strong></td>
</tr>
` : ''}
</tbody>
</table>`;
    }
    
    // ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
    let reasonHtml = '';
    if (postponeReason && String(postponeReason).trim() !== '') {
      reasonHtml = `
<div style="background-color: #fffacd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px;">
  <strong style="color: #856404;">üí¨ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏ô:</strong>
  <p style="margin: 8px 0 0 0; color: #333;">${postponeReason}</p>
</div>`;
    }
    
    // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡πÅ‡∏¢‡∏Å‡∏™‡∏µ)
    let recipientListHtml = '';
    if (finalRecipients.length > 0) {
      recipientListHtml = `
<h3>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</h3>
<table style="margin: 10px 0;">
<tr style="background-color: #f2f2f5;">
  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
  <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
</tr>`;
      
      finalRecipients.forEach(email => {
        let role = '‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á';
        let bgColor = '';
        
        if (email === requesterEmail) {
          role = '<strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</strong>';
          bgColor = 'background-color: #d1ecf1;';
        } else if (oldTeamEmails.includes(email)) {
          role = '<span style="color: #856404;">‚ö†Ô∏è ‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</span>';
          bgColor = 'background-color: #fff3cd;';
        } else if (newTeamEmails.includes(email)) {
          role = '<span style="color: #155724;">‚úÖ ‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢)</span>';
          bgColor = 'background-color: #d4edda;';
        }
        
        recipientListHtml += `<tr style="${bgColor}"><td style="padding: 8px; border: 1px solid #ddd;">${email}</td><td style="padding: 8px; border: 1px solid #ddd;">${role}</td></tr>`;
      });
      
      recipientListHtml += `</table>`;
    }
    
    const htmlMessage = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><style>
body { font-family: 'Sarabun', Arial, sans-serif; margin: 20px; line-height: 1.6; }
h2 { color: #ff6b35; margin-bottom: 10px; }
h3 { color: #333; margin-top: 25px; margin-bottom: 12px; }
table { border-collapse: collapse; width: 100%; margin: 10px 0; }
td, th { border: 1px solid #ddd; padding: 10px; text-align: left; }
th { background-color: #f2f2f5; font-weight: 600; }
.info-box { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px; }
.note { background-color: #e7f3ff; border-left: 4px solid #1877f2; padding: 15px; margin: 15px 0; border-radius: 5px; }
.warning-box { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px; }
.success-box { background-color: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; border-radius: 5px; }
ul { padding-left: 20px; }
li { margin: 5px 0; }
</style></head>
<body>
<h2>üìÖ ${isTeamChanged ? '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô RFI ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô' : '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô RFI'}</h2>

<div class="info-box">
  <strong>‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ${isTeamChanged 
    ? '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö'
    : '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà'}
</div>

${isTeamChanged && oldTeamEmails.length > 0 ? `
<div class="warning-box">
  <strong>üì¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ (${scheduleInfo.originalInspector || '‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°'}):</strong><br>
  ‚ö†Ô∏è ‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å<strong>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</strong>‡πÅ‡∏•‡∏∞<strong>‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á</strong>‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ<br>
  ‚ÑπÔ∏è ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡πÜ
</div>
` : ''}

${isTeamChanged && newTeamEmails.length > 0 ? `
<div class="success-box">
  <strong>üì¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà (${scheduleInfo.newInspector || '‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà'}):</strong><br>
  ‚úÖ ‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö<strong>‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</strong>‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ<br>
  üìÖ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
</div>
` : ''}

${!isTeamChanged && newTeamEmails.length > 0 ? `
<div class="note">
  <strong>üì¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô (${scheduleInfo.newInspector || '‡∏ó‡∏µ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'}):</strong><br>
  üìÖ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á<br>
  ‚ÑπÔ∏è ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
</div>
` : ''}

<h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI:</h3>
<table>
<tr><th style="width: 30%;">RFI Number</th><td><strong>${rfiNumber}</strong></td></tr>
<tr><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><td>${Description}</td></tr>
</table>

${scheduleComparisonHtml}

${reasonHtml}

<h3>üìÖ Calendar Events ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:</h3>
${eventsList}

${recipientListHtml}

<div class="note">
  <strong>üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> 
  <ul style="margin: 10px 0; padding-left: 20px;">
    ${isTeamChanged ? `
    <li>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á <strong>‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</strong> (‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ + ‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ + ‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà)</li>
    <li><strong style="color: #856404;">‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤:</strong> ‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</li>
    <li><strong style="color: #155724;">‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà:</strong> ‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</li>
    ` : `
    <li>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á <strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</strong></li>
    <li><strong>‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô:</strong> ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</li>
    `}
    <li>Calendar events ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</li>
    <li>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡∏° QC</li>
  </ul>
</div>

<hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">
<p style="color: #666; font-size: 12px; margin: 5px 0;">
üì® <strong>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</strong> ${finalRecipients.length} ‡∏Ñ‡∏ô ${isTeamChanged ? '(‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ + ‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤ + ‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà)' : '(‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ + ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô)'}<br>
ü§ñ <strong>‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢:</strong> ‡∏£‡∏∞‡∏ö‡∏ö RFI - ${isTeamChanged ? '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏°' : '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à'}<br>
üïê <strong>‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${new Date().toLocaleString('th-TH')}
</p>
</body>
</html>`;
    
    const recipientList = finalRecipients.join(',');
    
    Logger.log(`\nüì§ Sending email...`);
    Logger.log(`üìß To: ${recipientList}`);
    Logger.log(`üìß Subject: ${subject}`);
    
    const sent = safeSendEmail({
      to: recipientList,
      subject: subject,
      htmlBody: htmlMessage,
      name: '‡∏£‡∏∞‡∏ö‡∏ö RFI - ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à'
    });
    
    if (sent) {
      Logger.log(`‚úÖ EMAIL SENT to ${finalRecipients.length} recipients`);
    } else {
      Logger.log(`‚ùå EMAIL FAILED`);
    }
    
    return {
      success: sent,
      totalSent: sent ? finalRecipients.length : 0,
      totalRecipients: finalRecipients.length,
      recipientsList: finalRecipients
    };
    
  } catch (error) {
    Logger.log(`‚ùå EMAIL ERROR: ${error.toString()}`);
    return { 
      success: false, 
      error: error.toString(),
      totalRecipients: 0
    };
  }
}

function createNewDateTime(dateStr, startTimeStr, endTimeStr) {
  try {
    const startDate = new Date(dateStr + 'T00:00:00+07:00');
    const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
    startDate.setHours(startHours, startMinutes, 0, 0);
    
    const endDate = new Date(dateStr + 'T00:00:00+07:00');
    const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
    endDate.setHours(endHours, endMinutes, 0, 0);
    
    return {
      valid: true,
      startTime: startDate,
      endTime: endDate
    };
    
  } catch (error) {
    return {
      valid: false,
      error: `Invalid date/time format: ${error.toString()}`
    };
  }
}

// ===== UTILITY FUNCTIONS =====

function timeToMinutes(timeString) {
  if (!timeString) return 0;
  const parts = timeString.split(':');
  return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function checkEmailQuota() {
  try {
    const remainingQuota = MailApp.getRemainingDailyQuota();
    console.log('Remaining email quota:', remainingQuota);
    return remainingQuota;
  } catch (error) {
    console.error('Error checking email quota:', error);
    return 0;
  }
}

function safeSendEmail(emailParams) {
  try {
    const quota = checkEmailQuota();
    if (quota <= 0) {
      console.log('Email quota exceeded, skipping email');
      return false;
    }
    
    MailApp.sendEmail(emailParams);
    return true;
  } catch (error) {
    console.error('Error sending email:', error);
    return false;
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏à‡∏≤‡∏Å Title
 */
function extractInspectorFromTitle(title) {
  if (!title) return '';
  
  const match = title.match(/\[([^\]]+)\]/);
  if (match && match[1]) {
    return match[1];
  }
  
  return '';
}

/**
 * Format Date ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
 */
function formatDateThai(dateString) {
  if (!dateString) return '';
  
  const months = [
    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
  ];
  
  const date = new Date(dateString + 'T00:00:00');
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear() + 543;
  
  return `${day} ${month} ${year}`;
}

/**
 * Format Time (HH:MM)
 */
function formatTime(timeValue) {
  if (!timeValue) return '';
  
  if (typeof timeValue === 'string') {
    return timeValue;
  }
  
  if (timeValue instanceof Date) {
    const hours = String(timeValue.getHours()).padStart(2, '0');
    const minutes = String(timeValue.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
  }
  
  return timeValue.toString();
}

// ===== COLOR FUNCTIONS (‡∏à‡∏≤‡∏Å Resources Sheet) =====

function getTeamColors(assignedInspector) {
  try {
    if (!assignedInspector || String(assignedInspector).trim() === '') {
      return {};
    }
    
    const teamString = String(assignedInspector).trim();
    const requestedTeams = teamString.split(',').map(t => t.trim()).filter(t => t.length > 0);
    
    if (requestedTeams.length === 0) {
      return {};
    }
    
    const sheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).getSheetByName('Resources');
    
    if (!sheet) {
      return {};
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return {};
    }
    
    const teamData = sheet.getRange(2, 2, lastRow - 1, 1).getValues();
    const colorData = sheet.getRange(2, 8, lastRow - 1, 1).getValues();
    
    const teamColors = {};
    
    for (let i = 0; i < teamData.length; i++) {
      const teamName = String(teamData[i][0] || '').trim();
      const colorValue = String(colorData[i][0] || '').trim();
      
      if (requestedTeams.includes(teamName) && colorValue) {
        teamColors[teamName] = getCalendarColor(colorValue);
      }
    }
    
    requestedTeams.forEach(function(team) {
      if (!teamColors[team]) {
        teamColors[team] = CalendarApp.EventColor.BLUE;
      }
    });
    
    return teamColors;
    
  } catch (error) {
    console.error('Error loading team colors:', error);
    return {};
  }
}

function getCalendarColor(colorHex) {
  const colorNameMap = {
    'PALE_BLUE': CalendarApp.EventColor.PALE_BLUE,
    'PALE_GREEN': CalendarApp.EventColor.PALE_GREEN,
    'MAUVE': CalendarApp.EventColor.MAUVE,
    'PALE_RED': CalendarApp.EventColor.PALE_RED,
    'YELLOW': CalendarApp.EventColor.YELLOW,
    'ORANGE': CalendarApp.EventColor.ORANGE,
    'CYAN': CalendarApp.EventColor.CYAN,
    'GRAY': CalendarApp.EventColor.GRAY,
    'BLUE': CalendarApp.EventColor.BLUE,
    'GREEN': CalendarApp.EventColor.GREEN,
    'RED': CalendarApp.EventColor.RED
  };
  
  const colorUpper = String(colorHex).toUpperCase();
  if (colorNameMap[colorUpper]) {
    return colorNameMap[colorUpper];
  }
  
  if (colorHex && colorHex.toString().startsWith('#')) {
    return hexToCalendarColor(colorHex);
  }
  
  return CalendarApp.EventColor.BLUE;
}

function hexToCalendarColor(hexColor) {
  const inputRGB = hexToRGB(hexColor);
  if (!inputRGB) {
    return CalendarApp.EventColor.BLUE;
  }
  
  const calendarColors = [
    { name: 'PALE_BLUE', color: CalendarApp.EventColor.PALE_BLUE, rgb: {r: 161, g: 194, b: 250} },
    { name: 'PALE_GREEN', color: CalendarApp.EventColor.PALE_GREEN, rgb: {r: 183, g: 225, b: 205} },
    { name: 'MAUVE', color: CalendarApp.EventColor.MAUVE, rgb: {r: 162, g: 137, b: 209} },
    { name: 'PALE_RED', color: CalendarApp.EventColor.PALE_RED, rgb: {r: 244, g: 164, b: 164} },
    { name: 'YELLOW', color: CalendarApp.EventColor.YELLOW, rgb: {r: 251, g: 233, b: 131} },
    { name: 'ORANGE', color: CalendarApp.EventColor.ORANGE, rgb: {r: 255, g: 183, b: 134} },
    { name: 'CYAN', color: CalendarApp.EventColor.CYAN, rgb: {r: 137, g: 218, b: 235} },
    { name: 'GRAY', color: CalendarApp.EventColor.GRAY, rgb: {r: 158, g: 158, b: 158} },
    { name: 'BLUE', color: CalendarApp.EventColor.BLUE, rgb: {r: 66, g: 133, b: 244} },
    { name: 'GREEN', color: CalendarApp.EventColor.GREEN, rgb: {r: 51, g: 182, b: 121} },
    { name: 'RED', color: CalendarApp.EventColor.RED, rgb: {r: 234, g: 67, b: 53} }
  ];
  
  let closestColor = calendarColors[0];
  let minDistance = colorDistance(inputRGB, calendarColors[0].rgb);
  
  for (let i = 1; i < calendarColors.length; i++) {
    const distance = colorDistance(inputRGB, calendarColors[i].rgb);
    if (distance < minDistance) {
      minDistance = distance;
      closestColor = calendarColors[i];
    }
  }
  
  return closestColor.color;
}

function hexToRGB(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

function colorDistance(rgb1, rgb2) {
  return Math.sqrt(
    Math.pow(rgb1.r - rgb2.r, 2) +
    Math.pow(rgb1.g - rgb2.g, 2) +
    Math.pow(rgb1.b - rgb2.b, 2)
  );
}

// ===== TEST FUNCTIONS =====

/**
 * üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à + ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡∏° (‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà)
 */
function testPostponeWithTeamChange() {
  Logger.log('üß™ TEST: Postpone with Team Change');
  Logger.log('='.repeat(50));
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];
  
  const testData = {
    rfiNumber: '10-RFI-0022',
    description: 'test',
    newDate: tomorrowStr,
    newStartTime: '14:00',
    newEndTime: '16:00',
    postponeReason: 'üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö - ‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô',
    requesterEmail: 'setthawut.se11@gmail.com',
    newLocation: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà',
    newTeam: 'Survey Team B, Lab Team B',  // ‚≠ê ‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà
    sendEmail: true,
    searchDays: 30
  };
  
  Logger.log(`üìÖ Date: ${testData.newDate}`);
  Logger.log(`üïê Time: ${testData.newStartTime} - ${testData.newEndTime}`);
  Logger.log(`üë• NEW Team: ${testData.newTeam}`);
  Logger.log('');
  
  const result = postponeRFIInspection(
    testData.rfiNumber,
    testData.description,
    testData.newDate,
    testData.newStartTime,
    testData.newEndTime,
    testData.postponeReason,
    testData.requesterEmail,
    '',
    testData.newLocation,
    testData.newTeam,
    testData.sendEmail,
    testData.searchDays
  );
  
  Logger.log('\n' + '='.repeat(50));
  Logger.log('üìä TEST RESULT:');
  Logger.log('='.repeat(50));
  Logger.log(`‚úÖ Success: ${result.success}`);
  Logger.log(`üìÖ Events: ${result.rfiEventsUpdated}/${result.rfiEventsFound}`);
  Logger.log(`üë• OLD Team: ${result.originalTeam || 'N/A'} ‚Üí ‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß`);
  Logger.log(`üë• NEW Team: ${testData.newTeam} ‚Üí ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß`);
  Logger.log(`üìß Email Sent: ${result.emailsSent}`);
  Logger.log(`üí¨ Message: ${result.message}`);
  
  if (result.error) {
    Logger.log(`\n‚ùå Error: ${result.error}`);
  }
  
  Logger.log('\nüìß Expected Email Recipients:');
  Logger.log('  1. üë§ Requester');
  Logger.log('  2. üë• OLD Team ‚Üí ‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô');
  Logger.log('  3. üë• NEW Team ‚Üí ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢');
  Logger.log('='.repeat(50));
}

/**
 * üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
 */
function testExtractTeamFromTitle() {
  const testTitles = [
    'RFI #10-RFI-0022 [Survey Team A]',
    'RFI #10-RFI-0023 [Lab Team B, Inspector Team A]',
    'RFI #10-RFI-0024'
  ];
  
  Logger.log('üß™ TEST: Extract Team from Title');
  testTitles.forEach(title => {
    const team = extractInspectorFromTitle(title);
    Logger.log(`"${title}" ‚Üí Team: "${team}"`);
  });
}
