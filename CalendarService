// version 1 18/10/2025 10:12
/**
 * â­ PROJECT B: Calendar Service
 * Deploy as Web App:
 * - Execute as: Me (developeritd75@gmail.com)
 * - Who has access: Anyone
 */

// â­ API Key à¸ªà¸³à¸«à¸£à¸±à¸š Authentication (à¸ªà¸£à¹‰à¸²à¸‡ random key à¸¢à¸²à¸§à¹†)
const API_KEY = 'sk_live_abc123def456ghi789jkl012mno345pqr678stu901vwx234yz';

// â­ Calendar ID à¸‚à¸­à¸‡ developeritd75@gmail.com
const CALENDAR_ID = 'primary'; // à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰ ID à¹€à¸‰à¸à¸²à¸°

/**
 * â­ doPost - à¸£à¸±à¸š Request à¸ˆà¸²à¸ Project A
 */
function doPost(e) {
  try {
    Logger.log('========== Calendar Service Received Request ==========');
    
    // 1. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Content-Type
    const contentType = e.postData.type;
    if (contentType !== 'application/json') {
      return createResponse(false, 'Invalid content type');
    }
    
    // 2. Parse JSON
    const requestData = JSON.parse(e.postData.contents);
    Logger.log('Request data:', JSON.stringify(requestData));
    
    // 3. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š API Key
    if (!requestData.apiKey || requestData.apiKey !== API_KEY) {
      Logger.log('âŒ Invalid API Key');
      return createResponse(false, 'Unauthorized - Invalid API Key');
    }
    
    // 4. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Action
    if (requestData.action !== 'createSurveyWorkEvent') {
      return createResponse(false, 'Invalid action');
    }
    
    // 5. à¸ªà¸£à¹‰à¸²à¸‡ Calendar Event
    const result = createCalendarEvent(requestData.data);
    
    Logger.log('Result:', JSON.stringify(result));
    return createResponse(result.success, result.message, result.data);
    
  } catch (error) {
    Logger.log('âŒ Error in doPost:', error.toString());
    return createResponse(false, 'Server error: ' + error.toString());
  }
}

/**
 * â­ à¸ªà¸£à¹‰à¸²à¸‡ Calendar Event
 */
function createCalendarEvent(data) {
  try {
    Logger.log('Creating calendar event...');
    Logger.log('Data:', JSON.stringify(data));
    
    // Validate required fields
    const required = ['requestDate', 'startTime', 'endTime', 'description', 
                     'location', 'requesterName', 'requesterEmail', 
                     'assignedTeam', 'surveyNo'];
    
    for (let i = 0; i < required.length; i++) {
      if (!data[required[i]]) {
        return {
          success: false,
          message: 'Missing required field: ' + required[i]
        };
      }
    }
    
    // Get Calendar
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    
    if (!calendar) {
      return {
        success: false,
        message: 'Calendar not found'
      };
    }
    
    Logger.log('âœ… Calendar found:', calendar.getName());
    
    // Parse Date & Time
    const dateParts = data.requestDate.split('-');
    const year = parseInt(dateParts[0]);
    const month = parseInt(dateParts[1]) - 1;
    const day = parseInt(dateParts[2]);
    
    const startParts = data.startTime.split(':');
    const startHour = parseInt(startParts[0]);
    const startMin = parseInt(startParts[1]);
    
    const endParts = data.endTime.split(':');
    const endHour = parseInt(endParts[0]);
    const endMin = parseInt(endParts[1]);
    
    const startDateTime = new Date(year, month, day, startHour, startMin, 0);
    const endDateTime = new Date(year, month, day, endHour, endMin, 0);
    
    // Create Event Title
    const eventTitle = 'ğŸ—ºï¸ Survey Work: ' + data.surveyNo + ' - ' + data.assignedTeam;
    
    // Create Description
    const description = 
      'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
      'ğŸ—ºï¸ SURVEY WORK REQUEST\n' +
      'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n' +
      'Survey NO: ' + data.surveyNo + '\n' +
      'à¸—à¸µà¸¡à¸‡à¸²à¸™: ' + data.assignedTeam + '\n' +
      'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”: ' + data.description + '\n' +
      'à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ: ' + data.location + '\n\n' +
      'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n' +
      'à¸œà¸¹à¹‰à¸‚à¸­: ' + data.requesterName + '\n' +
      'à¸­à¸µà¹€à¸¡à¸¥à¸œà¸¹à¹‰à¸‚à¸­: ' + data.requesterEmail + '\n' +
      'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n' +
      'à¸§à¸±à¸™à¸—à¸µà¹ˆ: ' + formatDateThai(data.requestDate) + '\n' +
      'à¹€à¸§à¸¥à¸²: ' + data.startTime + ' - ' + data.endTime + ' à¸™.\n\n' +
      'à¸›à¸£à¸°à¹€à¸ à¸—: Survey Work\n' +
      'à¸ªà¸–à¸²à¸™à¸°: Survey Work Request Submitted\n\n' +
      'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
      'à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸”à¸¢ Calendar Service\n' +
      'à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡: ' + new Date().toLocaleString('th-TH') + '\n' +
      'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
    
    // Guest List
    const guestList = [];
    
    if (data.requesterEmail) {
      guestList.push(data.requesterEmail);
    }
    
    if (data.teamEmails && Array.isArray(data.teamEmails)) {
      data.teamEmails.forEach(function(email) {
        if (email && guestList.indexOf(email) === -1) {
          guestList.push(email);
        }
      });
    }
    
    Logger.log('Guest list:', guestList.join(', '));
    
    // Create Event
    const event = calendar.createEvent(
      eventTitle,
      startDateTime,
      endDateTime,
      {
        description: description,
        location: data.location,
        guests: guestList.join(','),
        sendInvites: true
      }
    );
    
    // Set Color
    try {
      event.setColor(CalendarApp.EventColor.GREEN);
    } catch (e) {
      Logger.log('Could not set color:', e.message);
    }
    
    Logger.log('âœ… Event created:', event.getId());
    
    return {
      success: true,
      message: 'Calendar event created successfully',
      data: {
        eventId: event.getId(),
        eventTitle: eventTitle,
        guestsCount: guestList.length,
        calendarName: calendar.getName()
      }
    };
    
  } catch (error) {
    Logger.log('âŒ Error creating event:', error.toString());
    
    return {
      success: false,
      message: 'Failed to create calendar event: ' + error.toString()
    };
  }
}

/**
 * â­ Helper: à¸ªà¸£à¹‰à¸²à¸‡ JSON Response
 */
function createResponse(success, message, data) {
  const response = {
    success: success,
    message: message || ''
  };
  
  if (data) {
    response.data = data;
  }
  
  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * â­ Helper: Format Date Thai
 */
function formatDateThai(dateString) {
  if (!dateString) return '';
  
  const months = [
    'à¸¡à¸à¸£à¸²à¸„à¸¡', 'à¸à¸¸à¸¡à¸ à¸²à¸à¸±à¸™à¸˜à¹Œ', 'à¸¡à¸µà¸™à¸²à¸„à¸¡', 'à¹€à¸¡à¸©à¸²à¸¢à¸™', 'à¸à¸¤à¸©à¸ à¸²à¸„à¸¡', 'à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™',
    'à¸à¸£à¸à¸à¸²à¸„à¸¡', 'à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡', 'à¸à¸±à¸™à¸¢à¸²à¸¢à¸™', 'à¸•à¸¸à¸¥à¸²à¸„à¸¡', 'à¸à¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™', 'à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡'
  ];
  
  const date = new Date(dateString + 'T00:00:00');
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear() + 543;
  
  return day + ' ' + month + ' ' + year;
}

/**
 * â­ Test Function
 */
function testCalendarService() {
  const testData = {
    apiKey: API_KEY,
    action: 'createSurveyWorkEvent',
    data: {
      requestDate: '2025-10-25',
      startTime: '14:00',
      endTime: '15:00',
      description: 'Test Survey Work',
      location: 'Test Location',
      requesterName: 'Test User',
      requesterEmail: 'test@example.com',
      assignedTeam: 'Survey Team A',
      surveyNo: 'SW-TEST-001',
      teamEmails: ['team1@example.com', 'team2@example.com']
    }
  };
  
  const mockRequest = {
    postData: {
      type: 'application/json',
      contents: JSON.stringify(testData)
    }
  };
  
  const result = doPost(mockRequest);
  Logger.log('Test Result:', result.getContent());
}


// ===== CalendarService.gs =====

/**
 * â­ à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² API Key à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸ (à¸£à¸±à¸™à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§) - SAFE VERSION
 */
function setupApiKey() {
  const apiKey = 'sk_live_' + Utilities.getUuid();
  
  const scriptProperties = PropertiesService.getScriptProperties();
  scriptProperties.setProperty('API_KEY', apiKey);
  
  Logger.log('');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('âœ… API Key Created Successfully!');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('');
  Logger.log('ğŸ“‹ API Key (copy this):');
  Logger.log('');
  Logger.log('    ' + apiKey);
  Logger.log('');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('âš ï¸  IMPORTANT: Save this key! You cannot retrieve it again.');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('');
  
  return apiKey;
}

/**
 * â­ à¸”à¸¶à¸‡ API Key à¸ˆà¸²à¸ Properties
 */
function getApiKey() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const apiKey = scriptProperties.getProperty('API_KEY');
  
  if (!apiKey) {
    throw new Error('API Key not configured. Run setupApiKey() first.');
  }
  
  return apiKey;
}

/**
 * â­ à¸­à¸±à¸›à¹€à¸”à¸• doPost() à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ getApiKey()
 */
function doPost(e) {
  try {
    Logger.log('========== Calendar Service Received Request ==========');
    
    // 1. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Content-Type
    const contentType = e.postData.type;
    if (contentType !== 'application/json') {
      return createResponse(false, 'Invalid content type');
    }
    
    // 2. Parse JSON
    const requestData = JSON.parse(e.postData.contents);
    Logger.log('Request data:', JSON.stringify(requestData));
    
    // 3. â­ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š API Key (à¹ƒà¸Šà¹‰ getApiKey())
    const validApiKey = getApiKey();
    
    if (!requestData.apiKey || requestData.apiKey !== validApiKey) {
      Logger.log('âŒ Invalid API Key');
      return createResponse(false, 'Unauthorized - Invalid API Key');
    }
    
    // 4. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Action
    if (requestData.action !== 'createSurveyWorkEvent') {
      return createResponse(false, 'Invalid action');
    }
    
    // 5. à¸ªà¸£à¹‰à¸²à¸‡ Calendar Event
    const result = createCalendarEvent(requestData.data);
    
    Logger.log('Result:', JSON.stringify(result));
    return createResponse(result.success, result.message, result.data);
    
  } catch (error) {
    Logger.log('âŒ Error in doPost:', error.toString());
    return createResponse(false, 'Server error: ' + error.toString());
  }
}

/**
 * â­ à¸”à¸¹ API Key à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (à¸ªà¸³à¸«à¸£à¸±à¸š Admin à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™)
 */
function viewApiKey() {
  try {
    const apiKey = getApiKey();
    
    Logger.log('Current API Key:', apiKey);
    
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      'Current API Key',
      apiKey,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    Logger.log('Error:', error);
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}

/**
 * â­ à¸ªà¸£à¹‰à¸²à¸‡ API Key à¹ƒà¸«à¸¡à¹ˆ (à¸£à¸°à¸§à¸±à¸‡! à¸ˆà¸°à¸—à¸³à¹ƒà¸«à¹‰ API Key à¹€à¸à¹ˆà¸²à¹ƒà¸Šà¹‰à¹„à¸¡à¹ˆà¹„à¸”à¹‰)
 */
function regenerateApiKey() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'Regenerate API Key?',
    'This will invalidate the old API Key!\n\n' +
    'You need to update Project A with the new key.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );
  
  if (response === ui.Button.YES) {
    return setupApiKey();
  } else {
    ui.alert('Cancelled');
  }
}

function logRequest(requestData, result) {
  try {
    const logSheet = getOrCreateLogSheet();
    
    const logRow = [
      new Date(),                                   // Timestamp
      requestData.data.surveyNo || '',              // Survey NO
      requestData.data.requesterEmail || '',        // Requester
      requestData.data.requestDate || '',           // Date
      requestData.data.startTime || '',             // Start Time
      requestData.data.endTime || '',               // End Time
      requestData.data.assignedTeam || '',          // Team
      result.success ? 'SUCCESS' : 'FAILED',        // Status
      result.message || '',                         // Message
      result.data && result.data.eventId ? result.data.eventId : '',  // Event ID
      requestData.data.teamEmails ? requestData.data.teamEmails.length : 0  // Guest Count
    ];
    
    logSheet.appendRow(logRow);
    
    Logger.log('ğŸ“ Request logged');
    
  } catch (error) {
    Logger.log('âš ï¸ Error logging request:', error);
    // à¹„à¸¡à¹ˆ throw error à¹€à¸à¸£à¸²à¸°à¹„à¸¡à¹ˆà¸­à¸¢à¸²à¸à¹ƒà¸«à¹‰ logging à¸—à¸³à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸šà¸¥à¹‰à¸¡
  }
}

/**
 * â­ à¸ªà¸£à¹‰à¸²à¸‡/à¸”à¸¶à¸‡ Log Sheet
 */
function getOrCreateLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName('Calendar_Service_Logs');
  
  if (!sheet) {
    sheet = ss.insertSheet('Calendar_Service_Logs');
    
    // Headers
    const headers = [
      'Timestamp', 'Survey NO', 'Requester', 'Date', 
      'Start Time', 'End Time', 'Team', 'Status', 
      'Message', 'Event ID', 'Guests'
    ];
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // Format Headers
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#16a34a');
    headerRange.setFontColor('#ffffff');
    headerRange.setHorizontalAlignment('center');
    
    // Set Column Widths
    sheet.setColumnWidth(1, 150);  // Timestamp
    sheet.setColumnWidth(2, 120);  // Survey NO
    sheet.setColumnWidth(3, 200);  // Requester
    sheet.setColumnWidth(4, 100);  // Date
    sheet.setColumnWidth(8, 100);  // Status
    sheet.setColumnWidth(10, 250); // Event ID
    
    sheet.setFrozenRows(1);
    
    Logger.log('âœ… Created Calendar_Service_Logs sheet');
  }
  
  return sheet;
}

/**
 * â­ à¸­à¸±à¸›à¹€à¸”à¸• doPost() à¹ƒà¸«à¹‰à¸¡à¸µ Logging
 */
function doPost(e) {
  let requestData = null;
  
  try {
    Logger.log('========== Calendar Service Received Request ==========');
    
    // 1. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Content-Type
    const contentType = e.postData.type;
    if (contentType !== 'application/json') {
      return createResponse(false, 'Invalid content type');
    }
    
    // 2. Parse JSON
    requestData = JSON.parse(e.postData.contents);
    Logger.log('Request data:', JSON.stringify(requestData));
    
    // 3. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š API Key
    const validApiKey = getApiKey();
    
    if (!requestData.apiKey || requestData.apiKey !== validApiKey) {
      Logger.log('âŒ Invalid API Key');
      
      // â­ Log unauthorized attempts
      if (requestData.data) {
        logRequest(requestData, {
          success: false,
          message: 'Unauthorized - Invalid API Key'
        });
      }
      
      return createResponse(false, 'Unauthorized - Invalid API Key');
    }
    
    // 4. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Action
    if (requestData.action !== 'createSurveyWorkEvent') {
      return createResponse(false, 'Invalid action');
    }
    
    // 5. à¸ªà¸£à¹‰à¸²à¸‡ Calendar Event
    const result = createCalendarEvent(requestData.data);
    
    // â­ 6. Log Request
    logRequest(requestData, result);
    
    Logger.log('Result:', JSON.stringify(result));
    return createResponse(result.success, result.message, result.data);
    
  } catch (error) {
    Logger.log('âŒ Error in doPost:', error.toString());
    
    // â­ Log errors
    if (requestData && requestData.data) {
      logRequest(requestData, {
        success: false,
        message: 'Server error: ' + error.toString()
      });
    }
    
    return createResponse(false, 'Server error: ' + error.toString());
  }
}

/**
 * â­ à¸”à¸¹ Log Stats
 */
function setupLogSpreadsheet() {
  const spreadsheetId = '1kco0Kb7E_2TyFjuYg4Bb8JUW98GkSbOD-VnwvQBzjoM';
  
  try {
    // à¸—à¸”à¸ªà¸­à¸šà¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡ Spreadsheet
    const ss = SpreadsheetApp.openById(spreadsheetId);
    Logger.log('âœ… Spreadsheet accessible:', ss.getName());
    
    // à¸šà¸±à¸™à¸—à¸¶à¸ ID
    const scriptProperties = PropertiesService.getScriptProperties();
    scriptProperties.setProperty('LOG_SPREADSHEET_ID', spreadsheetId);
    
    Logger.log('âœ… Spreadsheet ID saved');
    Logger.log('');
    Logger.log('Setup complete!');
    Logger.log('Spreadsheet:', ss.getName());
    Logger.log('URL:', ss.getUrl());
    
    return true;
    
  } catch (error) {
    Logger.log('âŒ Error:', error);
    Logger.log('');
    Logger.log('Make sure:');
    Logger.log('1. Spreadsheet ID is correct');
    Logger.log('2. You have edit permission');
    
    return false;
  }
}

/**
 * â­ à¸”à¸¶à¸‡ Spreadsheet à¸ˆà¸²à¸ Properties
 */
function getLogSpreadsheet() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const spreadsheetId = scriptProperties.getProperty('LOG_SPREADSHEET_ID');
  
  if (!spreadsheetId) {
    throw new Error('Log Spreadsheet not configured. Run setupLogSpreadsheet() first.');
  }
  
  return SpreadsheetApp.openById(spreadsheetId);
}

/**
 * â­ à¸ªà¸£à¹‰à¸²à¸‡/à¸”à¸¶à¸‡ Log Sheet
 */
function getOrCreateLogSheet() {
  const ss = getLogSpreadsheet();
  let sheet = ss.getSheetByName('Calendar_Service_Logs');
  
  if (!sheet) {
    sheet = ss.insertSheet('Calendar_Service_Logs');
    
    // Headers
    const headers = [
      'Timestamp', 'Survey NO', 'Requester', 'Date', 
      'Start Time', 'End Time', 'Team', 'Status', 
      'Message', 'Event ID', 'Guests'
    ];
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // Format Headers
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#16a34a');
    headerRange.setFontColor('#ffffff');
    headerRange.setHorizontalAlignment('center');
    
    // Set Column Widths
    sheet.setColumnWidth(1, 150);  // Timestamp
    sheet.setColumnWidth(2, 120);  // Survey NO
    sheet.setColumnWidth(3, 200);  // Requester
    sheet.setColumnWidth(4, 100);  // Date
    sheet.setColumnWidth(5, 90);   // Start Time
    sheet.setColumnWidth(6, 90);   // End Time
    sheet.setColumnWidth(7, 150);  // Team
    sheet.setColumnWidth(8, 100);  // Status
    sheet.setColumnWidth(9, 250);  // Message
    sheet.setColumnWidth(10, 250); // Event ID
    sheet.setColumnWidth(11, 70);  // Guests
    
    sheet.setFrozenRows(1);
    
    Logger.log('âœ… Created Calendar_Service_Logs sheet');
  }
  
  return sheet;
}

/**
 * â­ à¸”à¸¹ Log Stats (à¸­à¸±à¸›à¹€à¸”à¸•)
 */
function viewLogStats() {
  try {
    const ss = getLogSpreadsheet();
    const sheet = ss.getSheetByName('Calendar_Service_Logs');
    
    if (!sheet) {
      Logger.log('â„¹ï¸ No logs yet - creating sheet...');
      getOrCreateLogSheet();
      
      Logger.log('âœ… Log sheet created!');
      Logger.log('No log entries yet.');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    
    if (lastRow <= 1) {
      Logger.log('â„¹ï¸ No log entries yet.');
      return;
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 11).getValues();
    
    let successCount = 0;
    let failCount = 0;
    
    data.forEach(function(row) {
      if (row[7] === 'SUCCESS') {
        successCount++;
      } else {
        failCount++;
      }
    });
    
    const total = successCount + failCount;
    const successRate = total > 0 ? ((successCount / total) * 100).toFixed(1) : '0.0';
    
    Logger.log('');
    Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    Logger.log('     Calendar Service Stats');
    Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    Logger.log('Total Requests:', total);
    Logger.log('Success:', successCount);
    Logger.log('Failed:', failCount);
    Logger.log('Success Rate:', successRate + '%');
    Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    Logger.log('');
    Logger.log('ğŸ“Š View full logs:');
    Logger.log(ss.getUrl());
    
  } catch (error) {
    Logger.log('âŒ Error:', error.toString());
    
    if (error.message.includes('not configured')) {
      Logger.log('');
      Logger.log('ğŸ’¡ Run setupLogSpreadsheet() first');
    }
  }
}
