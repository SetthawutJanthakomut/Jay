//Version 12 18/10/2025 8:30
// ===== Survey Work Functions =====
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Code.gs
/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï doGet() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤ Survey Work
 */

function doGet(e) {
  const page = e.parameter.page;
  
  if (page === 'qc') {
    return HtmlService.createHtmlOutputFromFile('qc')
      .setTitle('QC RFI System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'qc_edit') {
    return HtmlService.createHtmlOutputFromFile('qc_edit')
      .setTitle('QC - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'qc_postpone') {
    return HtmlService.createHtmlOutputFromFile('qc_postpone')
      .setTitle('QC - ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'survey') {
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Survey Work
    return HtmlService.createHtmlOutputFromFile('survey')
      .setTitle('Survey Work Requirement System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else {
    return HtmlService.createHtmlOutputFromFile('index')
      .setTitle('RFI Requirement System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }
}




// ===== Global Variables for Load Balancing =====
/**
 * ‚≠ê Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö workload ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
 */
var WORKLOAD_CACHE = {};

/**
 * ‚≠ê Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö last selected team (Round Robin)
 */
var LAST_SELECTED_TEAM = {};

/**
 * ‚≠ê Reset cache (‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
 */
function resetWorkloadCache() {
  WORKLOAD_CACHE = {};
  LAST_SELECTED_TEAM = {};
  console.log('‚úÖ Workload cache reset');
}

/**
 * ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° workload ‡πÉ‡∏ô cache
 */
function incrementWorkloadCache(resourceId, date) {
  const key = resourceId + '_' + date;
  if (!WORKLOAD_CACHE[key]) {
    WORKLOAD_CACHE[key] = 0;
  }
  WORKLOAD_CACHE[key]++;
  console.log('üìä Cache updated:', resourceId, 'on', date, '‚Üí', WORKLOAD_CACHE[key], 'tasks');
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á workload ‡∏à‡∏≤‡∏Å cache
 */
function getWorkloadFromCache(resourceId, date) {
  const key = resourceId + '_' + date;
  return WORKLOAD_CACHE[key] || 0;
}

function doGet(e) {
  const page = e.parameter.page;
  
  if (page === 'qc') {
    return HtmlService.createHtmlOutputFromFile('qc')
      .setTitle('QC RFI System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'qc_edit') {
    return HtmlService.createHtmlOutputFromFile('qc_edit')
      .setTitle('QC - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'qc_postpone') {
    return HtmlService.createHtmlOutputFromFile('qc_postpone')
      .setTitle('QC - ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else if (page === 'survey') {
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Survey Work
    return HtmlService.createHtmlOutputFromFile('survey')
      .setTitle('Survey Work Requirement System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else {
    return HtmlService.createHtmlOutputFromFile('index')
      .setTitle('RFI Requirement System')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }
}

/**
 * ‚úÖ UPDATED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π Test Logging
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  ui.createMenu('üîß RFI System')
    .addItem('üìã ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô', 'viewResourcesInfo')
    .addItem('‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet Resources (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)', 'createResourcesSheet')
    .addSeparator()
    .addItem('üìä ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á RFI (User)', 'openRFIForm')
    .addItem('üó∫Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á Survey Work', 'openSurveyWorkForm')
    .addItem('üìù ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á RFI (QC)', 'openQCRFIForm')
    .addSeparator()
    .addSubMenu(ui.createMenu('üìä Dashboard & Analytics')
      .addItem('üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á Dashboard', 'createPerformanceDashboard')
      .addItem('üìà ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'viewUsageStats')
      .addItem('üîÑ Refresh Dashboard', 'createPerformanceDashboard'))
    .addSubMenu(ui.createMenu('üìù Logging & Errors')
      .addItem('üìä ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Logging', 'viewLoggingStatus')
      .addSeparator()
      .addItem('üìù ‡∏î‡∏π Performance Logs', 'viewPerformanceLogs')
      .addItem('üêõ ‡∏î‡∏π Error Logs', 'viewErrorLogs')
      .addItem('üë• ‡∏î‡∏π Team Assignment Logs', 'viewTeamLogs')
      .addSeparator()
      .addItem('‚öôÔ∏è ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Logging', 'viewLoggingSettings')
      .addItem('üîÑ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Logging', 'toggleLogging')
      .addItem('üêõ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Error Tracking', 'toggleErrorTracking')
      .addItem('‚ö° ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Performance Tracking', 'togglePerformanceTracking')
      .addItem('üêå ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Slow Query Threshold', 'setSlowQueryThreshold')
      .addSeparator()
      .addItem('üîÑ Reset ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'resetLoggingConfig')
      .addItem('üßπ ‡∏•‡πâ‡∏≤‡∏á Logs ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'clearAllLogs'))
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π Test Logging
    .addSubMenu(ui.createMenu('üß™ Test Logging System')
      .addItem('‚ñ∂Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Comprehensive)', 'runComprehensiveLoggingTest')
      .addSeparator()
      .addItem('üìù Test Performance Logging', 'testPerformanceLogging')
      .addItem('üêõ Test Error Logging', 'testErrorLogging')
      .addItem('üë• Test Team Assignment Logging', 'testTeamAssignmentLogging')
      .addItem('‚öôÔ∏è Test Config Management', 'testConfigManagement')
      .addItem('üßπ Test Cleanup System', 'testLogCleanup')
      .addItem('üêå Test Slow Query Detection', 'testSlowQueryDetection')
      .addSeparator()
      .addItem('üìß Test Admin Email (‡∏à‡∏∞‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á!)', 'testAdminEmailNotification')
      .addItem('‚ùå Test Logging ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î', 'testLoggingWhenDisabled')
      .addSeparator()
      .addItem('üìä ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Logging System', 'viewLoggingStatus'))
    .addSubMenu(ui.createMenu('üìä Column AN Management')
      .addItem('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Column AN', 'testColumnAN')
      .addItem('üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤', 'updateOldRecordsColumnAN')
      .addItem('üìà ‡∏™‡∏£‡πâ‡∏≤‡∏á Report ‡∏ï‡∏≤‡∏° Column AN', 'createColumnANReport'))
    .addSeparator()
    .addSubMenu(ui.createMenu('üß™ Test RFI System')
      .addItem('‚ñ∂Ô∏è ‡∏£‡∏±‡∏ô Test ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'runAllTests')
      .addItem('‚ö° Test Optimized Functions', 'testOptimizedFunctions')
      .addSeparator()
      .addItem('1Ô∏è‚É£ Test ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', 'testSingleTeamBooking')
      .addItem('2Ô∏è‚É£ Test ‡∏à‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏°', 'testMultipleTeamBooking')
      .addItem('3Ô∏è‚É£ Test ‡∏ó‡∏µ‡∏°‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á', 'testNoAvailableTeam')
      .addItem('4Ô∏è‚É£ Test ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô', 'testOverlappingTime')
      .addItem('5Ô∏è‚É£ Test ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'testAutoTeamAssignment')
      .addItem('6Ô∏è‚É£ Test Available Time Slots', 'testAvailableTimeSlots')
      .addSeparator()
      .addItem('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Test', 'clearTestData'))
    .addToUi();
}


/**
 * ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á Report ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Column AN
 */
function createColumnANReport() {
  try {
    console.log('========== Creating Column AN Report ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö RFI_List sheet');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      SpreadsheetApp.getUi().alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: Column A (ID), O (Status), AN (Type)
    const idData = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    const statusData = sheet.getRange(2, 15, lastRow - 1, 1).getValues();
    const typeData = sheet.getRange(2, 40, lastRow - 1, 1).getValues();
    
    // ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let rfiWorkCount = 0;
    let surveyWorkCount = 0;
    let emptyCount = 0;
    
    const rfiStatusCount = {};
    const surveyStatusCount = {};
    
    for (let i = 0; i < idData.length; i++) {
      const status = String(statusData[i][0] || '').trim();
      const type = String(typeData[i][0] || '').trim();
      
      if (type === 'RFI Work') {
        rfiWorkCount++;
        rfiStatusCount[status] = (rfiStatusCount[status] || 0) + 1;
      } else if (type === 'Survey Work') {
        surveyWorkCount++;
        surveyStatusCount[status] = (surveyStatusCount[status] || 0) + 1;
      } else {
        emptyCount++;
      }
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Report Sheet
    let reportSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Column_AN_Report');
    
    if (reportSheet) {
      SpreadsheetApp.getActiveSpreadsheet().deleteSheet(reportSheet);
    }
    
    reportSheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet('Column_AN_Report');
    
    // Header
    reportSheet.getRange(1, 1).setValue('üìä Column AN Report');
    reportSheet.getRange(1, 1).setFontSize(16).setFontWeight('bold');
    
    reportSheet.getRange(2, 1).setValue('Generated: ' + new Date().toLocaleString('th-TH'));
    reportSheet.getRange(2, 1).setFontSize(10).setFontColor('#666666');
    
    // Summary
    let row = 4;
    reportSheet.getRange(row, 1).setValue('üìã Summary').setFontWeight('bold').setFontSize(14);
    row++;
    
    reportSheet.getRange(row, 1).setValue('Total Records:');
    reportSheet.getRange(row, 2).setValue(lastRow - 1);
    row++;
    
    reportSheet.getRange(row, 1).setValue('üìã RFI Work:');
    reportSheet.getRange(row, 2).setValue(rfiWorkCount);
    reportSheet.getRange(row, 1, 1, 2).setBackground('#dbeafe');
    row++;
    
    reportSheet.getRange(row, 1).setValue('üó∫Ô∏è Survey Work:');
    reportSheet.getRange(row, 2).setValue(surveyWorkCount);
    reportSheet.getRange(row, 1, 1, 2).setBackground('#d1fae5');
    row++;
    
    if (emptyCount > 0) {
      reportSheet.getRange(row, 1).setValue('‚ö†Ô∏è Empty/Other:');
      reportSheet.getRange(row, 2).setValue(emptyCount);
      reportSheet.getRange(row, 1, 1, 2).setBackground('#fef3c7');
      row++;
    }
    
    // RFI Work by Status
    row += 2;
    reportSheet.getRange(row, 1).setValue('üìã RFI Work by Status').setFontWeight('bold').setFontSize(14);
    row++;
    
    reportSheet.getRange(row, 1).setValue('Status');
    reportSheet.getRange(row, 2).setValue('Count');
    reportSheet.getRange(row, 1, 1, 2).setFontWeight('bold').setBackground('#1877f2').setFontColor('white');
    row++;
    
    Object.keys(rfiStatusCount).sort().forEach(function(status) {
      reportSheet.getRange(row, 1).setValue(status);
      reportSheet.getRange(row, 2).setValue(rfiStatusCount[status]);
      row++;
    });
    
    // Survey Work by Status
    row += 2;
    reportSheet.getRange(row, 1).setValue('üó∫Ô∏è Survey Work by Status').setFontWeight('bold').setFontSize(14);
    row++;
    
    reportSheet.getRange(row, 1).setValue('Status');
    reportSheet.getRange(row, 2).setValue('Count');
    reportSheet.getRange(row, 1, 1, 2).setFontWeight('bold').setBackground('#16a34a').setFontColor('white');
    row++;
    
    Object.keys(surveyStatusCount).sort().forEach(function(status) {
      reportSheet.getRange(row, 1).setValue(status);
      reportSheet.getRange(row, 2).setValue(surveyStatusCount[status]);
      row++;
    });
    
    // Format columns
    reportSheet.setColumnWidth(1, 250);
    reportSheet.setColumnWidth(2, 100);
    
    // Auto-fit
    reportSheet.autoResizeColumn(1);
    reportSheet.autoResizeColumn(2);
    
    console.log('‚úÖ Report created successfully');
    
    SpreadsheetApp.getUi().alert(
      '‡∏™‡∏£‡πâ‡∏≤‡∏á Report ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
      '‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet "Column_AN_Report" ‡πÅ‡∏•‡πâ‡∏ß\n\n' +
      '‡∏™‡∏£‡∏∏‡∏õ:\n' +
      'üìã RFI Work: ' + rfiWorkCount + ' records\n' +
      'üó∫Ô∏è Survey Work: ' + surveyWorkCount + ' records\n' +
      (emptyCount > 0 ? '‚ö†Ô∏è Empty: ' + emptyCount + ' records\n' : '') +
      '\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡∏ó‡∏µ‡πà Sheet "Column_AN_Report"',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Report Sheet
    SpreadsheetApp.setActiveSheet(reportSheet);
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Report ‡πÑ‡∏î‡πâ\n\n' +
      'Error: ' + error.toString(),
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}


/**
 * ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á RFI ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
 */
function openRFIForm() {
  const html = HtmlService.createHtmlOutputFromFile('index')
    .setWidth(600)
    .setHeight(800);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'RFI Requirement System');
}

// ===== Utility Functions =====
function formatDate(date) {
  if (!date) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
}

function formatTime(timeValue) {
  if (!timeValue) return '';
  
  if (typeof timeValue === 'string') {
    return timeValue;
  }
  
  if (timeValue instanceof Date) {
    const hours = String(timeValue.getHours()).padStart(2, '0');
    const minutes = String(timeValue.getMinutes()).padStart(2, '0');
    return hours + ':' + minutes;
  }
  
  if (typeof timeValue === 'number') {
    const totalMinutes = Math.round(timeValue * 24 * 60);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
  }
  
  return timeValue.toString();
}

function formatDateThai(dateString) {
  if (!dateString) return '';
  
  const months = [
    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
  ];
  
  const date = new Date(dateString + 'T00:00:00');
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear() + 543;
  
  return day + ' ' + month + ' ' + year;
}

function timeToMinutes(timeString) {
  if (!timeString) return 0;
  const parts = timeString.split(':');
  return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

// ===== Work Type Functions =====
function getWorkTypeList() {
  try {
    const workSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Work');
    
    if (!workSheet) {
      console.log('Work sheet not found');
      return [];
    }
    
    const lastRow = workSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No work types found');
      return [];
    }
    
    const data = workSheet.getRange(2, 2, lastRow - 1, 1).getValues();
    const workTypes = [];
    
    for (let i = 0; i < data.length; i++) {
      const workType = String(data[i][0] || '').trim();
      if (workType) {
        workTypes.push(workType);
      }
    }
    
    console.log('Found work types:', workTypes.length);
    return workTypes;
    
  } catch (error) {
    console.error('Error getting work type list:', error);
    return [];
  }
}

// ===== Team/Resource Management Functions =====
function getTeamsByCategory(category) {
  try {
    console.log('Getting teams for category:', category);
    
    const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!resourceSheet) {
      console.log('Resources sheet not found');
      return [];
    }
    
    const lastRow = resourceSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No resources found');
      return [];
    }
    
    // ‡πÅ‡∏¢‡∏Å categories ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î (comma separated)
    // ‡πÄ‡∏ä‡πà‡∏ô "Survey,Inspector" ‚Üí ["Survey", "Inspector"]
    const categories = category.split(',').map(function(c) {
      return c.trim().toLowerCase();
    });
    
    console.log('Categories to search (lowercase):', categories);
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: A (Resource_ID), B (Resource_Name), C (Sub_Type), D (Team No.), E (Status)
    const data = resourceSheet.getRange(2, 1, lastRow - 1, 5).getValues();
    const teams = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const resourceId = String(row[0] || '').trim();
      const resourceName = String(row[1] || '').trim();
      const subType = String(row[2] || '').trim();
      const teamNo = row[3];
      const status = String(row[4] || '').trim();
      
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Status = Activated ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö
      if (status === 'Activated' && resourceId && subType) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ subType ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô categories ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        // ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Survey,Inspector" ‡∏à‡∏∞‡∏´‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ Sub_Type = "Survey" ‡∏´‡∏£‡∏∑‡∏≠ "Inspector"
        const subTypeLower = subType.toLowerCase();
        
        if (categories.indexOf(subTypeLower) !== -1) {
          teams.push({
            resourceId: resourceId,
            resourceName: resourceName,
            subType: subType,
            teamNo: teamNo || 999
          });
          console.log('Found team:', resourceId, resourceName, subType, 'Team No:', teamNo);
        }
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Team No. ‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å
    teams.sort(function(a, b) {
      return a.teamNo - b.teamNo;
    });
    
    console.log('Total teams found:', teams.length);
    console.log('Teams sorted by Team No:', teams.map(function(t) { 
      return t.resourceName + ' (No.' + t.teamNo + ')'; 
    }).join(', '));
    
    return teams;
    
  } catch (error) {
    console.error('Error getting teams:', error);
    return [];
  }
}

/**
 * ‚ú® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Status ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 * (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á RFI ‡πÅ‡∏•‡∏∞ Survey Work)
 */
function isStatusInactive(status) {
  if (!status) return false;
  
  const statusLower = status.toLowerCase();
  
  // ‚úÖ Status ‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ)
  const inactiveStatuses = [
    'cancel',           // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (EN)
    'cancelled',        // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (EN - ‡∏™‡∏∞‡∏Å‡∏î‡∏ï‡πà‡∏≤‡∏á)
    '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',           // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (TH)
    'completed',        // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',         // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (TH)
    'closed',           // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',           // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (TH)
    'rejected',         // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
    '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',           // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (TH)
    'archived',         // ‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£
    'void',             // ‡πÇ‡∏°‡∏Ü‡∏∞
    'deleted'           // ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  ];
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ status ‡∏°‡∏µ‡∏Ñ‡∏≥‡πÉ‡∏î‡∏Ñ‡∏≥‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  return inactiveStatuses.some(function(inactive) {
    return statusLower.includes(inactive);
  });
}

/**
 * ‚ú® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (RFI System - ‡∏°‡∏µ buffer ¬±30 ‡∏ô‡∏≤‡∏ó‡∏µ)
 * (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°)
 */
function isTeamAvailable(resourceId, date, startTime, endTime, excludeRfiId) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return true;
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return true;
    
    const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
    
    const requestStartMinutes = timeToMinutes(startTime);
    const requestEndMinutes = timeToMinutes(endTime);
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rfiId = String(row[0] || '').trim();              // Column A - ID
      const rfiDate = formatDate(new Date(row[4]));           // Column E - Request_Date
      const rfiStartTime = formatTime(row[5]);                // Column F - Start_Time
      const rfiEndTime = formatTime(row[6]);                  // Column G - End_Time
      const assignedTeams = String(row[11] || '').trim();     // Column L - Assigned_Inspector
      const status = String(row[14] || '').trim();            // Column O - Status
      
      // ‚≠ê ‡∏Ç‡πâ‡∏≤‡∏° RFI ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      if (excludeRfiId && rfiId === excludeRfiId) {
        console.log('Skipping RFI being edited:', rfiId);
        continue;
      }
      
      // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏° Status ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß
      if (isStatusInactive(status)) {
        console.log('Skipping inactive status:', status, '(RFI:', rfiId + ')');
        continue;
      }
      
      if (rfiDate === date) {
        const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
        if (!resourceSheet) continue;
        
        const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
        
        const nameToId = {};
        for (let j = 0; j < resourceData.length; j++) {
          const rid = String(resourceData[j][0] || '').trim();
          const rname = String(resourceData[j][1] || '').trim();
          if (rid && rname) {
            nameToId[rname] = rid;
          }
        }
        
        const teamNamesList = assignedTeams.split(',').map(function(name) {
          return name.trim();
        });
        
        let isThisTeamAssigned = false;
        for (let k = 0; k < teamNamesList.length; k++) {
          const teamName = teamNamesList[k];
          if (nameToId[teamName] === resourceId) {
            isThisTeamAssigned = true;
            break;
          }
        }
        
        if (!isThisTeamAssigned) {
          continue;
        }
        
        const existingStartMinutes = timeToMinutes(rfiStartTime);
        const existingEndMinutes = timeToMinutes(rfiEndTime);
        
        // Buffer ¬±30 ‡∏ô‡∏≤‡∏ó‡∏µ (25 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î)
        const bufferedExistingStart = existingStartMinutes - 25;
        const bufferedExistingEnd = existingEndMinutes + 25;
        
        const isAvailable = (requestEndMinutes < bufferedExistingStart) || 
                           (requestStartMinutes > bufferedExistingEnd);
        
        if (!isAvailable) {
          console.log('Team ' + resourceId + ' is NOT available (RFI: ' + rfiId + ', Status: ' + status + ')');
          return false;
        }
      }
    }
    
    return true;
    
  } catch (error) {
    console.error('Error checking team availability:', error);
    return false;
  }
}

/**
 * ‚ú® ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏° Survey ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Survey Work - ‡πÑ‡∏°‡πà‡∏°‡∏µ buffer)
 * (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°)
 */
function isSurveyTeamAvailable(resourceId, date, startTime, endTime) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return true;
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return true;
    
    const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
    
    const requestStartMinutes = timeToMinutes(startTime);
    const requestEndMinutes = timeToMinutes(endTime);
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rfiId = String(row[0] || '').trim();              // Column A - ID
      const rfiDate = formatDate(new Date(row[4]));           // Column E - Request_Date
      const rfiStartTime = formatTime(row[5]);                // Column F - Start_Time
      const rfiEndTime = formatTime(row[6]);                  // Column G - End_Time
      const assignedTeams = String(row[11] || '').trim();     // Column L - Assigned_Inspector
      const status = String(row[14] || '').trim();            // Column O - Status
      
      // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏° Status ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß
      if (isStatusInactive(status)) {
        console.log('Skipping inactive status:', status, '(RFI:', rfiId + ')');
        continue;
      }
      
      if (rfiDate === date) {
        const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
        if (!resourceSheet) continue;
        
        const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
        
        const nameToId = {};
        for (let j = 0; j < resourceData.length; j++) {
          const rid = String(resourceData[j][0] || '').trim();
          const rname = String(resourceData[j][1] || '').trim();
          if (rid && rname) {
            nameToId[rname] = rid;
          }
        }
        
        const teamNamesList = assignedTeams.split(',').map(function(name) {
          return name.trim();
        });
        
        let isThisTeamAssigned = false;
        for (let k = 0; k < teamNamesList.length; k++) {
          const teamName = teamNamesList[k];
          if (nameToId[teamName] === resourceId) {
            isThisTeamAssigned = true;
            break;
          }
        }
        
        if (!isThisTeamAssigned) {
          continue;
        }
        
        const existingStartMinutes = timeToMinutes(rfiStartTime);
        const existingEndMinutes = timeToMinutes(rfiEndTime);
        
        // ‚≠ê ‡πÑ‡∏°‡πà‡∏°‡∏µ buffer - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
        const isAvailable = (requestEndMinutes <= existingStartMinutes) || 
                           (requestStartMinutes >= existingEndMinutes);
        
        if (!isAvailable) {
          console.log('Survey Team ' + resourceId + ' is NOT available (RFI: ' + rfiId + ', Status: ' + status + ')');
          return false;
        }
      }
    }
    
    return true;
    
  } catch (error) {
    console.error('Error checking Survey team availability:', error);
    return false;
  }
}
function testViewAllStatuses() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö RFI_List sheet');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      return;
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
    const statusCount = {};
    const statusExamples = {};
    
    for (let i = 0; i < data.length; i++) {
      const rfiId = String(data[i][0] || '').trim();
      const status = String(data[i][14] || '').trim();
      
      if (status) {
        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
        statusCount[status] = (statusCount[status] || 0) + 1;
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á RFI ID
        if (!statusExamples[status]) {
          statusExamples[status] = [];
        }
        if (statusExamples[status].length < 3) {
          statusExamples[status].push(rfiId);
        }
      }
    }
    
    console.log('========== Status Summary ==========');
    console.log('Total RFI Records:', lastRow - 1);
    console.log('');
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    const sortedStatuses = Object.keys(statusCount).sort(function(a, b) {
      return statusCount[b] - statusCount[a];
    });
    
    sortedStatuses.forEach(function(status) {
      const isInactive = isStatusInactive(status);
      const icon = isInactive ? '‚úÖ (IGNORED)' : 'üî¥ (BLOCKS TEAM)';
      
      console.log(icon + ' ' + status + ': ' + statusCount[status] + ' records');
      console.log('   Examples: ' + statusExamples[status].join(', '));
      console.log('');
    });
    
    console.log('====================================');
    
  } catch (error) {
    console.error('‚ùå Error:', error);
  }
}


function testSpecificStatus() {
  const testStatuses = [
    'Draft',
    'RFI Request Submitted',
    'Survey Work Request Submitted',
    'Cancelled',
    'Cancel',
    '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
    'Completed',
    '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
    'Closed',
    'Rejected',
    'In Progress',
    'Approved'
  ];
  
  console.log('========== Status Test ==========');
  testStatuses.forEach(function(status) {
    const isInactive = isStatusInactive(status);
    const result = isInactive ? '‚úÖ IGNORED (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á)' : 'üî¥ BLOCKS TEAM (‡∏ô‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á)';
    console.log(status + ': ' + result);
  });
  console.log('=================================');
}

/**
 * ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡∏°‡∏°‡∏µ (‡∏£‡∏ß‡∏° cache)
 */
function getTeamWorkload(resourceId, date, useCache) {
  try {
    if (typeof useCache === 'undefined') useCache = true;
    
    // 1. ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å Sheet
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    let sheetWorkload = 0;
    
    if (sheet) {
      const lastRow = sheet.getLastRow();
      
      if (lastRow > 1) {
        const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
        
        for (let i = 0; i < data.length; i++) {
          const row = data[i];
          const rfiDate = formatDate(new Date(row[4]));
          const assignedTeams = String(row[11] || '').trim();
          const status = String(row[14] || '').trim();
          
          if (isStatusInactive(status)) continue;
          
          if (rfiDate === date) {
            const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
            if (!resourceSheet) continue;
            
            const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
            
            const nameToId = {};
            for (let j = 0; j < resourceData.length; j++) {
              const rid = String(resourceData[j][0] || '').trim();
              const rname = String(resourceData[j][1] || '').trim();
              if (rid && rname) {
                nameToId[rname] = rid;
              }
            }
            
            const teamNamesList = assignedTeams.split(',').map(function(name) {
              return name.trim();
            });
            
            for (let k = 0; k < teamNamesList.length; k++) {
              const teamName = teamNamesList[k];
              if (nameToId[teamName] === resourceId) {
                sheetWorkload++;
                break;
              }
            }
          }
        }
      }
    }
    
    // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å cache (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
    const cacheWorkload = useCache ? getWorkloadFromCache(resourceId, date) : 0;
    const totalWorkload = sheetWorkload + cacheWorkload;
    
    return totalWorkload;
    
  } catch (error) {
    console.error('Error getting team workload:', error);
    return 0;
  }
}

/**
 * ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° Workload + Round Robin
 */
function sortTeamsByWorkload(teams, date, useCache) {
  try {
    if (typeof useCache === 'undefined') useCache = true;
    
    console.log('Sorting teams by workload for date:', date, '(Cache:', useCache ? 'ON' : 'OFF' + ')');
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì workload ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°
    const teamsWithWorkload = teams.map(function(team) {
      const workload = getTeamWorkload(team.resourceId, date, useCache);
      console.log('Team:', team.resourceName, 'Workload:', workload, 'Team No:', team.teamNo);
      
      return {
        resourceId: team.resourceId,
        resourceName: team.resourceName,
        subType: team.subType,
        teamNo: team.teamNo,
        workload: workload
      };
    });
    
    // ‡∏´‡∏≤ min workload
    let minWorkload = Infinity;
    teamsWithWorkload.forEach(function(t) {
      if (t.workload < minWorkload) {
        minWorkload = t.workload;
      }
    });
    
    // ‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ workload ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    const minWorkloadTeams = teamsWithWorkload.filter(function(t) {
      return t.workload === minWorkload;
    });
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà workload ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‚Üí ‡πÉ‡∏ä‡πâ Round Robin
    if (minWorkloadTeams.length > 1) {
      console.log('‚öñÔ∏è Found', minWorkloadTeams.length, 'teams with same workload (', minWorkload, ')');
      
      const categoryKey = teams[0].subType + '_' + date;
      const lastSelected = LAST_SELECTED_TEAM[categoryKey];
      
      console.log('Last selected:', lastSelected);
      
      // ‡∏´‡∏≤ index ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
      let startIndex = 0;
      if (lastSelected) {
        for (let i = 0; i < minWorkloadTeams.length; i++) {
          if (minWorkloadTeams[i].resourceId === lastSelected) {
            startIndex = (i + 1) % minWorkloadTeams.length; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            break;
          }
        }
      }
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      const rotated = minWorkloadTeams.slice(startIndex).concat(minWorkloadTeams.slice(0, startIndex));
      
      console.log('üîÑ Round Robin order:', rotated.map(function(t) {
        return t.resourceName;
      }).join(' ‚Üí '));
      
      // ‡∏ô‡∏≥‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà workload ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
      const higherWorkloadTeams = teamsWithWorkload.filter(function(t) {
        return t.workload > minWorkload;
      }).sort(function(a, b) {
        if (a.workload !== b.workload) return a.workload - b.workload;
        return a.teamNo - b.teamNo;
      });
      
      return rotated.concat(higherWorkloadTeams);
    }
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà workload ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ workload ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
    teamsWithWorkload.sort(function(a, b) {
      if (a.workload !== b.workload) {
        return a.workload - b.workload;
      }
      return a.teamNo - b.teamNo;
    });
    
    console.log('Teams sorted by workload:');
    teamsWithWorkload.forEach(function(t) {
      console.log('-', t.resourceName, '(Workload:', t.workload + ', Team No:', t.teamNo + ')');
    });
    
    return teamsWithWorkload;
    
  } catch (error) {
    console.error('Error sorting teams by workload:', error);
    return teams;
  }
}

/**
 * ‚úÖ FINAL: ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (RFI Work) - Load Balanced
 */
function assignTeamAutomatically(category, date, startTime, endTime, excludeRfiId, useCache) {
  try {
    // Set default values
    if (typeof excludeRfiId === 'undefined') excludeRfiId = null;
    if (typeof useCache === 'undefined') useCache = false;
    
    console.log('========== Auto-assigning team (Load Balanced) ==========');
    console.log('Category:', category);
    console.log('Date:', date);
    console.log('Time:', startTime, '-', endTime);
    console.log('Use Cache:', useCache);
    
    // ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô
    const categories = category.split(',').map(function(c) {
      return c.trim();
    });
    
    console.log('Categories:', categories);
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    if (categories.length === 1) {
      const teams = getTeamsByCategory(category);
      
      if (teams.length === 0) {
        const categoryDisplay = category.replace(/,/g, ', ');
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + categoryDisplay
        };
      }
      
      // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° workload
      const sortedTeams = sortTeamsByWorkload(teams, date, useCache);
      
      // ‡∏´‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
      for (let i = 0; i < sortedTeams.length; i++) {
        const team = sortedTeams[i];
        
        if (isTeamAvailable(team.resourceId, date, startTime, endTime, excludeRfiId)) {
          console.log('‚úÖ Selected team:', team.resourceName, '(Workload:', team.workload + ')');
          
          // ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï cache (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
          if (useCache) {
            incrementWorkloadCache(team.resourceId, date);
            LAST_SELECTED_TEAM[team.subType + '_' + date] = team.resourceId;
          }
          
          return {
            success: true,
            assignedTeams: [team.resourceName],
            teamNames: team.resourceName,
            resourceIds: team.resourceId,
            teamNo: team.teamNo,
            workload: team.workload
          };
        }
      }
      
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + category + ' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'
      };
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î - ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
    return assignMultipleTeams(categories, date, startTime, endTime, excludeRfiId, useCache);
    
  } catch (error) {
    console.error('Error in assignTeamAutomatically:', error);
    console.error('Stack:', error.stack);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°: ' + error.toString()
    };
  }
}

/**
 * ‚úÖ FINAL: ‡∏à‡∏±‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏° (Multi-Work) - Load Balanced
 */
function assignMultipleTeams(categories, date, startTime, endTime, excludeRfiId, useCache) {
  try {
    // Set default values
    if (typeof excludeRfiId === 'undefined') excludeRfiId = null;
    if (typeof useCache === 'undefined') useCache = false;
    
    console.log('========== Assigning multiple teams (Load Balanced) ==========');
    console.log('Categories:', categories);
    console.log('Use Cache:', useCache);
    
    const teamsByCategory = {};
    
    // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î
    for (let i = 0; i < categories.length; i++) {
      const cat = categories[i];
      const teams = getTeamsByCategory(cat);
      
      if (teams.length === 0) {
        return {
          success: false,
          message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + cat
        };
      }
      
      // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° workload + Round Robin
      teamsByCategory[cat] = sortTeamsByWorkload(teams, date, useCache);
      console.log('Category ' + cat + ':', teamsByCategory[cat].length, 'teams');
    }
    
    // ‚ö° ‡∏à‡∏≥‡∏Å‡∏±‡∏î combinations: ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 3 ‡∏ó‡∏µ‡∏°‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î
    const MAX_TEAMS_PER_CATEGORY = 3;
    
    Object.keys(teamsByCategory).forEach(function(cat) {
      if (teamsByCategory[cat].length > MAX_TEAMS_PER_CATEGORY) {
        teamsByCategory[cat] = teamsByCategory[cat].slice(0, MAX_TEAMS_PER_CATEGORY);
        console.log('‚ö° Limited ' + cat + ' to ' + MAX_TEAMS_PER_CATEGORY + ' teams');
      }
    });
    
    // ‚ö° Cache team availability
    const teamAvailability = {};
    Object.keys(teamsByCategory).forEach(function(cat) {
      teamsByCategory[cat].forEach(function(team) {
        teamAvailability[team.resourceId] = isTeamAvailable(
          team.resourceId, date, startTime, endTime, excludeRfiId
        );
      });
    });
    
    const availableCombinations = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡πà‡∏≤‡∏ú‡∏™‡∏°‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function generateCombinations(index, currentCombo) {
      if (index === categories.length) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        let allAvailable = true;
        let totalTeamNo = 0;
        let totalWorkload = 0;
        
        for (let i = 0; i < currentCombo.length; i++) {
          const team = currentCombo[i];
          
          if (!teamAvailability[team.resourceId]) {
            allAvailable = false;
            break;
          }
          
          totalTeamNo += team.teamNo;
          totalWorkload += team.workload;
        }
        
        if (allAvailable) {
          availableCombinations.push({
            teams: currentCombo.slice(),
            totalTeamNo: totalTeamNo,
            totalWorkload: totalWorkload
          });
        }
        
        return;
      }
      
      const cat = categories[index];
      const teams = teamsByCategory[cat];
      
      for (let i = 0; i < teams.length; i++) {
        currentCombo.push(teams[i]);
        generateCombinations(index + 1, currentCombo);
        currentCombo.pop();
      }
    }
    
    generateCombinations(0, []);
    
    console.log('Found ' + availableCombinations.length + ' available combinations');
    
    if (availableCombinations.length === 0) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î ' + categories.join(', ')
      };
    }
    
    // ‚≠ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ workload ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏° Team No.)
    availableCombinations.sort(function(a, b) {
      if (a.totalWorkload !== b.totalWorkload) {
        return a.totalWorkload - b.totalWorkload; // workload ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô
      }
      return a.totalTeamNo - b.totalTeamNo; // Team No. ‡πÄ‡∏•‡πá‡∏Å‡∏Å‡πà‡∏≠‡∏ô
    });
    
    const bestCombo = availableCombinations[0];
    const teamNames = bestCombo.teams.map(function(t) {
      return t.resourceName;
    });
    
    const resourceIds = bestCombo.teams.map(function(t) {
      return t.resourceId;
    });
    
    console.log('‚úÖ Selected teams:', teamNames.join(', '));
    console.log('Total workload:', bestCombo.totalWorkload);
    
    // ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï cache (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
    if (useCache) {
      bestCombo.teams.forEach(function(team) {
        incrementWorkloadCache(team.resourceId, date);
        LAST_SELECTED_TEAM[team.subType + '_' + date] = team.resourceId;
      });
    }
    
    return {
      success: true,
      assignedTeams: bestCombo.teams,
      teamNames: teamNames.join(','),
      resourceIds: resourceIds.join(','),
      totalTeamNo: bestCombo.totalTeamNo,
      totalWorkload: bestCombo.totalWorkload
    };
    
  } catch (error) {
    console.error('Error in assignMultipleTeams:', error);
    console.error('Stack:', error.stack);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡∏°: ' + error.toString()
    };
  }
}

// ===== User Management Functions =====
function validateAndGetUser(email, name) {
  try {
    console.log('Validating user:', email, name);
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found, creating...');
      createUserSheet();
      return addNewUser(email, name);
    }
    
    const lastRow = userSheet.getLastRow();
    
    if (lastRow <= 1) {
      return addNewUser(email, name);
    }
    
    const data = userSheet.getRange(2, 1, lastRow - 1, 5).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const userEmail = String(row[1] || '').trim().toLowerCase();
      const displayName = String(row[2] || '').trim();
      const role = String(row[3] || '').trim();
      const status = String(row[4] || '').trim();
      
      if (userEmail === email.toLowerCase()) {
        if (role === 'Requester' && status === 'Activated') {
          console.log('Found existing active user:', displayName, userEmail);
          return {
            success: true,
            email: userEmail,
            name: displayName,
            exists: true
          };
        } else {
          return {
            success: false,
            message: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö RFI (Role: ' + role + ', Status: ' + status + ')'
          };
        }
      }
    }
    
    return addNewUser(email, name);
    
  } catch (error) {
    console.error('Error in validateAndGetUser:', error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + error.toString()
    };
  }
}

function addNewUser(email, name) {
  try {
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    const lastRow = userSheet.getLastRow();
    const nextRow = lastRow + 1;
    
    const userId = nextRow - 1;
    
    const newUserData = [
      userId,
      email,
      name,
      'Requester',
      'Activated'
    ];
    
    userSheet.getRange(nextRow, 1, 1, 5).setValues([newUserData]);
    
    console.log('Added new user:', userId, name, email);
    
    return {
      success: true,
      email: email,
      name: name,
      exists: false,
      userId: userId
    };
    
  } catch (error) {
    console.error('Error adding new user:', error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà: ' + error.toString()
    };
  }
}

function createUserSheet() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = spreadsheet.getSheetByName('User');
    
    if (sheet) {
      console.log('User sheet already exists');
      return sheet;
    }
    
    sheet = spreadsheet.insertSheet('User');
    
    const headers = ['ID_User', 'UserEmail', 'DisplayName', 'Role', 'Status'];
    sheet.getRange(1, 1, 1, 5).setValues([headers]);
    
    const headerRange = sheet.getRange(1, 1, 1, 5);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#1877f2');
    headerRange.setFontColor('#ffffff');
    headerRange.setHorizontalAlignment('center');
    
    sheet.setColumnWidth(1, 100);
    sheet.setColumnWidth(2, 250);
    sheet.setColumnWidth(3, 200);
    sheet.setColumnWidth(4, 150);
    sheet.setColumnWidth(5, 120);
    
    sheet.setFrozenRows(1);
    
    const roleRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['Admin', 'QC Reviewer', 'QC', 'Requester', 'Manager'], true)
      .setAllowInvalid(false)
      .build();
    sheet.getRange(2, 4, 1000, 1).setDataValidation(roleRule);
    
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['Activated', 'Deactivated'], true)
      .setAllowInvalid(false)
      .build();
    sheet.getRange(2, 5, 1000, 1).setDataValidation(statusRule);
    
    console.log('User sheet created successfully');
    return sheet;
    
  } catch (error) {
    console.error('Error creating User sheet:', error);
    throw error;
  }
}

// ===== ID Generation Functions =====
function generateUniqueId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let id = '';
  
  for (let i = 0; i < 8; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  if (isIdExists(id)) {
    return generateUniqueId();
  }
  
  return id;
}

function isIdExists(id) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return false;
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return false;
    
    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    
    for (let i = 0; i < ids.length; i++) {
      if (ids[i][0] === id) {
        return true;
      }
    }
    
    return false;
  } catch (error) {
    console.error('Error checking ID existence:', error);
    return false;
  }
}

// ===== Email Functions =====
function getQCEmailList() {
  try {
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found');
      return [];
    }
    
    const lastRow = userSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No data in User sheet');
      return [];
    }
    
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    const emailList = [];
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      if ((role === 'QC Reviewer' || role === 'QC') && 
          status === 'Activated' && 
          email && email.includes('@')) {
        emailList.push({
          email: email,
          role: role
        });
      }
    }
    
    console.log('Found QC emails:', emailList.length);
    return emailList;
    
  } catch (error) {
    console.error('Error getting QC email list:', error);
    return [];
  }
}

function checkEmailQuota() {
  try {
    const remainingQuota = MailApp.getRemainingDailyQuota();
    console.log('Remaining email quota:', remainingQuota);
    return remainingQuota;
  } catch (error) {
    console.error('Error checking email quota:', error);
    return 0;
  }
}

function safeSendEmail(emailParams) {
  try {
    const quota = checkEmailQuota();
    if (quota <= 0) {
      console.log('Email quota exceeded, skipping email');
      return false;
    }
    
    MailApp.sendEmail(emailParams);
    return true;
  } catch (error) {
    console.error('Error sending email:', error);
    return false;
  }
}

function sendRFINotificationEmail(data, rfiId) {
  try {
    console.log('========== START: sendRFINotificationEmail ==========');
    
    const quota = checkEmailQuota();
    if (quota <= 1) {
      console.log('Email quota too low:', quota);
      return false;
    }
    
    const emailList = getQCEmailList();
    
    if (emailList.length === 0) {
      console.log('No QC email recipients found');
      return false;
    }
    
    const recipients = emailList.map(function(e) { return e.email; });
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Requester Email
    if (data.requesterEmail && 
        data.requesterEmail.includes('@') && 
        !recipients.includes(data.requesterEmail)) {
      recipients.push(data.requesterEmail);
    }
    
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Team Emails
    if (data.assignedTeam) {
      const teamEmails = getTeamEmailsByTeamNames(data.assignedTeam);
      teamEmails.forEach(function(teamMember) {
        if (!recipients.includes(teamMember.email)) {
          recipients.push(teamMember.email);
          console.log('Added team member:', teamMember.name, '->', teamMember.email);
        }
      });
    }
    
    console.log('Sending to:', recipients.length, 'recipients');
    
    const emailHtml = createRFIEmailHTML(data, rfiId);
    
    const sent = safeSendEmail({
      to: recipients.join(','),
      subject: 'üìã RFI Request ‡πÉ‡∏´‡∏°‡πà [ID: ' + rfiId + ']',
      htmlBody: emailHtml,
      name: 'RFI Requirement System'
    });
    
    console.log('Email result:', sent);
    return sent;
    
  } catch (error) {
    console.error('Error in sendRFINotificationEmail:', error);
    return false;
  }
}



function createRFIEmailHTML(data, rfiId) {
  const categoryDisplay = data.teamCategory ? data.teamCategory.replace(/,/g, ', ') : '';
  const teamInfo = data.assignedTeam ? 
    '<tr><th>‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ</th><td><strong>' + data.assignedTeam + '</strong> (' + categoryDisplay + ')</td></tr>' : '';
  
  const emailBody = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { color: #1877f2; }
.id-badge { 
  display: inline-block;
  background: #1877f2;
  color: white;
  padding: 5px 12px;
  border-radius: 5px;
  font-weight: bold;
  font-size: 16px;
  margin-bottom: 15px;
}
table { border-collapse: collapse; width: 100%; }
td, th { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #f0f2f5; }
.status-badge {
  display: inline-block;
  background: #ffc107;
  color: #000;
  padding: 3px 8px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: bold;
}
</style>
</head>
<body>
<h2>üìã ‡πÅ‡∏à‡πâ‡∏á RFI Request ‡πÉ‡∏´‡∏°‡πà</h2>
<div class="id-badge">RFI ID: ${rfiId}</div>
<p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ó‡∏µ‡∏° QC</p>
<p>‡∏°‡∏µ RFI Request ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>

<h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î RFI</h3>
<table>
<tr><th>RFI ID</th><td><strong>${rfiId}</strong></td></tr>
<tr><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><td>${data.description}</td></tr>
<tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><td>${data.location}</td></tr>
<tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</th><td>${formatDateThai(data.requestDate)}</td></tr>
<tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><td>${data.startTime} - ${data.endTime} ‡∏ô.</td></tr>
${teamInfo}
<tr><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td>${data.requesterName}</td></tr>
${data.requesterEmail ? '<tr><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td>' + data.requesterEmail + '</td></tr>' : ''}
<tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><td><span class="status-badge">RFI Request Submitted</span></td></tr>
</table>

<p>‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ RFI Request ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>

<hr>
<p><small>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö RFI Requirement ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small></p>
<p><small>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${new Date().toLocaleString('th-TH')}</small></p>
</body>
</html>`;
  
  return emailBody;
}

/**
 * ‚ö° UPDATED: ‡∏î‡∏∂‡∏á Available Time Slots (Optimized)
 * ‚úÖ ‡∏£‡∏±‡∏Å‡∏©‡∏≤ function signature ‡πÄ‡∏î‡∏¥‡∏°
 */
function getAvailableTimeSlots(date, category) {
  try {
    if (!date) return [];
    
    const now = new Date();
    const selectedDate = new Date(date + 'T00:00:00');
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á all slots
    const allSlots = [];
    for (let hour = 9; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 19 && minute === 30) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allSlots.push(time);
      }
    }
    
    let filteredSlots = allSlots.slice();
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
    if (selectedDateOnly.getTime() === today.getTime()) {
      const minTime = new Date(now.getTime() + (30 * 60 * 1000));
      
      filteredSlots = allSlots.filter(function(slot) {
        const slotTime = new Date(selectedDate);
        const timeParts = slot.split(':');
        slotTime.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0, 0);
        return slotTime > minTime;
      });
    } else if (selectedDateOnly < today) {
      return [];
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ category ‡πÉ‡∏´‡πâ return slots ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß
    if (!category) {
      return filteredSlots;
    }
    
    const availableTeams = getTeamsByCategory(category);
    
    if (availableTeams.length === 0) {
      return [];
    }
    
    // ‚ö° Cache blocked slots ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Performance Optimization)
    const blockedSlots = getBlockedTimeSlotsForTeams(date, availableTeams);
    
    const availableSlots = [];
    
    for (let i = 0; i < filteredSlots.length; i++) {
      const startSlot = filteredSlots[i];
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì end time (default +1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
      const startParts = startSlot.split(':');
      const startHour = parseInt(startParts[0]);
      const startMin = parseInt(startParts[1]);
      const endHour = startMin === 30 ? startHour + 1 : startHour;
      const endMin = startMin === 30 ? 0 : 30;
      const endSlot = endHour.toString().padStart(2, '0') + ':' + endMin.toString().padStart(2, '0');
      
      const requestStartMinutes = timeToMinutes(startSlot);
      const requestEndMinutes = timeToMinutes(endSlot);
      
      // ‚ö° ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å cached data ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ loop ‡∏ã‡πâ‡∏≥
      let hasAvailableTeam = false;
      
      for (let j = 0; j < availableTeams.length; j++) {
        const team = availableTeams[j];
        const blocks = blockedSlots[team.resourceId] || [];
        
        let isAvailable = true;
        
        for (let k = 0; k < blocks.length; k++) {
          const block = blocks[k];
          // Buffer ¬±25 ‡∏ô‡∏≤‡∏ó‡∏µ
          const bufferedStart = block.start - 25;
          const bufferedEnd = block.end + 25;
          
          if (!(requestEndMinutes < bufferedStart || requestStartMinutes > bufferedEnd)) {
            isAvailable = false;
            break;
          }
        }
        
        if (isAvailable) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        availableSlots.push(startSlot);
      }
    }
    
    return availableSlots;
    
  } catch (error) {
    console.error('Error in getAvailableTimeSlots:', error);
    return [];
  }
}

/**
 * ‚ö° UPDATED: ‡∏î‡∏∂‡∏á Available End Times (Optimized)
 * ‚úÖ ‡∏£‡∏±‡∏Å‡∏©‡∏≤ function signature ‡πÄ‡∏î‡∏¥‡∏°
 */
function getAvailableEndTimes(date, startTime, category) {
  try {
    if (!startTime || !date) return [];
    
    const allEndSlots = [];
    for (let hour = 9; hour <= 20; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 9 && minute === 0) continue;
        if (hour === 20 && minute > 0) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allEndSlots.push(time);
      }
    }
    
    const startMinutes = timeToMinutes(startTime);
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ category ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å RFI ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô)
    if (!category) {
      const existingRFI = getRFIByDate(date);
      
      let nextRFIMinutes = Infinity;
      existingRFI.forEach(function(rfi) {
        const rfiStartMinutes = timeToMinutes(rfi.startTime);
        if (rfiStartMinutes > startMinutes && rfiStartMinutes < nextRFIMinutes) {
          nextRFIMinutes = rfiStartMinutes;
        }
      });
      
      const availableEndTimes = allEndSlots.filter(function(slot) {
        const slotMinutes = timeToMinutes(slot);
        if (slotMinutes <= startMinutes) return false;
        if (nextRFIMinutes !== Infinity && slotMinutes > nextRFIMinutes) return false;
        return true;
      });
      
      return availableEndTimes;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const availableTeams = getTeamsByCategory(category);
    
    if (availableTeams.length === 0) {
      return [];
    }
    
    // ‚ö° Cache blocked slots ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    const blockedSlots = getBlockedTimeSlotsForTeams(date, availableTeams);
    
    const availableEndTimes = [];
    
    for (let i = 0; i < allEndSlots.length; i++) {
      const endSlot = allEndSlots[i];
      const endMinutes = timeToMinutes(endSlot);
      
      if (endMinutes <= startMinutes) continue;
      
      // ‚ö° ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å cached data
      let hasAvailableTeam = false;
      
      for (let j = 0; j < availableTeams.length; j++) {
        const team = availableTeams[j];
        const blocks = blockedSlots[team.resourceId] || [];
        
        let isAvailable = true;
        
        for (let k = 0; k < blocks.length; k++) {
          const block = blocks[k];
          // Buffer ¬±25 ‡∏ô‡∏≤‡∏ó‡∏µ
          const bufferedStart = block.start - 25;
          const bufferedEnd = block.end + 25;
          
          if (!(endMinutes < bufferedStart || startMinutes > bufferedEnd)) {
            isAvailable = false;
            break;
          }
        }
        
        if (isAvailable) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        availableEndTimes.push(endSlot);
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡πà‡∏≠ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
        break;
      }
    }
    
    return availableEndTimes;
    
  } catch (error) {
    console.error('Error in getAvailableEndTimes:', error);
    return [];
  }
}

/**
 * ‚úÖ UPDATED: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ RFI ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
 */
function getRFIByDate(date) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return [];
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return [];
    
    const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
    const rfiList = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rfiId = row[0];
      const requestDate = formatDate(new Date(row[4]));
      const status = String(row[14] || '').trim();  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° String() ‡πÅ‡∏•‡∏∞ trim()
      
      // ‚úÖ ‡πÉ‡∏ä‡πâ isStatusInactive() ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
      if (isStatusInactive(status)) {
        continue;  // ‡∏Ç‡πâ‡∏≤‡∏° RFI ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß
      }
      
      if (requestDate === date) {
        rfiList.push({
          id: rfiId,
          requestDate: requestDate,
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          assignedTeam: row[7] || '',
          description: row[2],
          location: row[3]
        });
      }
    }
    
    return rfiList;
  } catch (error) {
    console.error('Error getting RFI by date:', error);
    return [];
  }
}

// ===== Core Save Function =====
function saveRFIRequirement(data) {
  try {
    console.log('========== saveRFIRequirement START ==========');
    console.log('Input data:', JSON.stringify(data));
    
    // Validation
    if (!data.requestDate || !data.startTime || !data.endTime || 
        !data.workType || !data.description || !data.location || 
        !data.requesterName || !data.requesterEmail || !data.teamCategory) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠)'
      };
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å User sheet
    const userValidation = validateAndGetUser(data.requesterEmail, data.requesterName);
    
    if (!userValidation.success) {
      console.log('User validation failed:', userValidation.message);
      return {
        success: false,
        message: userValidation.message
      };
    }
    
    console.log('User validation success:', userValidation);
    
    const validatedEmail = userValidation.email;
    const validatedName = userValidation.name;
    
    // ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ cache ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet)
// ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
const teamAssignment = assignTeamAutomatically(
  data.teamCategory, 
  data.requestDate, 
  data.startTime, 
  data.endTime,
  null,    // excludeRfiId
  false    // useCache = false (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á)
);

// ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ
if (!teamAssignment) {
  console.error('teamAssignment is undefined!');
  return {
    success: false,
    message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ'
  };
}
    
    if (!teamAssignment.success) {
      console.log('Team assignment failed:', teamAssignment.message);
      return {
        success: false,
        message: teamAssignment.message
      };
    }
    
    console.log('Team assigned:', teamAssignment);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Unique ID
    const rfiId = generateUniqueId();
    console.log('Generated RFI ID:', rfiId);
    
    // ‡∏î‡∏∂‡∏á Sheet
    let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('RFI_List sheet not found, creating new one...');
      sheet = createRFIListSheet();
    }
    
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    const currentTime = new Date();
    
    console.log('Adding data to sheet at row:', nextRow);
    
    const combinedDescription = data.workType + ' - ' + data.description;
    console.log('Combined description:', combinedDescription);
    
    // ‚≠ê ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 40 columns (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Column AN)
    const rowData = [];
    for (let i = 0; i < 40; i++) {
      rowData.push('');
    }
    
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    rowData[0] = rfiId;                          // A - ID
    rowData[2] = combinedDescription;            // C - description
    rowData[3] = data.location;                  // D - Location
    rowData[4] = formattedDate;                  // E - Request_Date
    rowData[5] = data.startTime;                 // F - Start_Time
    rowData[6] = data.endTime;                   // G - End_Time 
    rowData[9] = validatedEmail;                 // J - Requester_Email
    rowData[10] = validatedName;                 // K - Requester_Name
    rowData[11] = teamAssignment.teamNames;      // L - Assigned_Inspector (‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ)
    rowData[14] = 'RFI Request Submitted';       // O - Status
    rowData[15] = currentTime;                   // P - Created_Timestamp
    rowData[39] = 'RFI Work';                    // AN - Column AN (index 39) ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    
    console.log('Row data prepared with Column AN = "RFI Work"');
    
    // ‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å 40 columns
    sheet.getRange(nextRow, 1, 1, 40).setValues([rowData]);
    console.log('Data added to sheet successfully');
    
    // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    let emailSent = false;
    try {
      const categoryDisplay = data.teamCategory.replace(/,/g, ', ');
      const emailData = {
        requestDate: data.requestDate,
        startTime: data.startTime,
        endTime: data.endTime,
        description: combinedDescription,
        location: data.location,
        requesterName: validatedName,
        requesterEmail: validatedEmail,
        assignedTeam: teamAssignment.teamNames, // ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° ‡πÄ‡∏ä‡πà‡∏ô "Survey Team A,Inspector Team B"
        teamCategory: categoryDisplay
      };
      emailSent = sendRFINotificationEmail(emailData, rfiId);
      console.log('Email sent:', emailSent);
    } catch (emailError) {
      console.error('Failed to send email:', emailError);
    }
    
    const categoryDisplay = data.teamCategory.replace(/,/g, ', ');
    let message = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å RFI Request ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (ID: ' + rfiId + ')';
    message += '\n‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô: ' + categoryDisplay;
    message += '\n‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°: ' + teamAssignment.teamNames; // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    message += '\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: RFI Work';  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    if (!userValidation.exists) {
      message += '\n‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß';
    }
    if (emailSent) {
      message += '\n‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏° QC ‡πÅ‡∏•‡πâ‡∏ß';
    }
    
    console.log('========== saveRFIRequirement SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      emailSent: emailSent,
      userAdded: !userValidation.exists,
      assignedTeam: teamAssignment.teamNames
    };
    
  } catch (error) {
    console.error('========== saveRFIRequirement FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

// ===== Sheet Creation Functions =====
function createRFIListSheet() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = spreadsheet.getSheetByName('RFI_List');
    
    if (sheet) {
      console.log('RFI_List sheet already exists');
      return sheet;
    }
    
    sheet = spreadsheet.insertSheet('RFI_List');
    
    const headers = [
      'ID_RFI', '', 'description', 'Location', 'Request_Date',
      'Start_Time', 'End_Time', 'Assigned_Team', '', 'Requester_Email',
      'Requester_Name', '', 'Assigned_Inspector', '', 'Status', 'Created_Timestamp'
    ];
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#1877f2');
    headerRange.setFontColor('#ffffff');
    headerRange.setHorizontalAlignment('center');
    
    sheet.setFrozenRows(1);
    
    console.log('RFI_List sheet created successfully');
    return sheet;
    
  } catch (error) {
    console.error('Error creating RFI_List sheet:', error);
    throw error;
  }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet Resources ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å Apps Script Editor
 */
function createResourcesSheet() {
  try {
    console.log('========== Creating Resources Sheet ==========');
    
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = spreadsheet.getSheetByName('Resources');
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ sheet ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (sheet) {
      console.log('Resources sheet already exists');
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        'Sheet Resources ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß',
        '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö',
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        spreadsheet.deleteSheet(sheet);
        console.log('Deleted existing Resources sheet');
      } else {
        console.log('User cancelled - keeping existing sheet');
        return sheet;
      }
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet ‡πÉ‡∏´‡∏°‡πà
    sheet = spreadsheet.insertSheet('Resources');
    console.log('Created new Resources sheet');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Headers
    const headers = [
      'Resource_ID',
      'Resource_Name',
      'Sub_Type',
      'Team No.',
      'Status',
      'Contact_Email',
      'Contact_Phone',
      'Color Code'
    ];
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // Format Header
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#1877f2');
    headerRange.setFontColor('#ffffff');
    headerRange.setHorizontalAlignment('center');
    headerRange.setVerticalAlignment('middle');
    
    console.log('Created headers');
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 6 ‡∏ó‡∏µ‡∏°
    const sampleData = [
      ['T001', 'Survey Team A', 'Survey', 1, 'Activated', 'survey.a@company.com', '02-123-4567', '#FF6B6B'],
      ['T002', 'Survey Team B', 'Survey', 2, 'Activated', 'survey.b@company.com', '02-123-4568', '#4ECDC4'],
      ['T003', 'Lab Team A', 'Lab', 1, 'Activated', 'lab.a@company.com', '02-123-4569', '#45B7D1'],
      ['T004', 'Lab Team B', 'Lab', 2, 'Activated', 'lab.b@company.com', '02-123-4570', '#96CEB4'],
      ['T005', 'Inspector Team A', 'Inspector', 1, 'Activated', 'inspector.a@company.com', '02-123-4571', '#FFEAA7'],
      ['T006', 'Inspector Team B', 'Inspector', 2, 'Activated', 'inspector.b@company.com', '02-123-4572', '#DFE6E9']
    ];
    
    sheet.getRange(2, 1, sampleData.length, sampleData[0].length).setValues(sampleData);
    console.log('Added ' + sampleData.length + ' sample teams');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    sheet.setColumnWidth(1, 120);  // Resource_ID
    sheet.setColumnWidth(2, 200);  // Resource_Name
    sheet.setColumnWidth(3, 120);  // Sub_Type
    sheet.setColumnWidth(4, 100);  // Team No.
    sheet.setColumnWidth(5, 100);  // Status
    sheet.setColumnWidth(6, 200);  // Contact_Email
    sheet.setColumnWidth(7, 150);  // Contact_Phone
    sheet.setColumnWidth(8, 100);  // Color Code
    
    // Freeze header row
    sheet.setFrozenRows(1);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Data Validation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sub_Type
    const subTypeRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['Survey', 'Lab', 'Inspector'], true)
      .setAllowInvalid(false)
      .setHelpText('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: Survey, Lab, ‡∏´‡∏£‡∏∑‡∏≠ Inspector')
      .build();
    sheet.getRange(2, 3, 100, 1).setDataValidation(subTypeRule);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Data Validation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Status
    const statusRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(['Activated', 'Deactivated'], true)
      .setAllowInvalid(false)
      .setHelpText('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: Activated ‡∏´‡∏£‡∏∑‡∏≠ Deactivated')
      .build();
    sheet.getRange(2, 5, 100, 1).setDataValidation(statusRule);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Number Validation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Team No.
    const teamNoRule = SpreadsheetApp.newDataValidation()
      .requireNumberGreaterThan(0)
      .setAllowInvalid(false)
      .setHelpText('‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0')
      .build();
    sheet.getRange(2, 4, 100, 1).setDataValidation(teamNoRule);
    
    console.log('Set up data validations');
    
    // Format ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const dataRange = sheet.getRange(2, 1, sampleData.length, sampleData[0].length);
    dataRange.setVerticalAlignment('middle');
    
    // Format Team No. ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    sheet.getRange(2, 4, 100, 1).setNumberFormat('0');
    
    console.log('========== Resources Sheet Created Successfully ==========');
    
    // ‡πÅ‡∏™‡∏î‡∏á Dialog ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet Resources ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
      '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 6 ‡∏ó‡∏µ‡∏°:\n\n' +
      '‚úì Survey Team A, B (Team No. 1, 2)\n' +
      '‚úì Lab Team A, B (Team No. 1, 2)\n' +
      '‚úì Inspector Team A, B (Team No. 1, 2)\n\n' +
      '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà Sheet "Resources"',
      ui.ButtonSet.OK
    );
    
    return sheet;
    
  } catch (error) {
    console.error('Error creating Resources sheet:', error);
    
    // ‡πÅ‡∏™‡∏î‡∏á Error Dialog
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet Resources ‡πÑ‡∏î‡πâ\n\n' +
      'Error: ' + error.toString(),
      ui.ButtonSet.OK
    );
    
    throw error;
  }
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Resources
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
 */
function viewResourcesInfo() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!sheet) {
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        '‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet Resources',
        '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet Resources ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        createResourcesSheet();
      }
      return;
    }
    
    const lastRow = sheet.getLastRow();
    
    if (lastRow <= 1) {
      const ui = SpreadsheetApp.getUi();
      ui.alert(
        'Sheet Resources ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤',
        '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÉ‡∏ô Sheet Resources\n\n' +
        '‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö Sheet ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ô createResourcesSheet() ‡πÉ‡∏´‡∏°‡πà',
        ui.ButtonSet.OK
      );
      return;
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
    
    let message = '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (' + (lastRow - 1) + ' ‡∏ó‡∏µ‡∏°):\n\n';
    let activatedCount = 0;
    
    const teamsByType = {
      'Survey': [],
      'Lab': [],
      'Inspector': []
    };
    
    data.forEach(function(row) {
      const resourceId = String(row[0] || '').trim();
      const resourceName = String(row[1] || '').trim();
      const subType = String(row[2] || '').trim();
      const teamNo = row[3];
      const status = String(row[4] || '').trim();
      
      if (status === 'Activated' && resourceId && subType) {
        activatedCount++;
        
        if (teamsByType[subType]) {
          teamsByType[subType].push({
            id: resourceId,
            name: resourceName,
            teamNo: teamNo
          });
        }
      }
    });
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    ['Survey', 'Lab', 'Inspector'].forEach(function(type) {
      if (teamsByType[type].length > 0) {
        message += type + ' (' + teamsByType[type].length + ' ‡∏ó‡∏µ‡∏°):\n';
        
        teamsByType[type].sort(function(a, b) {
          return a.teamNo - b.teamNo;
        });
        
        teamsByType[type].forEach(function(team) {
          message += '  ‚Ä¢ ' + team.id + ' - ' + team.name + ' (Team No.' + team.teamNo + ')\n';
        });
        
        message += '\n';
      }
    });
    
    message += '‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + activatedCount + ' ‡∏ó‡∏µ‡∏°';
    
    const ui = SpreadsheetApp.getUi();
    ui.alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô', message, ui.ButtonSet.OK);
    
    console.log(message);
    
  } catch (error) {
    console.error('Error viewing resources info:', error);
    
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Resources ‡πÑ‡∏î‡πâ\n\n' +
      'Error: ' + error.toString(),
      ui.ButtonSet.OK
    );
  }
}

function updateAvailableSlots() {
  const date = document.getElementById('requestDate').value;
  const startTimeSelect = document.getElementById('startTime');
  const endTimeSelect = document.getElementById('endTime');
  
  setSelectLoading(startTimeSelect, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á...');
  resetEndTimeSelect();
  
  if (date) {
    const selectedDate = new Date(date + 'T00:00:00');
    const today = new Date();
    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    
    if (selectedDateOnly <= todayDateOnly) {
      startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
      startTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ --</option>';
      startTimeSelect.disabled = true;
      showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', 'warning');
      return;
    }
    
    // ‡∏™‡πà‡∏á category ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    const category = selectedTeamCategory;
    
    google.script.run
      .withSuccessHandler(function(availableSlots) {            
        startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
        startTimeSelect.innerHTML = '';
        
        if (!availableSlots || availableSlots.length === 0) {
          startTimeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á --</option>';
          startTimeSelect.disabled = true;
          showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'warning');
        } else {
          startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô --</option>';
          
          availableSlots.forEach(function(slot) {
            const option = document.createElement('option');
            option.value = slot;
            option.textContent = slot + ' ‡∏ô.';
            startTimeSelect.appendChild(option);
          });
          
          startTimeSelect.disabled = false;
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error getting available slots:', error);
        
        startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
        startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
        startTimeSelect.disabled = true;
        
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á: ' + error.message, 'error');
      })
      .getAvailableTimeSlots(date, category);  // ‡∏™‡πà‡∏á category ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
  } else {
    startTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>';
    startTimeSelect.disabled = true;
  }
}

function updateEndTimeSlots() {
  const date = document.getElementById('requestDate').value;
  const startTime = document.getElementById('startTime').value;
  const endTimeSelect = document.getElementById('endTime');
  
  if (!startTime) {
    resetEndTimeSelect();
    return;
  }
  
  setSelectLoading(endTimeSelect, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î...');
  
  if (date && startTime) {
    const category = selectedTeamCategory;  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    
    google.script.run
      .withSuccessHandler(function(availableEndTimes) {
        endTimeSelect.className = endTimeSelect.className.replace(' loading-select', '');
        endTimeSelect.innerHTML = '';
        
        if (!availableEndTimes || availableEndTimes.length === 0) {
          endTimeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á --</option>';
          endTimeSelect.disabled = true;
          showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', 'warning');
        } else {
          endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î --</option>';
          
          const startHour = parseInt(startTime.split(':')[0]);
          const startMinute = parseInt(startTime.split(':')[1]);
          const defaultEndTime = (startHour + 1).toString().padStart(2, '0') + ':' + 
                               startMinute.toString().padStart(2, '0');
          
          availableEndTimes.forEach(function(time) {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time + ' ‡∏ô.';
            if (time === defaultEndTime) {
              option.selected = true;
            }
            endTimeSelect.appendChild(option);
          });
          
          endTimeSelect.disabled = false;
          
          if (availableEndTimes.includes(defaultEndTime)) {
            showMessage('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ' + defaultEndTime + ' ‡∏ô. (1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)', 'info', 3000);
          }
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error getting end times:', error);
        
        endTimeSelect.className = endTimeSelect.className.replace(' loading-select', '');
        endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
        endTimeSelect.disabled = true;
        
        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ' + error.message, 'error');
      })
      .getAvailableEndTimes(date, startTime, category);  // ‡∏™‡πà‡∏á category ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
  }
}


function initTeamCategoryButtons() {
  const teamButtons = document.querySelectorAll('.team-btn');
  const multiSelectContainer = document.getElementById('multiSelectContainer');
  const multiWorkBtn = document.getElementById('multiWorkBtn');
  
  teamButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      // ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ...
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î time slots ‡πÉ‡∏´‡∏°‡πà
      const requestDate = document.getElementById('requestDate').value;
      if (requestDate) {
        updateAvailableSlots();
      }
    });
  });
}

function updateMultiWorkSelection() {
  if (!isMultiWork) return;
  
  const checkboxes = document.querySelectorAll('#multiSelectContainer input[type="checkbox"]:checked');
  const selectedCategories = [];
  
  checkboxes.forEach(function(cb) {
    selectedCategories.push(cb.value);
  });
  
  if (selectedCategories.length > 0) {
    selectedTeamCategory = selectedCategories.join(',');
    document.getElementById('teamCategory').value = selectedTeamCategory;
    showMessage('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ' + selectedTeamCategory, 'info', 2000);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÇ‡∏´‡∏•‡∏î time slots ‡πÉ‡∏´‡∏°‡πà
    const requestDate = document.getElementById('requestDate').value;
    if (requestDate) {
      updateAvailableSlots();
    }
  } else {
    selectedTeamCategory = null;
    document.getElementById('teamCategory').value = '';
  }
}

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ QC RFI Form
 */
function openQCRFIForm() {
  const html = HtmlService.createHtmlOutputFromFile('qc')
    .setWidth(800)
    .setHeight(900);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'QC RFI System');
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Code ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
function getCodeList() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Code');
    
    if (!sheet) {
      console.log('Code sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No codes found');
      return [];
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    const codes = [];
    
    for (let i = 0; i < data.length; i++) {
      const id = data[i][0];
      const code = String(data[i][1] || '').trim();
      const name = String(data[i][2] || '').trim();
      
      if (code) {
        codes.push({
          id: id,
          code: code,
          name: name
        });
      }
    }
    
    console.log('Found codes:', codes.length);
    return codes;
    
  } catch (error) {
    console.error('Error getting code list:', error);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Resources ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Activated
 */
function getAllResourcesList() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!sheet) {
      console.log('Resources sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No resources found');
      return [];
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
    const resources = [];
    
    for (let i = 0; i < data.length; i++) {
      const resourceId = String(data[i][0] || '').trim();
      const resourceName = String(data[i][1] || '').trim();
      const subType = String(data[i][2] || '').trim();
      const teamNo = data[i][3];
      const status = String(data[i][4] || '').trim();
      
      if (status === 'Activated' && resourceId && resourceName) {
        resources.push({
          id: resourceId,
          name: resourceName,
          subType: subType,
          teamNo: teamNo
        });
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Team No.
    resources.sort(function(a, b) {
      return a.teamNo - b.teamNo;
    });
    
    console.log('Found resources:', resources.length);
    return resources;
    
  } catch (error) {
    console.error('Error getting resources list:', error);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Requester (Role = Requester, Status = Activated)
 */
function getRequesterList() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!sheet) {
      console.log('User sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No users found');
      return [];
    }
    
    const data = sheet.getRange(2, 2, lastRow - 1, 4).getValues();
    const requesters = [];
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim();
      const name = String(data[i][1] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      if (role === 'Requester' && status === 'Activated' && email && name) {
        requesters.push({
          email: email,
          name: name
        });
      }
    }
    
    console.log('Found requesters:', requesters.length);
    return requesters;
    
  } catch (error) {
    console.error('Error getting requester list:', error);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á email ‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
 */

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Order_RFI ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
 */
function getNextOrderRFI(code) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return 1;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return 1;
    }
    
    // ‡∏î‡∏∂‡∏á Column H (Order_RFI) ‡πÅ‡∏•‡∏∞ I (Code)
    const data = sheet.getRange(2, 8, lastRow - 1, 2).getValues();
    
    let maxOrder = 0;
    
    for (let i = 0; i < data.length; i++) {
      const orderRFI = data[i][0];
      const rfiCode = String(data[i][1] || '').trim();
      
      if (rfiCode === code && orderRFI && !isNaN(orderRFI)) {
        if (orderRFI > maxOrder) {
          maxOrder = orderRFI;
        }
      }
    }
    
    return maxOrder + 1;
    
  } catch (error) {
    console.error('Error getting next order RFI:', error);
    return 1;
  }
}

/**
 * ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Order_Survey ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Order_RFI)
 */
function getNextOrderSurvey() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return 1;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return 1;
    }
    
    // ‡∏î‡∏∂‡∏á Column H (Order) ‡πÅ‡∏•‡∏∞ Column AN (Type)
    const orderData = sheet.getRange(2, 8, lastRow - 1, 1).getValues();  // Column H
    const typeData = sheet.getRange(2, 40, lastRow - 1, 1).getValues();   // Column AN
    
    let maxOrder = 0;
    
    for (let i = 0; i < orderData.length; i++) {
      const order = orderData[i][0];
      const type = String(typeData[i][0] || '').trim();
      
      // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Survey Work ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      if (type === 'Survey Work' && order && !isNaN(order)) {
        if (order > maxOrder) {
          maxOrder = order;
        }
      }
    }
    
    console.log('‚úÖ Next Order_Survey:', maxOrder + 1);
    return maxOrder + 1;
    
  } catch (error) {
    console.error('Error getting next order Survey:', error);
    return 1;
  }
}

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QC RFI
 */
function saveQCRFI(data) {
  try {
    console.log('========== saveQCRFI START ==========');
    console.log('Input data:', JSON.stringify(data));
    
    // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const roleValidation = validateQCRole();
    if (!roleValidation.success) {
      return {
        success: false,
        message: roleValidation.message
      };
    }
    
    console.log('QC Role validated:', roleValidation.name, roleValidation.role);
    
    // Validation
    if (!data.code || !data.requestDate || !data.startTime || 
        !data.description || !data.location || !data.assignedInspector || 
        !data.requesterEmail || !data.requesterName) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      };
    }
    
    // ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà required ‡πÅ‡∏•‡πâ‡∏ß - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô +1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
    let endTime = data.endTime;
    if (!endTime) {
      const startParts = data.startTime.split(':');
      const endHour = parseInt(startParts[0]) + 1;
      endTime = endHour.toString().padStart(2, '0') + ':' + startParts[1];
      console.log('End time not provided, using default:', endTime);
    }
    
    // ‡∏î‡∏∂‡∏á Sheet
    let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('RFI_List sheet not found, creating new one...');
      sheet = createRFIListSheet();
    }
    
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    const currentTime = new Date();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID (8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Unique ID
const rfiId = generateUniqueId();
console.log('Generated ID:', rfiId);

// ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Order_Survey ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Survey_NO
const orderSurvey = getNextOrderSurvey();
console.log('Order Survey:', orderSurvey);

const orderSurveyPadded = String(orderSurvey).padStart(4, '0');
const surveyNo = 'SW-' + orderSurveyPadded;  // ‡πÄ‡∏ä‡πà‡∏ô SW-0001
console.log('Survey NO:', surveyNo);
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Order_RFI
    const orderRFI = getNextOrderRFI(data.code);
    console.log('Order RFI:', orderRFI);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á RFI_NO = Code + "-RFI-" + Order_RFI (4 ‡∏´‡∏•‡∏±‡∏Å)
    const orderRFIPadded = String(orderRFI).padStart(4, '0');
    const rfiNo = data.code + '-RFI-' + orderRFIPadded;
    console.log('RFI NO:', rfiNo);
    
    // Format date
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    console.log('Adding data to sheet at row:', nextRow);
    
    // ‚≠ê ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 40 columns (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Column AN)
    const rowData = [];
    for (let i = 0; i < 40; i++) {
      rowData.push('');
    }
    
    rowData[0] = rfiId;                          // A - ID
    rowData[1] = rfiNo;                          // B - RFI_NO (10-RFI-0001)
    rowData[2] = data.description;               // C - description
    rowData[3] = data.location;                  // D - Location
    rowData[4] = formattedDate;                  // E - Request_Date
    rowData[5] = data.startTime;                 // F - Start_Time
    rowData[6] = endTime;                        // G - End_Time (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß)
    rowData[7] = orderRFI;                       // H - Order_RFI
    rowData[8] = data.code;                      // I - Code
    rowData[9] = data.requesterEmail;            // J - Requester_Email
    rowData[10] = data.requesterName;            // K - Requester_Name
    rowData[11] = data.assignedInspector;        // L - Assigned_Inspector
    rowData[14] = 'Draft';                       // O - Status
    rowData[15] = currentTime;                   // P - Created_Timestamp
    rowData[16] = roleValidation.email;          // Q - Recorded By (‡πÉ‡∏ä‡πâ email ‡∏à‡∏≤‡∏Å validation)
    rowData[18] = 'Open RFI';                    // S - Type
    rowData[19] = data.requireSurveyReport || 'None';  // T - Require_Survey_Report
    rowData[20] = data.requireLabReport || 'None';     // U - Require_Lab_Report
    rowData[39] = 'RFI Work';                    // AN - Column AN (index 39) ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    
    console.log('Row data prepared with Column AN = "RFI Work"');
    
    // ‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å 40 columns
    sheet.getRange(nextRow, 1, 1, 40).setValues([rowData]);
    console.log('Data added to sheet successfully');
    
    let message = '‡∏™‡∏£‡πâ‡∏≤‡∏á RFI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n';
    message += 'RFI NO: ' + rfiNo + '\n';
    message += '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + data.assignedInspector + '\n';
    message += '‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + data.requesterName + '\n';
    message += '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: RFI Work\n';  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    message += '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ' + roleValidation.name + ' (' + roleValidation.role + ')';
    
    console.log('========== saveQCRFI SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      rfiNo: rfiNo
    };
    
  } catch (error) {
    console.error('========== saveQCRFI FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}


/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Resources ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô RFI)
 */
function getAvailableResourcesList(date, startTime, endTime, excludeRfiId) {
  try {
    console.log('Getting available resources for:', date, startTime, endTime, 'Exclude RFI:', excludeRfiId);
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!sheet) {
      console.log('Resources sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No resources found');
      return [];
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
    const availableResources = [];
    
    for (let i = 0; i < data.length; i++) {
      const resourceId = String(data[i][0] || '').trim();
      const resourceName = String(data[i][1] || '').trim();
      const subType = String(data[i][2] || '').trim();
      const teamNo = data[i][3];
      const status = String(data[i][4] || '').trim();
      
      if (status === 'Activated' && resourceId && resourceName) {
        // ‚≠ê ‡∏™‡πà‡∏á excludeRfiId ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        if (isTeamAvailable(resourceId, date, startTime, endTime, excludeRfiId)) {
          availableResources.push({
            id: resourceId,
            name: resourceName,
            subType: subType,
            teamNo: teamNo
          });
        }
      }
    }
    
    availableResources.sort(function(a, b) {
      return a.teamNo - b.teamNo;
    });
    
    console.log('Found available resources:', availableResources.length);
    return availableResources;
    
  } catch (error) {
    console.error('Error getting available resources list:', error);
    return [];
  }
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ User ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô QC ‡∏´‡∏£‡∏∑‡∏≠ QC Reviewer ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function validateQCRole() {
  try {
    const userEmail = Session.getActiveUser().getEmail();
    console.log('Validating QC role for:', userEmail);
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á User'
      };
    }
    
    const lastRow = userSheet.getLastRow();
    if (lastRow <= 1) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
      };
    }
    
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim().toLowerCase();
      const name = String(data[i][1] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      if (email === userEmail.toLowerCase()) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Role ‡πÄ‡∏õ‡πá‡∏ô QC ‡∏´‡∏£‡∏∑‡∏≠ QC Reviewer ‡πÅ‡∏•‡∏∞ Status = Activated
        if ((role === 'QC' || role === 'QC Reviewer') && status === 'Activated') {
          console.log('QC role validated:', name, role);
          return {
            success: true,
            name: name,
            role: role,
            email: email
          };
        } else {
          return {
            success: false,
            message: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö QC (Role: ' + role + ', Status: ' + status + ')'
          };
        }
      }
    }
    
    return {
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'
    };
    
  } catch (error) {
    console.error('Error validating QC role:', error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ' + error.toString()
    };
  }
}

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç QC RFI
 */
function openQCEditForm() {
  const html = HtmlService.createHtmlOutputFromFile('qc_edit')
    .setWidth(900)
    .setHeight(900);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'QC - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI');
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ RFI ‡∏ó‡∏µ‡πà Status = Draft ‡∏´‡∏£‡∏∑‡∏≠ RFI Request Submitted
 */
/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ RFI ‡∏ó‡∏µ‡πà Status = Draft ‡∏´‡∏£‡∏∑‡∏≠ RFI Request Submitted
 */
function getRFIListForQC() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('DEBUG: RFI_List sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    console.log('DEBUG: lastRow =', lastRow);
    
    if (lastRow <= 1) {
      console.log('DEBUG: No data rows');
      return [];
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 21).getValues();
    console.log('DEBUG: Total rows =', data.length);
    
    const rfiList = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const id = String(row[0] || '').trim();
      const rfiNo = String(row[1] || '').trim();
      const status = String(row[14] || '').trim();
      
      console.log('DEBUG: Row', i, 'ID:', id, 'RFI_NO:', rfiNo, 'Status:', status);
      
      if (status === 'Draft' || status === 'RFI Request Submitted') {
        console.log('DEBUG: -> MATCHED! Adding to list');
        
        // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏á Date object ‡πÄ‡∏õ‡πá‡∏ô String
        const createdTimestamp = row[15];
        let createdDateStr = '';
        if (createdTimestamp) {
          try {
            const d = new Date(createdTimestamp);
            createdDateStr = d.toISOString();
          } catch (e) {
            createdDateStr = String(createdTimestamp);
          }
        }
        
        rfiList.push({
          id: id,
          rfiNo: rfiNo,
          description: String(row[2] || '').trim(),
          location: String(row[3] || '').trim(),
          requestDate: formatDate(new Date(row[4])),
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          code: String(row[8] || '').trim(),
          requesterEmail: String(row[9] || '').trim(),
          requesterName: String(row[10] || '').trim(),
          assignedInspector: String(row[11] || '').trim(),
          status: status,
          createdTimestamp: createdDateStr,  // ‚≠ê ‡πÉ‡∏ä‡πâ string ‡πÅ‡∏ó‡∏ô Date object
          type: String(row[18] || '').trim(),
          requireSurveyReport: String(row[19] || '').trim(),
          requireLabReport: String(row[20] || '').trim()
        });
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
    rfiList.sort(function(a, b) {
      if (!a.createdTimestamp || !b.createdTimestamp) return 0;
      return new Date(b.createdTimestamp).getTime() - new Date(a.createdTimestamp).getTime();
    });
    
    console.log('DEBUG: Final list count =', rfiList.length);
    
    // ‚≠ê ‡∏•‡∏ö JSON.stringify ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î serialization error
    // console.log('DEBUG: RFI List =', JSON.stringify(rfiList));
    
    return rfiList;
    
  } catch (error) {
    console.error('ERROR in getRFIListForQC:', error);
    console.error('Error stack:', error.stack);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RFI ‡∏ï‡∏≤‡∏° ID (Fixed - ‡∏£‡∏ß‡∏° Column AJ)
 */
function getRFIById(rfiId) {
  try {
    console.log('Getting RFI by ID:', rfiId);
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('RFI_List sheet not found');
      return null;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No data rows');
      return null;
    }
    
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ñ‡∏∂‡∏á column AJ (column 36)
    const data = sheet.getRange(2, 1, lastRow - 1, 36).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const id = String(row[0] || '').trim();
      
      if (id === rfiId) {
        console.log('Found RFI:', id);
        
        let createdTimestamp = '';
        if (row[15]) {
          try {
            createdTimestamp = new Date(row[15]).toISOString();
          } catch (e) {
            createdTimestamp = String(row[15]);
          }
        }
        
        let requestDate = '';
        if (row[4]) {
          try {
            const d = new Date(row[4]);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            requestDate = year + '-' + month + '-' + day;
          } catch (e) {
            requestDate = formatDate(new Date(row[4]));
          }
        }
        
        const rfiData = {
          id: id,
          rfiNo: String(row[1] || '').trim(),
          description: String(row[2] || '').trim(),
          location: String(row[3] || '').trim(),
          requestDate: requestDate,
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          orderRFI: row[7],
          code: String(row[8] || '').trim(),
          requesterEmail: String(row[9] || '').trim(),
          requesterName: String(row[10] || '').trim(),
          assignedInspector: String(row[11] || '').trim(),
          status: String(row[14] || '').trim(),
          createdTimestamp: createdTimestamp,
          recordedBy: String(row[16] || '').trim(),
          type: String(row[18] || '').trim(),
          requireSurveyReport: String(row[19] || '').trim(),
          requireLabReport: String(row[20] || '').trim(),
          postponeReason: String(row[35] || '').trim(),  // ‚úÖ Column AJ (index 35)
          rowIndex: i + 2
        };
        
        console.log('Returning RFI data with postpone reason:', rfiData.postponeReason);
        return rfiData;
      }
    }
    
    console.log('RFI not found');
    return null;
    
  } catch (error) {
    console.error('Error getting RFI by ID:', error);
    console.error('Stack:', error.stack);
    return null;
  }
}
/**
 * Format date ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input type="date" (YYYY-MM-DD)
 */
function formatDateForInput(date) {
  if (!date) return '';
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QC RFI - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Status = RFI Request Submitted
 */
function updateQCRFI(rfiId, data) {
  try {
    console.log('========== updateQCRFI START ==========');
    console.log('RFI ID:', rfiId);
    console.log('Update data:', JSON.stringify(data));
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    const roleValidation = validateQCRole();
    if (!roleValidation.success) {
      return {
        success: false,
        message: roleValidation.message
      };
    }
    
    // Validation
    if (!rfiId || !data.code || !data.requestDate || !data.startTime || 
        !data.description || !data.location || !data.assignedInspector || 
        !data.requesterEmail || !data.requesterName) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      };
    }
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö RFI_List sheet'
      };
    }
    
    // ‡∏´‡∏≤ row ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    const lastRow = sheet.getLastRow();
    const dataRange = sheet.getRange(2, 1, lastRow - 1, 19).getValues(); // ‡∏î‡∏∂‡∏á A-S
    let rowIndex = -1;
    let currentStatus = '';
    let currentCode = '';
    
    for (let i = 0; i < dataRange.length; i++) {
      if (String(dataRange[i][0]).trim() === rfiId) { // Column A = ID
        rowIndex = i + 2;
        currentStatus = String(dataRange[i][14] || '').trim(); // Column O = Status
        currentCode = String(dataRange[i][8] || '').trim();    // Column I = Code
        break;
      }
    }
    
    if (rowIndex === -1) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö RFI ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'
      };
    }
    
    // ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà required - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô +1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
    let endTime = data.endTime;
    if (!endTime) {
      const startParts = data.startTime.split(':');
      const endHour = parseInt(startParts[0]) + 1;
      endTime = endHour.toString().padStart(2, '0') + ':' + startParts[1];
    }
    
    // Format date
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    const currentTime = new Date();
    
    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï RFI_NO ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    let needUpdateRFINo = false;
    let newRFINo = '';
    
    if (currentStatus === 'RFI Request Submitted' && data.code !== currentCode) {
      // ‡∏ñ‡πâ‡∏≤ Status = RFI Request Submitted ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Code
      // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á RFI_NO ‡πÉ‡∏´‡∏°‡πà
      console.log('Code changed from', currentCode, 'to', data.code);
      const orderRFI = getNextOrderRFI(data.code);
      const orderRFIPadded = String(orderRFI).padStart(4, '0');
      newRFINo = data.code + '-RFI-' + orderRFIPadded;
      needUpdateRFINo = true;
      
      console.log('New RFI_NO:', newRFINo, 'Order:', orderRFI);
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    sheet.getRange(rowIndex, 3).setValue(data.description);           // C - description
    sheet.getRange(rowIndex, 4).setValue(data.location);              // D - Location
    sheet.getRange(rowIndex, 5).setValue(formattedDate);              // E - Request_Date
    sheet.getRange(rowIndex, 6).setValue(data.startTime);             // F - Start_Time
    sheet.getRange(rowIndex, 7).setValue(endTime);                    // G - End_Time
    
    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Code ‡πÅ‡∏•‡∏∞ RFI_NO (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
    if (needUpdateRFINo) {
      const currentOrderRFI = sheet.getRange(rowIndex, 8).getValue(); // H - Order_RFI ‡πÄ‡∏Å‡πà‡∏≤
      const newOrderRFI = getNextOrderRFI(data.code);
      
      sheet.getRange(rowIndex, 2).setValue(newRFINo);               // B - RFI_NO ‡πÉ‡∏´‡∏°‡πà
      sheet.getRange(rowIndex, 8).setValue(newOrderRFI);            // H - Order_RFI ‡πÉ‡∏´‡∏°‡πà
      sheet.getRange(rowIndex, 9).setValue(data.code);              // I - Code ‡πÉ‡∏´‡∏°‡πà
      
      console.log('Updated: RFI_NO =', newRFINo, ', Order_RFI =', newOrderRFI, ', Code =', data.code);
    }
    
    sheet.getRange(rowIndex, 10).setValue(data.requesterEmail);       // J - Requester_Email
    sheet.getRange(rowIndex, 11).setValue(data.requesterName);        // K - Requester_Name
    sheet.getRange(rowIndex, 12).setValue(data.assignedInspector);    // L - Assigned_Inspector
    sheet.getRange(rowIndex, 18).setValue(currentTime);               // R - Updated_Timestamp
    sheet.getRange(rowIndex, 20).setValue(data.requireSurveyReport || 'None');  // T - Require_Survey_Report
    sheet.getRange(rowIndex, 21).setValue(data.requireLabReport || 'None');     // U - Require_Lab_Report
    
    // ‡∏î‡∏∂‡∏á RFI_NO ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πà‡∏≤)
    const finalRFINo = needUpdateRFINo ? newRFINo : sheet.getRange(rowIndex, 2).getValue();
    
    let message = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n';
    message += 'RFI NO: ' + finalRFINo + '\n';
    if (needUpdateRFINo) {
      message += '‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Code ‡∏à‡∏≤‡∏Å ' + currentCode + ' ‚Üí ' + data.code + '\n';
      message += 'üìã RFI NO ‡πÉ‡∏´‡∏°‡πà: ' + finalRFINo + '\n';
    }
    message += '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + data.assignedInspector + '\n';
    message += '‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + data.requesterName + '\n';
    message += '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢: ' + roleValidation.name + ' (' + roleValidation.role + ')';
    
    console.log('========== updateQCRFI SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      rfiNo: finalRFINo
    };
    
  } catch (error) {
    console.error('========== updateQCRFI FAILED ==========');
    console.error('Error:', error);
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

function getRFIListForQC() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('DEBUG: RFI_List sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    console.log('DEBUG: lastRow =', lastRow);
    
    if (lastRow <= 1) {
      console.log('DEBUG: No data rows');
      return [];
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 21).getValues();
    console.log('DEBUG: Total rows =', data.length);
    
    const rfiList = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const id = String(row[0] || '').trim();
      const rfiNo = String(row[1] || '').trim();
      const status = String(row[14] || '').trim();
      
      console.log('DEBUG: Row', i, 'ID:', id, 'RFI_NO:', rfiNo, 'Status:', status);
      
      if (status === 'Draft' || status === 'RFI Request Submitted') {
        console.log('DEBUG: -> MATCHED! Adding to list');
        rfiList.push({
          id: id,
          rfiNo: rfiNo,
          description: String(row[2] || '').trim(),
          location: String(row[3] || '').trim(),
          requestDate: formatDate(new Date(row[4])),
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          code: String(row[8] || '').trim(),
          requesterEmail: String(row[9] || '').trim(),
          requesterName: String(row[10] || '').trim(),
          assignedInspector: String(row[11] || '').trim(),
          status: status,
          type: String(row[18] || '').trim(),
          requireSurveyReport: String(row[19] || '').trim(),
          requireLabReport: String(row[20] || '').trim()
        });
      }
    }
    
    rfiList.sort(function(a, b) {
  if (a.id > b.id) return -1;
  if (a.id < b.id) return 1;
  return 0;
});
    
    console.log('DEBUG: Final list count =', rfiList.length);
    console.log('DEBUG: RFI List =', JSON.stringify(rfiList));
    
    return rfiList;
    
  } catch (error) {
    console.error('ERROR in getRFIListForQC:', error);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠)
 */
function getCurrentUserInfo() {
  try {
    const user = Session.getActiveUser();
    const email = user.getEmail();
    
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å UserProperties ‡∏´‡∏£‡∏∑‡∏≠ ContactsApp
    let displayName = '';
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å UserProperties (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ)
    const userProps = PropertiesService.getUserProperties();
    displayName = userProps.getProperty('displayName') || '';
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    if (!displayName && email) {
      displayName = email.split('@')[0];
      // ‡πÅ‡∏õ‡∏•‡∏á firstname.lastname ‡πÄ‡∏õ‡πá‡∏ô Firstname Lastname
      displayName = displayName.split('.').map(function(word) {
        return word.charAt(0).toUpperCase() + word.slice(1);
      }).join(' ');
    }
    
    return {
      success: true,
      email: email,
      name: displayName
    };
  } catch (error) {
    console.error('Error getting current user info:', error);
    return {
      success: false,
      email: '',
      name: '',
      error: error.toString()
    };
  }
}

// ===== ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Code.gs (‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå) =====
// ‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°: ‡∏°‡∏µ /** ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î multi-line comment ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î
// ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å function ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å comment ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ

/**
 * ‡∏î‡∏∂‡∏á email ‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
 */
function getCurrentUserEmail() {
  try {
    return Session.getActiveUser().getEmail();
  } catch (error) {
    console.error('Error getting current user email:', error);
    return '';
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ RFI ‡∏ó‡∏µ‡πà Status = Inspection Postponed (‡∏£‡∏ß‡∏° Postpone Reason)
 */
function getPostponedRFIList() {
  try {
    console.log('========== Getting Postponed RFI List ==========');

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');

    if (!sheet) {
      console.log('RFI_List sheet not found');
      return [];
    }

    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No data rows');
      return [];
    }

    const data = sheet.getRange(2, 1, lastRow - 1, 36).getValues();
    const postponedList = [];

    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const id = String(row[0] || '').trim();
      const status = String(row[14] || '').trim();

      // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° logging
      if (i < 5) {
        console.log('Row ' + (i + 2) + ': ID=' + id + ', Status="' + status + '"');
      }

      // ‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (case-insensitive + partial match)
      const statusLower = status.toLowerCase();
      const isPostponed = (
        status === 'Inspection Postponed' ||
        statusLower.includes('postpone') ||
        statusLower.includes('‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô') ||
        statusLower === 'postponed'
      );

      if (isPostponed) {
        console.log('‚úÖ Found postponed RFI:', id, 'Status:', status);

        let createdTimestamp = '';
        if (row[15]) {
          try {
            createdTimestamp = new Date(row[15]).toISOString();
          } catch (e) {
            createdTimestamp = String(row[15]);
          }
        }

        postponedList.push({
          id: id,
          rfiNo: String(row[1] || '').trim(),
          description: String(row[2] || '').trim(),
          location: String(row[3] || '').trim(),
          requestDate: formatDate(new Date(row[4])),
          startTime: formatTime(row[5]),
          endTime: formatTime(row[6]),
          code: String(row[8] || '').trim(),
          requesterEmail: String(row[9] || '').trim(),
          requesterName: String(row[10] || '').trim(),
          assignedInspector: String(row[11] || '').trim(),
          status: status,
          createdTimestamp: createdTimestamp,
          postponeReason: String(row[35] || '').trim()
        });
      }
    }

    postponedList.sort(function(a, b) {
      if (!a.createdTimestamp || !b.createdTimestamp) return 0;
      return new Date(b.createdTimestamp).getTime() - new Date(a.createdTimestamp).getTime();
    });

    console.log('Found postponed RFI:', postponedList.length);
    return postponedList;

  } catch (error) {
    console.error('Error getting postponed RFI list:', error);
    return [];
  }
}

/**
 * ‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI (‡∏£‡∏ß‡∏° Postpone Reason ‡∏à‡∏≤‡∏Å Sheet)
 */
function reschedulePostponedRFI(rfiId, data) {
  try {
    console.log('========== reschedulePostponedRFI START ==========');
    console.log('RFI ID:', rfiId);
    console.log('New schedule:', JSON.stringify(data));
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    const roleValidation = validateQCRole();
    if (!roleValidation.success) {
      return {
        success: false,
        message: roleValidation.message
      };
    }
    
    // Validation
    if (!rfiId || !data.requestDate || !data.startTime || !data.assignedInspector) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      };
    }
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö RFI_List sheet'
      };
    }
    
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RFI ‡πÄ‡∏ï‡πá‡∏° (‡∏£‡∏ß‡∏° postponeReason ‡∏à‡∏≤‡∏Å Column AJ)
    const rfiData = getRFIById(rfiId);
    
    if (!rfiData) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö RFI ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à'
      };
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Status = "Inspection Postponed" ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (rfiData.status !== 'Inspection Postponed') {
      return {
        success: false,
        message: 'RFI ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Inspection Postponed (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + rfiData.status + ')'
      };
    }
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì end time (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‡πÉ‡∏ä‡πâ +1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
    let endTime = data.endTime;
    if (!endTime) {
      const startParts = data.startTime.split(':');
      const endHour = parseInt(startParts[0]) + 1;
      endTime = endHour.toString().padStart(2, '0') + ':' + startParts[1];
    }
    
    // Format date
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    const currentTime = new Date();
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    sheet.getRange(rfiData.rowIndex, 5).setValue(formattedDate);              // E - Request_Date
    sheet.getRange(rfiData.rowIndex, 6).setValue(data.startTime);             // F - Start_Time
    sheet.getRange(rfiData.rowIndex, 7).setValue(endTime);                    // G - End_Time
    sheet.getRange(rfiData.rowIndex, 12).setValue(data.assignedInspector);    // L - Assigned_Inspector
    sheet.getRange(rfiData.rowIndex, 15).setValue('Rescheduled ‚Äì Proceed to Site Inspection');             // O - Status ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "Rescheduled ‚Äì Proceed to Site Inspection"
    sheet.getRange(rfiData.rowIndex, 18).setValue(currentTime);               // R - Updated_Timestamp
    
    console.log('Updated RFI at row:', rfiData.rowIndex);
    
    // ========== ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Postpone Calendar Function ==========
    
    let calendarPostponeResult = null;
    
    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ postponeRFIInspection() ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (typeof postponeRFIInspection === 'function') {
      try {
        console.log('========== Calling postponeRFIInspection ==========');
        
        // ‚úÖ ‡πÉ‡∏ä‡πâ postponeReason ‡∏à‡∏≤‡∏Å Sheet (Column AJ)
        const postponeReasonFromSheet = rfiData.postponeReason || '‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö RFI';
        console.log('Using postpone reason from sheet:', postponeReasonFromSheet);
        
        calendarPostponeResult = postponeRFIInspection(
          rfiData.rfiNo,                    // RFI Number
          rfiData.description,              // Description
          data.requestDate,                 // New Date (YYYY-MM-DD)
          data.startTime,                   // New Start Time
          endTime,                          // New End Time
          postponeReasonFromSheet,          // ‚úÖ Postpone Reason ‡∏à‡∏≤‡∏Å Column AJ
          rfiData.requesterEmail,           // Requester Email
          '',                               // Guest Emails (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ)
          rfiData.location,                 // New Location
          data.assignedInspector,           // Assigned Inspector (‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô)
          true,                             // Send Email = true
          60                                // Search Days = 60
        );
        
        console.log('========== Postpone Calendar Result ==========');
        console.log('Success:', calendarPostponeResult.success);
        console.log('Events Updated:', calendarPostponeResult.rfiEventsUpdated);
        console.log('Emails Sent:', calendarPostponeResult.emailsSent);
        
      } catch (calendarError) {
        console.error('‚ö†Ô∏è Error calling postponeRFIInspection:', calendarError);
        console.error('Stack:', calendarError.stack);
        
        // ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏ô‡∏µ‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - ‡πÅ‡∏Ñ‡πà‡πÅ‡∏à‡πâ‡∏á warning
        calendarPostponeResult = {
          success: false,
          message: 'Calendar update failed: ' + calendarError.toString(),
          error: calendarError.toString()
        };
      }
    } else {
      console.log('‚ö†Ô∏è postponeRFIInspection() not found - skipping calendar update');
      calendarPostponeResult = {
        success: false,
        message: 'Calendar integration not available'
      };
    }
    
    // ========== ‚úÖ END: Postpone Calendar Integration ==========
    
    let message = '‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à RFI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n';
    message += 'RFI NO: ' + rfiData.rfiNo + '\n';
    message += '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà: ' + formatDateThai(data.requestDate) + '\n';
    message += '‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà: ' + data.startTime + ' - ' + endTime + ' ‡∏ô.\n';
    message += '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà: ' + data.assignedInspector + '\n';
    message += '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Rescheduled ‚Äì Proceed to Site Inspection';
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Calendar Result
    if (calendarPostponeResult && calendarPostponeResult.success) {
      message += '\n\n‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Calendar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:';
      message += '\n‚Ä¢ Events Updated: ' + calendarPostponeResult.rfiEventsUpdated;
      message += '\n‚Ä¢ Emails Sent: ' + (calendarPostponeResult.emailsSent ? 'Yes' : 'No');
    } else if (calendarPostponeResult && calendarPostponeResult.message) {
      message += '\n\n‚ö†Ô∏è Calendar: ' + calendarPostponeResult.message;
    }
    
    console.log('========== reschedulePostponedRFI SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      rfiNo: rfiData.rfiNo,
      calendarResult: calendarPostponeResult
    };
    
  } catch (error) {
    console.error('========== reschedulePostponedRFI FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

function checkPostponeIntegration() {
  try {
    // ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å function postponeRFIInspection
    if (typeof postponeRFIInspection === 'function') {
      console.log('‚úÖ Postpone Integration: Available');
      return true;
    } else {
      console.log('‚ö†Ô∏è Postpone Integration: Not Found');
      return false;
    }
  } catch (error) {
    console.log('‚ùå Postpone Integration: Error -', error.toString());
    return false;
  }
}

// ========== EXAMPLE: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å qc_postpone.html ==========

/**
 * ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Frontend (qc_postpone.html)
 */
function exampleUsageFromFrontend() {
  // ‡πÉ‡∏ô qc_postpone.html ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  // function handleRescheduleSubmit() ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å reschedulePostponedRFI()
  // ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å postponeRFIInspection() ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  
  const formData = {
    requestDate: '2025-01-20',
    startTime: '14:00',
    endTime: '16:00',
    assignedInspector: 'Survey Team A,Lab Team B'
  };
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô google.script.run
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        console.log('‚úÖ RFI Postponed:', result.message);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏• Calendar Update
        if (result.calendarResult) {
          console.log('Calendar Events Updated:', result.calendarResult.rfiEventsUpdated);
          console.log('Emails Sent:', result.calendarResult.emailsSent);
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Error:', error);
    })
    .reschedulePostponedRFI(rfiId, formData);
}

// ========== TEST FUNCTION ==========

/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Integration
 */
function testPostponeIntegration() {
  console.log('========== TEST: Postpone Integration ==========');
  
  // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ function postponeRFIInspection ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const hasIntegration = checkPostponeIntegration();
  console.log('Has Integration:', hasIntegration);
  
  if (!hasIntegration) {
    console.log('‚ö†Ô∏è Please add "RFI Calendar Cancel Postpone.gs" file first');
    return;
  }
  
  // 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å postponeRFIInspection()
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];
  
  try {
    const result = postponeRFIInspection(
      "TEST-RFI-001",              // RFI Number
      "Test Description",          // Description
      tomorrowStr,                 // New Date
      "14:00",                     // New Start Time
      "16:00",                     // New End Time
      "Testing from RFI System",   // Postpone Reason
      "test@example.com",          // Requester Email
      "",                          // Guest Emails
      "Test Location",             // New Location
      "Survey Team A",             // Assigned Inspector
      false,                       // Send Email = false (for testing)
      30                           // Search Days
    );
    
    console.log('========== TEST RESULT ==========');
    console.log('Success:', result.success);
    console.log('Message:', result.message);
    console.log('Events Found:', result.rfiEventsFound);
    console.log('Events Updated:', result.rfiEventsUpdated);
    console.log('Emails Sent:', result.emailsSent);
    
  } catch (error) {
    console.error('‚ùå Test Error:', error);
  }
}

/**
 * ‚≠ê ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Survey Work Form
 */
function openSurveyWorkForm() {
  const html = HtmlService.createHtmlOutputFromFile('survey_work')
    .setWidth(600)
    .setHeight(800);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'Survey Work Requirement System');
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Activated
 */
function getSurveyTeams() {
  try {
    console.log('Getting Survey teams');
    
    const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!resourceSheet) {
      console.log('Resources sheet not found');
      return [];
    }
    
    const lastRow = resourceSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No resources found');
      return [];
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: A (Resource_ID), B (Resource_Name), C (Sub_Type), D (Team No.), E (Status)
    const data = resourceSheet.getRange(2, 1, lastRow - 1, 5).getValues();
    const teams = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const resourceId = String(row[0] || '').trim();
      const resourceName = String(row[1] || '').trim();
      const subType = String(row[2] || '').trim();
      const teamNo = row[3];
      const status = String(row[4] || '').trim();
      
      // ‚≠ê ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Survey ‡∏ó‡∏µ‡πà Activated
      if (status === 'Activated' && resourceId && subType.toLowerCase() === 'survey') {
        teams.push({
          resourceId: resourceId,
          resourceName: resourceName,
          subType: subType,
          teamNo: teamNo || 999
        });
        console.log('Found Survey team:', resourceId, resourceName, 'Team No:', teamNo);
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Team No.
    teams.sort(function(a, b) {
      return a.teamNo - b.teamNo;
    });
    
    console.log('Total Survey teams found:', teams.length);
    return teams;
    
  } catch (error) {
    console.error('Error getting Survey teams:', error);
    return [];
  }
}

/**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏° Survey ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Survey Work - ‡πÑ‡∏°‡πà‡∏°‡∏µ buffer ¬±30 ‡∏ô‡∏≤‡∏ó‡∏µ)
 */
function isSurveyTeamAvailable(resourceId, date, startTime, endTime) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    if (!sheet) return true;
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return true;
    
    const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
    
    const requestStartMinutes = timeToMinutes(startTime);
    const requestEndMinutes = timeToMinutes(endTime);
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rfiDate = formatDate(new Date(row[4]));           // Column E - Request_Date
      const rfiStartTime = formatTime(row[5]);                // Column F - Start_Time
      const rfiEndTime = formatTime(row[6]);                  // Column G - End_Time
      const assignedTeams = String(row[11] || '').trim();     // Column L - Assigned_Inspector
      const status = String(row[14] || '').trim();            // Column O - Status
      
      if (status.includes('Cancel') || status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')) {
        continue;
      }
      
      if (rfiDate === date) {
        const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
        if (!resourceSheet) continue;
        
        const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
        
        const nameToId = {};
        for (let j = 0; j < resourceData.length; j++) {
          const rid = String(resourceData[j][0] || '').trim();
          const rname = String(resourceData[j][1] || '').trim();
          if (rid && rname) {
            nameToId[rname] = rid;
          }
        }
        
        const teamNamesList = assignedTeams.split(',').map(function(name) {
          return name.trim();
        });
        
        let isThisTeamAssigned = false;
        for (let k = 0; k < teamNamesList.length; k++) {
          const teamName = teamNamesList[k];
          if (nameToId[teamName] === resourceId) {
            isThisTeamAssigned = true;
            break;
          }
        }
        
        if (!isThisTeamAssigned) {
          continue;
        }
        
        const existingStartMinutes = timeToMinutes(rfiStartTime);
        const existingEndMinutes = timeToMinutes(rfiEndTime);
        
        // ‚≠ê ‡πÑ‡∏°‡πà‡∏°‡∏µ buffer - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
        const isAvailable = (requestEndMinutes <= existingStartMinutes) || 
                           (requestStartMinutes >= existingEndMinutes);
        
        if (!isAvailable) {
          console.log('Survey Team ' + resourceId + ' is NOT available');
          return false;
        }
      }
    }
    
    return true;
    
  } catch (error) {
    console.error('Error checking Survey team availability:', error);
    return false;
  }
}

/**
 * ‚úÖ FINAL: ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° Survey ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - Load Balanced
 */
function assignSurveyTeamAutomatically(date, startTime, endTime, useCache) {
  try {
    // Set default value
    if (typeof useCache === 'undefined') useCache = false;
    
    console.log('========== Auto-assigning Survey team (Load Balanced) ==========');
    console.log('Date:', date);
    console.log('Time:', startTime, '-', endTime);
    console.log('Use Cache:', useCache);
    
    const teams = getSurveyTeams();
    
    if (teams.length === 0) {
      return {
        success: false,
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏° Survey ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'
      };
    }
    
    // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏° workload + Round Robin
    const sortedTeams = sortTeamsByWorkload(teams, date, useCache);
    
    // ‡∏´‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
    for (let i = 0; i < sortedTeams.length; i++) {
      const team = sortedTeams[i];
      
      if (isSurveyTeamAvailable(team.resourceId, date, startTime, endTime)) {
        console.log('‚úÖ Selected Survey team:', team.resourceName, '(Workload:', team.workload + ')');
        
        // ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï cache (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
        if (useCache) {
          incrementWorkloadCache(team.resourceId, date);
          LAST_SELECTED_TEAM[team.subType + '_' + date] = team.resourceId;
        }
        
        return {
          success: true,
          teamName: team.resourceName,
          resourceId: team.resourceId,
          teamNo: team.teamNo,
          workload: team.workload
        };
      }
    }
    
    return {
      success: false,
      message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏° Survey ‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'
    };
    
  } catch (error) {
    console.error('Error in assignSurveyTeamAutomatically:', error);
    console.error('Stack:', error.stack);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°: ' + error.toString()
    };
  }
}

/**
 * ‚ö° UPDATED: Survey Available Time Slots (Optimized)
 * ‚úÖ ‡∏£‡∏±‡∏Å‡∏©‡∏≤ function signature ‡πÄ‡∏î‡∏¥‡∏°
 */
function getSurveyAvailableTimeSlots(date) {
  try {
    if (!date) return [];
    
    const now = new Date();
    const selectedDate = new Date(date + 'T00:00:00');
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á all slots
    const allSlots = [];
    for (let hour = 9; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 19 && minute === 30) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allSlots.push(time);
      }
    }
    
    let filteredSlots = allSlots.slice();
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ + 30 ‡∏ô‡∏≤‡∏ó‡∏µ
    if (selectedDateOnly.getTime() === today.getTime()) {
      const minTime = new Date(now.getTime() + (30 * 60 * 1000));
      
      filteredSlots = allSlots.filter(function(slot) {
        const slotTime = new Date(selectedDate);
        const timeParts = slot.split(':');
        slotTime.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0, 0);
        return slotTime > minTime;
      });
    } else if (selectedDateOnly < today) {
      return [];
    }
    
    const availableTeams = getSurveyTeams();
    
    if (availableTeams.length === 0) {
      return [];
    }
    
    // ‚ö° Cache blocked slots
    const blockedSlots = getBlockedTimeSlotsForTeams(date, availableTeams);
    
    const availableSlots = [];
    
    for (let i = 0; i < filteredSlots.length; i++) {
      const startSlot = filteredSlots[i];
      
      const startParts = startSlot.split(':');
      const startHour = parseInt(startParts[0]);
      const startMin = parseInt(startParts[1]);
      const endHour = startMin === 30 ? startHour + 1 : startHour;
      const endMin = startMin === 30 ? 0 : 30;
      const endSlot = endHour.toString().padStart(2, '0') + ':' + endMin.toString().padStart(2, '0');
      
      const requestStartMinutes = timeToMinutes(startSlot);
      const requestEndMinutes = timeToMinutes(endSlot);
      
      // ‚ö° ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å cached data (‡πÑ‡∏°‡πà‡∏°‡∏µ buffer)
      let hasAvailableTeam = false;
      
      for (let j = 0; j < availableTeams.length; j++) {
        const team = availableTeams[j];
        const blocks = blockedSlots[team.resourceId] || [];
        
        let isAvailable = true;
        
        for (let k = 0; k < blocks.length; k++) {
          const block = blocks[k];
          // ‡πÑ‡∏°‡πà‡∏°‡∏µ buffer - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
          if (!(requestEndMinutes <= block.start || requestStartMinutes >= block.end)) {
            isAvailable = false;
            break;
          }
        }
        
        if (isAvailable) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        availableSlots.push(startSlot);
      }
    }
    
    return availableSlots;
    
  } catch (error) {
    console.error('Error in getSurveyAvailableTimeSlots:', error);
    return [];
  }
}

/**
 * ‚ö° UPDATED: Survey Available End Times (Optimized)
 * ‚úÖ ‡∏£‡∏±‡∏Å‡∏©‡∏≤ function signature ‡πÄ‡∏î‡∏¥‡∏°
 */
function getSurveyAvailableEndTimes(date, startTime) {
  try {
    if (!startTime || !date) return [];
    
    const allEndSlots = [];
    for (let hour = 9; hour <= 20; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 9 && minute === 0) continue;
        if (hour === 20 && minute > 0) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allEndSlots.push(time);
      }
    }
    
    const startMinutes = timeToMinutes(startTime);
    const availableTeams = getSurveyTeams();
    
    if (availableTeams.length === 0) {
      return [];
    }
    
    // ‚ö° Cache blocked slots
    const blockedSlots = getBlockedTimeSlotsForTeams(date, availableTeams);
    
    const availableEndTimes = [];
    
    for (let i = 0; i < allEndSlots.length; i++) {
      const endSlot = allEndSlots[i];
      const endMinutes = timeToMinutes(endSlot);
      
      if (endMinutes <= startMinutes) continue;
      
      // ‚ö° ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å cached data (‡πÑ‡∏°‡πà‡∏°‡∏µ buffer)
      let hasAvailableTeam = false;
      
      for (let j = 0; j < availableTeams.length; j++) {
        const team = availableTeams[j];
        const blocks = blockedSlots[team.resourceId] || [];
        
        let isAvailable = true;
        
        for (let k = 0; k < blocks.length; k++) {
          const block = blocks[k];
          if (!(endMinutes <= block.start || startMinutes >= block.end)) {
            isAvailable = false;
            break;
          }
        }
        
        if (isAvailable) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        availableEndTimes.push(endSlot);
      } else {
        break;
      }
    }
    
    return availableEndTimes;
    
  } catch (error) {
    console.error('Error in getSurveyAvailableEndTimes:', error);
    return [];
  }
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á Available End Times ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Survey Work
 */
function getSurveyAvailableEndTimes(date, startTime) {
  try {
    if (!startTime || !date) return [];
    
    const allEndSlots = [];
    for (let hour = 9; hour <= 20; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 9 && minute === 0) continue;
        if (hour === 20 && minute > 0) break;
        const time = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        allEndSlots.push(time);
      }
    }
    
    const startMinutes = timeToMinutes(startTime);
    
    // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏° Survey ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const availableTeams = getSurveyTeams();
    
    if (availableTeams.length === 0) {
      return [];
    }
    
    // ‡∏´‡∏≤ end time ‡∏ó‡∏µ‡πà‡πÑ‡∏Å‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á
    const availableEndTimes = [];
    
    for (let i = 0; i < allEndSlots.length; i++) {
      const endSlot = allEndSlots[i];
      const endMinutes = timeToMinutes(endSlot);
      
      if (endMinutes <= startMinutes) continue;
      
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á startTime - endSlot ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      let hasAvailableTeam = false;
      
      for (let j = 0; j < availableTeams.length; j++) {
        if (isSurveyTeamAvailable(availableTeams[j].resourceId, date, startTime, endSlot)) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        availableEndTimes.push(endSlot);
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡πà‡∏≠
        break;
      }
    }
    
    return availableEndTimes;
    
  } catch (error) {
    console.error('Error in getSurveyAvailableEndTimes:', error);
    return [];
  }
}


function saveSurveyWorkRequirement(data) {
  try {
    console.log('========== saveSurveyWorkRequirement START ==========');
    console.log('Input data:', JSON.stringify(data));


    
    // Validation
    if (!data.requestDate || !data.startTime || !data.endTime || 
        !data.workType || !data.description || !data.location || 
        !data.requesterName || !data.requesterEmail) {
      return {
        success: false,
        message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      };
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å User sheet
    
    const userValidation = validateAndGetUser(data.requesterEmail, data.requesterName);
    
    if (!userValidation.success) {
      console.log('User validation failed:', userValidation.message);
      return {
        success: false,
        message: userValidation.message
      };
    }
    
    console.log('User validation success:', userValidation);
    
    const validatedEmail = userValidation.email;
    const validatedName = userValidation.name;
    
// ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° Survey ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
const teamAssignment = assignSurveyTeamAutomatically(
  data.requestDate, 
  data.startTime, 
  data.endTime,
  false    // useCache = false (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á)
);

// ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ
if (!teamAssignment) {
  console.error('teamAssignment is undefined!');
  return {
    success: false,
    message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ'
  };
}
    
    if (!teamAssignment.success) {
      console.log('Team assignment failed:', teamAssignment.message);
      return {
        success: false,
        message: teamAssignment.message
      };
    }
    
    console.log('Survey team assigned:', teamAssignment);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Unique ID
    const rfiId = generateUniqueId();
    console.log('Generated ID:', rfiId);
    
    // ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Order_Survey ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Survey_NO
    const orderSurvey = getNextOrderSurvey();
    console.log('Order Survey:', orderSurvey);
    
    const orderSurveyPadded = String(orderSurvey).padStart(4, '0');
    const surveyNo = 'SW-' + orderSurveyPadded;
    console.log('Survey NO:', surveyNo);
    
    // ‡∏î‡∏∂‡∏á Sheet
    let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('RFI_List sheet not found, creating new one...');
      sheet = createRFIListSheet();
    }
    
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    const currentTime = new Date();
    
    console.log('Adding data to sheet at row:', nextRow);
    
    const combinedDescription = data.workType + ' - ' + data.description;
    console.log('Combined description:', combinedDescription);
    
    // Format date
    const dateParts = data.requestDate.split('-');
    const formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const rowData = [];
    for (let i = 0; i < 40; i++) {
      rowData.push('');
    }
    
    rowData[0] = rfiId;
    rowData[1] = surveyNo;                       // ‚≠ê B - Survey_NO
    rowData[2] = combinedDescription;
    rowData[3] = data.location;
    rowData[4] = formattedDate;
    rowData[5] = data.startTime;
    rowData[6] = data.endTime;
    rowData[7] = orderSurvey;                    // ‚≠ê H - Order_Survey
    rowData[9] = validatedEmail;
    rowData[10] = validatedName;
    rowData[11] = teamAssignment.teamName;
    rowData[14] = 'Survey Work Request Submitted';
    rowData[15] = currentTime;
    rowData[39] = 'Survey Work';
    
    console.log('Row data prepared');
    
    sheet.getRange(nextRow, 1, 1, 40).setValues([rowData]);
    console.log('Data added to sheet successfully');
    
    // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event
    let calendarResult = null;
    try {
      console.log('Creating Calendar Event...');
      
      const calendarData = {
        requestDate: data.requestDate,
        startTime: data.startTime,
        endTime: data.endTime,
        description: combinedDescription,
        location: data.location,
        requesterName: validatedName,
        requesterEmail: validatedEmail,
        assignedTeam: teamAssignment.teamName
      };
      
      calendarResult = createSurveyWorkCalendarEvent(calendarData, rfiId, surveyNo);  // ‚≠ê ‡∏™‡πà‡∏á surveyNo
      
      if (calendarResult.success) {
        console.log('‚úÖ Calendar Event Created Successfully');
        console.log('Event ID:', calendarResult.eventId);
        console.log('Guests:', calendarResult.guestsCount);
      } else {
        console.log('‚ö†Ô∏è Calendar Event Creation Failed:', calendarResult.message);
      }
      
    } catch (calendarError) {
      console.error('‚ö†Ô∏è Calendar Error:', calendarError);
      calendarResult = {
        success: false,
        error: calendarError.toString()
      };
    }
    
    // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    let emailSent = false;
    try {
      const emailData = {
        requestDate: data.requestDate,
        startTime: data.startTime,
        endTime: data.endTime,
        description: combinedDescription,
        location: data.location,
        requesterName: validatedName,
        requesterEmail: validatedEmail,
        assignedTeam: teamAssignment.teamName,
        teamCategory: 'Survey Work'
      };
      emailSent = sendSurveyWorkNotificationEmail(emailData, rfiId, surveyNo);  // ‚≠ê ‡∏™‡πà‡∏á surveyNo
      console.log('Email sent:', emailSent);
    } catch (emailError) {
      console.error('Failed to send email:', emailError);
    }
    
    let message = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Survey Work Request ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
    message += '\nüìã Survey NO: ' + surveyNo;  // ‚≠ê ‡πÅ‡∏™‡∏î‡∏á Survey NO
    message += '\nüë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + teamAssignment.teamName;
    
    if (!userValidation.exists) {
      message += '\n‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß';
    }
    
    // ‚≠ê ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar
    if (calendarResult && calendarResult.success) {
      message += '\n‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÅ‡∏•‡πâ‡∏ß (Guests: ' + calendarResult.guestsCount + ' ‡∏Ñ‡∏ô)';
    } else if (calendarResult) {
      message += '\n‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÑ‡∏î‡πâ';
    }
    
    if (emailSent) {
      message += '\n‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏° Survey ‡πÅ‡∏•‡πâ‡∏ß';
    }
    
    console.log('========== saveSurveyWorkRequirement SUCCESS ==========');
    
    return {
      success: true,
      message: message,
      rfiId: rfiId,
      surveyNo: surveyNo,  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°
      emailSent: emailSent,
      calendarCreated: calendarResult ? calendarResult.success : false,
      calendarEventId: calendarResult && calendarResult.success ? calendarResult.eventId : null,
      userAdded: !userValidation.exists,
      assignedTeam: teamAssignment.teamName
    };
    
  } catch (error) {
    console.error('========== saveSurveyWorkRequirement FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}
/**
 * ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢: ‡∏´‡∏≤ Survey Work Calendar ID
 * (‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏≤ Calendar ID ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
 */
function findSurveyWorkCalendar() {
  try {
    const calendars = CalendarApp.getAllCalendars();
    
    console.log('========== All Calendars ==========');
    for (let i = 0; i < calendars.length; i++) {
      const cal = calendars[i];
      console.log(i + 1 + '. ' + cal.getName());
      console.log('   ID: ' + cal.getId());
      console.log('   Color: ' + cal.getColor());
      console.log('');
    }
    console.log('===================================');
    
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ Calendar ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Survey
    for (let i = 0; i < calendars.length; i++) {
      const cal = calendars[i];
      const name = cal.getName().toLowerCase();
      
      if (name.includes('survey')) {
        console.log('‚úÖ Found Survey Calendar:');
        console.log('Name:', cal.getName());
        console.log('ID:', cal.getId());
        return cal.getId();
      }
    }
    
    console.log('‚ö†Ô∏è No Survey Calendar found - using primary calendar');
    return 'primary';
    
  } catch (error) {
    console.error('Error finding Survey Calendar:', error);
    return 'primary';
  }
}


// ===== Survey Work - Email & Calendar Functions =====
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Code.gs

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á Email List ‡∏Ç‡∏≠‡∏á Survey Team (Role = "Survey" ‡∏´‡∏£‡∏∑‡∏≠ "Survey Reviewer")
 */
function getSurveyEmailList() {
  try {
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found');
      return [];
    }
    
    const lastRow = userSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('No data in User sheet');
      return [];
    }
    
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    const emailList = [];
    
    for (let i = 0; i < data.length; i++) {
      const email = String(data[i][0] || '').trim();
      const displayName = String(data[i][1] || '').trim();
      const role = String(data[i][2] || '').trim();
      const status = String(data[i][3] || '').trim();
      
      // ‚≠ê ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Role = "Survey" ‡∏´‡∏£‡∏∑‡∏≠ "Survey Reviewer" ‡πÅ‡∏•‡∏∞ Status = "Activated"
      if ((role === 'Survey' || role === 'Survey Reviewer') && 
          status === 'Activated' && 
          email && email.includes('@')) {
        emailList.push({
          email: email,
          name: displayName,
          role: role
        });
      }
    }
    
    console.log('Found Survey team emails:', emailList.length);
    return emailList;
    
  } catch (error) {
    console.error('Error getting Survey email list:', error);
    return [];
  }
}

function createSurveyWorkCalendarEvent(data, rfiId, surveyNo) {
  try {
    console.log('========== Creating Survey Work Calendar Event ==========');
    console.log('RFI ID:', rfiId);
    console.log('Data:', JSON.stringify(data));
    
    // ‚≠ê ‡πÉ‡∏™‡πà Calendar ID ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ
    const CENTRAL_CALENDAR_ID = '6cbf6620e2630d70b763e8fe7f04d40b59d13da14a4c39cbb17687c69778b135@group.calendar.google.com';
    
    console.log('üîç Using Central Calendar ID:', CENTRAL_CALENDAR_ID);
    
    let calendar;
    
    try {
      calendar = CalendarApp.getCalendarById(CENTRAL_CALENDAR_ID);
      
      if (!calendar) {
        console.log('‚ùå Cannot access Central Calendar');
        console.log('‚ö†Ô∏è Falling back to user calendar');
        calendar = CalendarApp.getDefaultCalendar();
      } else {
        console.log('‚úÖ Using Central Calendar:', calendar.getName());
        console.log('‚úÖ Owner:', calendar.getOwnerEmail());
      }
      
    } catch (calError) {
      console.log('‚ùå Error accessing Central Calendar:', calError.message);
      console.log('‚ö†Ô∏è User may not have access - check calendar sharing');
      console.log('‚ö†Ô∏è Falling back to user calendar');
      calendar = CalendarApp.getDefaultCalendar();
    }
    
    // ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° - ‡∏™‡∏£‡πâ‡∏≤‡∏á Event
    const dateParts = data.requestDate.split('-');
    const year = parseInt(dateParts[0]);
    const month = parseInt(dateParts[1]) - 1;
    const day = parseInt(dateParts[2]);
    
    const startTimeParts = data.startTime.split(':');
    const startHour = parseInt(startTimeParts[0]);
    const startMinute = parseInt(startTimeParts[1]);
    
    const endTimeParts = data.endTime.split(':');
    const endHour = parseInt(endTimeParts[0]);
    const endMinute = parseInt(endTimeParts[1]);
    
    const startDateTime = new Date(year, month, day, startHour, startMinute, 0);
    const endDateTime = new Date(year, month, day, endHour, endMinute, 0);
    
    const eventTitle = 'üó∫Ô∏è Survey Work: ' + surveyNo + ' - ' + data.assignedTeam;
    
    const description = 
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
      'üó∫Ô∏è SURVEY WORK REQUEST\n' +
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n' +
      'Survey NO: ' + surveyNo + '\n' +
      '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô: ' + data.assignedTeam + '\n' +
      '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ' + data.description + '\n' +
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ' + data.location + '\n\n' +
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
      '‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + data.requesterName + '\n' +
      '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠: ' + data.requesterEmail + '\n' +
      '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' + formatDateThai(data.requestDate) + '\n' +
      '‡πÄ‡∏ß‡∏•‡∏≤: ' + data.startTime + ' - ' + data.endTime + ' ‡∏ô.\n\n' +
      '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: Survey Work\n' +
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: Survey Work Request Submitted\n\n' +
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
      '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢: Survey Work Requirement System\n' +
      '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á: ' + new Date().toLocaleString('th-TH') + '\n' +
      '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
    
    const guestList = [];
    
    if (data.requesterEmail && data.requesterEmail.includes('@')) {
      guestList.push(data.requesterEmail);
      console.log('Added Requester:', data.requesterEmail);
    }
    
    const surveyTeamEmails = getSurveyEmailList();
    surveyTeamEmails.forEach(function(member) {
      if (guestList.indexOf(member.email) === -1) {
        guestList.push(member.email);
        console.log('Added Survey Team Member:', member.email, '(' + member.role + ')');
      }
    });
    
    if (data.assignedTeam) {
      const teamEmails = getTeamEmailsByTeamNames(data.assignedTeam);
      teamEmails.forEach(function(teamMember) {
        if (guestList.indexOf(teamMember.email) === -1) {
          guestList.push(teamMember.email);
          console.log('Added team member:', teamMember.name, '->', teamMember.email);
        }
      });
    }
    
    console.log('Total guests:', guestList.length);
    
    const event = calendar.createEvent(
      eventTitle,
      startDateTime,
      endDateTime,
      {
        description: description,
        location: data.location,
        guests: guestList.join(','),
        sendInvites: true
      }
    );
    
    try {
      event.setColor(CalendarApp.EventColor.GREEN);
    } catch (colorError) {
      console.log('Could not set event color:', colorError.message);
    }
    
    console.log('‚úÖ Calendar Event Created:', event.getId());
    console.log('Event Title:', eventTitle);
    console.log('Calendar Owner:', calendar.getOwnerEmail());
    console.log('Start:', startDateTime);
    console.log('End:', endDateTime);
    console.log('Guests:', guestList.join(', '));
    console.log('========== Calendar Event Creation Complete ==========');
    
    return {
      success: true,
      eventId: event.getId(),
      eventTitle: eventTitle,
      guestsCount: guestList.length,
      guests: guestList,
      calendarOwner: calendar.getOwnerEmail()
    };
    
  } catch (error) {
    console.error('========== Calendar Event Creation FAILED ==========');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    return {
      success: false,
      error: error.toString(),
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÑ‡∏î‡πâ: ' + error.toString()
    };
  }
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á Survey Work ‡πÑ‡∏õ‡∏´‡∏≤ Survey Team
 */
function sendSurveyWorkNotificationEmail(data, rfiId, surveyNo) {
  try {
    console.log('========== START: sendSurveyWorkNotificationEmail ==========');
    
    const quota = checkEmailQuota();
    if (quota <= 1) {
      console.log('Email quota too low:', quota);
      return false;
    }
    
    const emailList = getSurveyEmailList();
    
    if (emailList.length === 0) {
      console.log('No Survey team email recipients found');
      return false;
    }
    
    const recipients = emailList.map(function(e) { return e.email; });
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Requester Email
    if (data.requesterEmail && 
        data.requesterEmail.includes('@') && 
        !recipients.includes(data.requesterEmail)) {
      recipients.push(data.requesterEmail);
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Team Emails
    if (data.assignedTeam) {
      const teamEmails = getTeamEmailsByTeamNames(data.assignedTeam);
      teamEmails.forEach(function(teamMember) {
        if (!recipients.includes(teamMember.email)) {
          recipients.push(teamMember.email);
          console.log('Added team member:', teamMember.name, '->', teamMember.email);
        }
      });
    }
    
    console.log('Sending to:', recipients.length, 'recipients');
    console.log('Recipients:', recipients.join(', '));
    
    // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å createSurveyWorkEmailHTML ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á surveyNo
    const emailHtml = createSurveyWorkEmailHTML(data, rfiId, surveyNo);
    
    const sent = safeSendEmail({
      to: recipients.join(','),
      subject: 'üó∫Ô∏è Survey Work Request ‡πÉ‡∏´‡∏°‡πà [ID: ' + surveyNo + ']',
      htmlBody: emailHtml,
      name: 'Survey Work Requirement System'
    });
    
    console.log('Email result:', sent);
    return sent;
    
  } catch (error) {
    console.error('Error in sendSurveyWorkNotificationEmail:', error);
    return false;
  }
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• Survey Work (‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
 */
/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• Survey Work (‡πÄ‡∏û‡∏¥‡πà‡∏° parameter surveyNo)
 */
function createSurveyWorkEmailHTML(data, rfiId, surveyNo) {  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter
  const emailBody = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { color: #16a34a; }
.id-badge { 
  display: inline-block;
  background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
  color: white;
  padding: 5px 12px;
  border-radius: 5px;
  font-weight: bold;
  font-size: 16px;
  margin-bottom: 15px;
}
table { border-collapse: collapse; width: 100%; }
td, th { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #ecfdf5; }
.status-badge {
  display: inline-block;
  background: #22c55e;
  color: white;
  padding: 3px 8px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: bold;
}
.highlight {
  background: #ecfdf5;
  padding: 10px;
  border-left: 4px solid #16a34a;
  margin: 15px 0;
  border-radius: 5px;
}
</style>
</head>
<body>
<h2>üó∫Ô∏è ‡πÅ‡∏à‡πâ‡∏á Survey Work Request ‡πÉ‡∏´‡∏°‡πà</h2>
<div class="id-badge">Survey NO: ${surveyNo}</div>
<p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ó‡∏µ‡∏° Survey</p>
<p>‡∏°‡∏µ Survey Work Request ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>

<div class="highlight">
  <strong>üìÖ Calendar Event</strong><br>
  ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á invitation ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Calendar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
</div>

<h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Survey Work</h3>
<table>
<tr><th>Survey NO</th><td><strong>${surveyNo}</strong></td></tr>
<tr><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><td>${data.description}</td></tr>
<tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><td>${data.location}</td></tr>
<tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</th><td>${formatDateThai(data.requestDate)}</td></tr>
<tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><td>${data.startTime} - ${data.endTime} ‡∏ô.</td></tr>
<tr><th>‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ</th><td><strong style="color: #16a34a;">${data.assignedTeam}</strong> (Survey Team)</td></tr>
<tr><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td>${data.requesterName}</td></tr>
${data.requesterEmail ? '<tr><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><td>' + data.requesterEmail + '</td></tr>' : ''}
<tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><td><span class="status-badge">Survey Work Request Submitted</span></td></tr>
</table>

<div class="highlight">
  <strong>‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</strong><br>
  1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Calendar Event ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö<br>
  2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (Accept/Decline)<br>
  3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô<br>
  4. ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
</div>

<hr>
<p><small>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Survey Work Requirement ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small></p>
<p><small>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${new Date().toLocaleString('th-TH')}</small></p>
</body>
</html>`;
  
  return emailBody;
}


// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏° Survey
function testGetSurveyTeams() {
  const teams = getSurveyTeams();
  console.log('Survey Teams:', teams);
}

// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Available Slots
function testSurveySlots() {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const date = tomorrow.toISOString().split('T')[0];
  
  const slots = getSurveyAvailableTimeSlots(date);
  console.log('Available slots:', slots);
}

// ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "Cancel RFI Request Submitted" =====
// ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Code.gs ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö

/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Status ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "Cancel" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
function testCancelStatuses() {
  console.log('========== Test Cancel Statuses ==========');
  
  const cancelStatuses = [
    'Cancel',
    'Cancelled',
    'Cancel RFI Request Submitted',        // ‚≠ê ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ IGNORED
    'RFI Request Cancelled',
    'Cancelled by User',
    'Auto-Cancelled',
    'Pre-Cancelled',
    'Cancellation Requested',
    'Pending Cancellation'
  ];
  
  cancelStatuses.forEach(function(status) {
    const result = isStatusInactive(status);
    const icon = result ? '‚úÖ' : '‚ùå';
    const text = result ? 'IGNORED (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)' : 'BLOCKS (‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!)';
    
    console.log(icon + ' ' + status + ' ‚Üí ' + text);
  });
  
  console.log('==========================================');
}

/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Status ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "Cancel" ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å IGNORED
 */
function testNonCancelStatuses() {
  console.log('========== Test Non-Cancel Statuses ==========');
  
  const nonCancelStatuses = [
    'Draft',
    'RFI Request Submitted',
    'Survey Work Request Submitted',
    'In Progress',
    'Approved',
    'Rescheduled ‚Äì Proceed to Site Inspection',
    'Inspection Postponed'
  ];
  
  nonCancelStatuses.forEach(function(status) {
    const result = isStatusInactive(status);
    const icon = result ? '‚ùå' : '‚úÖ';
    const text = result ? 'IGNORED (‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!)' : 'BLOCKS (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)';
    
    console.log(icon + ' ' + status + ' ‚Üí ' + text);
  });
  
  console.log('==============================================');
}

/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Case-Insensitive (‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà)
 */
function testCaseInsensitive() {
  console.log('========== Test Case Insensitive ==========');
  
  const mixedCaseStatuses = [
    'CANCEL RFI REQUEST SUBMITTED',        // ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    'Cancel RFI Request Submitted',        // Mixed Case
    'cancel rfi request submitted',        // ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    'CaNcEl RfI ReQuEsT SuBmItTeD'        // ‡∏™‡∏•‡∏±‡∏ö
  ];
  
  mixedCaseStatuses.forEach(function(status) {
    const result = isStatusInactive(status);
    const icon = result ? '‚úÖ' : '‚ùå';
    const text = result ? 'IGNORED (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)' : 'BLOCKS (‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!)';
    
    console.log(icon + ' "' + status + '" ‚Üí ' + text);
  });
  
  console.log('==========================================');
}

/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡∏°
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö
 */
function testTeamBookingScenario() {
  console.log('========== Test Team Booking Scenario ==========');
  console.log('');
  console.log('‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: ‡∏ó‡∏µ‡∏° Survey Team A ‡∏°‡∏µ RFI ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ');
  console.log('');
  
  const scenarios = [
    {
      rfiId: 'RFI001',
      status: 'RFI Request Submitted',
      date: '2025-01-15',
      time: '10:00-12:00',
      shouldBlock: true
    },
    {
      rfiId: 'RFI002',
      status: 'Cancel RFI Request Submitted',  // ‚≠ê
      date: '2025-01-15',
      time: '13:00-15:00',
      shouldBlock: false
    },
    {
      rfiId: 'RFI003',
      status: 'Completed',
      date: '2025-01-15',
      time: '15:00-17:00',
      shouldBlock: false
    }
  ];
  
  console.log('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2025-01-15 ‡πÄ‡∏ß‡∏•‡∏≤ 14:00-16:00');
  console.log('');
  
  scenarios.forEach(function(scenario) {
    const isInactive = isStatusInactive(scenario.status);
    const willBlock = !isInactive;
    const icon = willBlock === scenario.shouldBlock ? '‚úÖ' : '‚ùå';
    
    console.log(icon + ' ' + scenario.rfiId + ' (' + scenario.status + ')');
    console.log('   ‡πÄ‡∏ß‡∏•‡∏≤: ' + scenario.time);
    console.log('   ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞ Block: ' + (scenario.shouldBlock ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà'));
    console.log('   ‡∏à‡∏£‡∏¥‡∏á: ' + (willBlock ? 'Block' : '‡πÑ‡∏°‡πà Block'));
    console.log('   ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ' + (willBlock === scenario.shouldBlock ? '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
    console.log('');
  });
  
  console.log('‡∏™‡∏£‡∏∏‡∏õ:');
  console.log('‚Ä¢ RFI001 (RFI Request Submitted) ‚Üí ‡∏à‡∏∞ Block ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á');
  console.log('‚Ä¢ RFI002 (Cancel RFI Request Submitted) ‚Üí ‡πÑ‡∏°‡πà Block ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‚úÖ');
  console.log('‚Ä¢ RFI003 (Completed) ‚Üí ‡πÑ‡∏°‡πà Block ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á');
  console.log('');
  console.log('‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á 14:00-16:00 ‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞:');
  console.log('‚Ä¢ RFI001 ‡∏à‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 12:00 (‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ 14:00)');
  console.log('‚Ä¢ RFI002 ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö)');
  console.log('‚Ä¢ RFI003 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö)');
  console.log('===============================================');
}

/**
 * ‡∏£‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
function runAllCancelTests() {
  console.log('\n\n');
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë   ‡∏£‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö "Cancel RFI Request Submitted"   ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  console.log('\n');
  
  testCancelStatuses();
  console.log('\n');
  
  testNonCancelStatuses();
  console.log('\n');
  
  testCaseInsensitive();
  console.log('\n');
  
  testTeamBookingScenario();
  console.log('\n');
  
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë            ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‚úÖ                ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
}

/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á "Cancel RFI Request Submitted"
 */
function testCancelRFIRequestSubmitted() {
  console.log('========== Test "Cancel RFI Request Submitted" ==========');
  
  const status = 'Cancel RFI Request Submitted';
  const result = isStatusInactive(status);
  
  console.log('Status: "' + status + '"');
  console.log('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ' + (result ? 'IGNORED ‚úÖ' : 'BLOCKS ‚ùå'));
  console.log('‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ' + (result ? 
    '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡∏ó‡∏µ‡∏°‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å Block ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ RFI ‡∏ô‡∏µ‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : 
    '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î - ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞ IGNORED ‡πÅ‡∏ï‡πà‡∏Å‡∏•‡∏±‡∏ö BLOCKS ‡∏≠‡∏¢‡∏π‡πà'));
  
  if (result) {
    console.log('');
    console.log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
    console.log('   Status ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "Cancel" ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å IGNORED ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
  } else {
    console.log('');
    console.log('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!');
    console.log('   ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô isStatusInactive()');
  }
  
  console.log('========================================================');
}

/**
 * ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á Sub Calendar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Survey Work
 */
function createSurveyWorkCalendar() {
  try {
    console.log('========== Creating Survey Work Calendar ==========');
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Calendar ‡∏ä‡∏∑‡πà‡∏≠ "Survey Work" ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const calendars = CalendarApp.getAllCalendars();
    
    for (let i = 0; i < calendars.length; i++) {
      if (calendars[i].getName() === 'Survey Work') {
        console.log('‚úÖ Survey Work Calendar already exists');
        console.log('Calendar ID:', calendars[i].getId());
        return calendars[i];
      }
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar ‡πÉ‡∏´‡∏°‡πà
    const calendar = CalendarApp.createCalendar('Survey Work', {
      summary: 'Calendar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Survey Work Requests',
      color: CalendarApp.Color.GREEN,
      hidden: false
    });
    
    console.log('‚úÖ Survey Work Calendar Created');
    console.log('Name:', calendar.getName());
    console.log('ID:', calendar.getId());
    console.log('Color:', calendar.getColor());
    console.log('==================================================');
    
    // ‡πÅ‡∏™‡∏î‡∏á Dialog ‡∏û‡∏£‡πâ‡∏≠‡∏° Calendar ID
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‡∏™‡∏£‡πâ‡∏≤‡∏á Survey Work Calendar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
      'Calendar Name: Survey Work\n' +
      'Calendar ID: ' + calendar.getId() + '\n\n' +
      '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥ Calendar ID ‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô createSurveyWorkCalendarEvent()\n' +
      '‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á SURVEY_WORK_CALENDAR_ID',
      ui.ButtonSet.OK
    );
    
    return calendar;
    
  } catch (error) {
    console.error('Error creating Survey Work Calendar:', error);
    
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Survey Work Calendar ‡πÑ‡∏î‡πâ\n\n' +
      'Error: ' + error.toString(),
      ui.ButtonSet.OK
    );
    
    throw error;
  }
}

function testColumnAN() {
  try {
    console.log('========== Test Column AN ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('‚ùå RFI_List sheet not found');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ùå No data rows');
      return;
    }
    
    // ‡∏î‡∏∂‡∏á Column A (ID), Column O (Status), Column AN (Type)
    const data = sheet.getRange(2, 1, lastRow - 1, 1).getValues();        // Column A
    const statusData = sheet.getRange(2, 15, lastRow - 1, 1).getValues(); // Column O
    const typeData = sheet.getRange(2, 40, lastRow - 1, 1).getValues();   // Column AN
    
    console.log('Total Records:', lastRow - 1);
    console.log('');
    
    let rfiWorkCount = 0;
    let surveyWorkCount = 0;
    let emptyCount = 0;
    
    console.log('Recent 10 Records:');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    
    const startIdx = Math.max(0, data.length - 10);
    
    for (let i = startIdx; i < data.length; i++) {
      const id = String(data[i][0] || '').trim();
      const status = String(statusData[i][0] || '').trim();
      const type = String(typeData[i][0] || '').trim();
      
      let icon = '‚ùì';
      if (type === 'RFI Work') {
        icon = 'üìã';
        rfiWorkCount++;
      } else if (type === 'Survey Work') {
        icon = 'üó∫Ô∏è';
        surveyWorkCount++;
      } else {
        icon = '‚ö†Ô∏è';
        emptyCount++;
      }
      
      console.log(icon + ' ' + id + ' | Status: ' + status + ' | Type: ' + (type || '(empty)'));
    }
    
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('');
    console.log('Summary:');
    console.log('üìã RFI Work:', rfiWorkCount);
    console.log('üó∫Ô∏è Survey Work:', surveyWorkCount);
    console.log('‚ö†Ô∏è Empty/Other:', emptyCount);
    console.log('');
    
    if (emptyCount > 0) {
      console.log('‚ö†Ô∏è Warning: ‡∏°‡∏µ ' + emptyCount + ' records ‡∏ó‡∏µ‡πà Column AN ‡∏ß‡πà‡∏≤‡∏á');
      console.log('   ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏µ Column AN');
    } else {
      console.log('‚úÖ All records have Column AN populated!');
    }
    
    console.log('====================================');
    
  } catch (error) {
    console.error('‚ùå Error:', error);
  }
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏µ Column AN = "RFI Work"
 * (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö records ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
 */
function updateOldRecordsColumnAN() {
  try {
    console.log('========== Update Old Records Column AN ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('‚ùå RFI_List sheet not found');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ùå No data rows');
      return;
    }
    
    // ‡∏î‡∏∂‡∏á Column AN (index 40)
    const typeData = sheet.getRange(2, 40, lastRow - 1, 1).getValues();
    
    let updateCount = 0;
    
    for (let i = 0; i < typeData.length; i++) {
      const type = String(typeData[i][0] || '').trim();
      
      // ‡∏ñ‡πâ‡∏≤ Column AN ‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "Survey Work" ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà "RFI Work"
      if (!type || (type !== 'Survey Work' && type !== 'RFI Work')) {
        sheet.getRange(i + 2, 40).setValue('RFI Work');
        updateCount++;
      }
    }
    
    console.log('‚úÖ Updated ' + updateCount + ' records with Column AN = "RFI Work"');
    console.log('==================================================');
    
    if (updateCount > 0) {
      SpreadsheetApp.getUi().alert(
        '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
        '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Column AN ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö ' + updateCount + ' records\n' +
        '‡∏ó‡∏∏‡∏Å record ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Survey Work ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô "RFI Work"',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    } else {
      SpreadsheetApp.getUi().alert(
        '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
        '‡∏ó‡∏∏‡∏Å records ‡∏°‡∏µ Column AN ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Column AN ‡πÑ‡∏î‡πâ\n\n' +
      'Error: ' + error.toString(),
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}


/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á Team Emails
 */
function testGetTeamEmails() {
  console.log('========== Test Get Team Emails ==========');
  
  const testTeams = [
    'Survey Team A',
    'Survey Team A,Lab Team B',
    'Survey Team A, Lab Team A, Inspector Team A'
  ];
  
  testTeams.forEach(function(teamNames) {
    console.log('\nüìù Testing with teams:', teamNames);
    const emails = getTeamEmailsByTeamNames(teamNames);
    
    if (emails.length > 0) {
      console.log('‚úÖ Found', emails.length, 'team emails:');
      emails.forEach(function(team) {
        console.log('  -', team.name, '‚Üí', team.email);
      });
    } else {
      console.log('‚ö†Ô∏è No team emails found');
    }
  });
  
  console.log('\n==========================================');
}

// ===== Performance & Helper Functions =====

/**
 * ‚ö° Cache blocked time slots ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°
 */
function getBlockedTimeSlotsForTeams(date, teams) {
  const blockedSlots = {};
  
  teams.forEach(function(team) {
    blockedSlots[team.resourceId] = [];
  });
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
  if (!sheet) return blockedSlots;
  
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) return blockedSlots;
  
  const data = sheet.getRange(2, 1, lastRow - 1, 15).getValues();
  
  const resourceSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
  if (!resourceSheet) return blockedSlots;
  
  const resourceData = resourceSheet.getRange(2, 1, resourceSheet.getLastRow() - 1, 2).getValues();
  
  const nameToId = {};
  resourceData.forEach(function(row) {
    const rid = String(row[0] || '').trim();
    const rname = String(row[1] || '').trim();
    if (rid && rname) {
      nameToId[rname] = rid;
    }
  });
  
  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const rfiDate = formatDate(new Date(row[4]));
    const status = String(row[14] || '').trim();
    
    if (isStatusInactive(status)) continue;
    if (rfiDate !== date) continue;
    
    const startTime = formatTime(row[5]);
    const endTime = formatTime(row[6]);
    const assignedTeams = String(row[11] || '').trim();
    
    if (!assignedTeams) continue;
    
    const teamNames = assignedTeams.split(',').map(function(n) { return n.trim(); });
    
    teamNames.forEach(function(teamName) {
      const resourceId = nameToId[teamName];
      if (resourceId && blockedSlots[resourceId]) {
        blockedSlots[resourceId].push({
          start: timeToMinutes(startTime),
          end: timeToMinutes(endTime)
        });
      }
    });
  }
  
  return blockedSlots;
}

/**
 * üîß ‡πÅ‡∏õ‡∏•‡∏á minutes ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô time string
 */
function minutesToTime(minutes) {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return hours.toString().padStart(2, '0') + ':' + mins.toString().padStart(2, '0');
}

/**
 * ‚öôÔ∏è ‡∏î‡∏∂‡∏á Buffer Minutes ‡∏ï‡∏≤‡∏° Work Type
 */
function getBufferMinutes(workType) {
  const bufferConfig = {
    'Survey Work': 0,
    'Lab Work': 30,
    'Inspector Work': 30,
    'Heavy Work': 60
  };
  
  return bufferConfig[workType] || 25;
}

/**
 * üí¨ ‡∏´‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ Time Slots
 */
function getNoSlotsReason(date, category) {
  try {
    const teams = getTeamsByCategory(category);
    
    if (teams.length === 0) {
      return {
        reason: 'no_teams',
        message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + category,
        suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô'
      };
    }
    
    const selectedDate = new Date(date + 'T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
      return {
        reason: 'past_date',
        message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
        suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'
      };
    }
    
    const blockedSlots = getBlockedTimeSlotsForTeams(date, teams);
    
    let totalBlocks = 0;
    Object.keys(blockedSlots).forEach(function(teamId) {
      totalBlocks += blockedSlots[teamId].length;
    });
    
    if (totalBlocks > 0) {
      return {
        reason: 'fully_booked',
        message: '‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
        suggestion: '‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏° QC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤',
        details: {
          totalTeams: teams.length,
          totalBookings: totalBlocks
        }
      };
    }
    
    return {
      reason: 'time_constraint',
      message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
      suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô'
    };
    
  } catch (error) {
    console.error('Error getting no slots reason:', error);
    return {
      reason: 'error',
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
      suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
    };
  }
}

/**
 * üìä ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ß‡∏•‡∏≤
 */
function getAvailableTeamsWithSlots(date, category) {
  try {
    const teams = getTeamsByCategory(category);
    if (teams.length === 0) return [];
    
    const blockedSlots = getBlockedTimeSlotsForTeams(date, teams);
    
    const result = [];
    
    teams.forEach(function(team) {
      const blocks = blockedSlots[team.resourceId] || [];
      
      result.push({
        teamId: team.resourceId,
        teamName: team.resourceName,
        teamNo: team.teamNo,
        totalBookings: blocks.length,
        blockedTimes: blocks.map(function(b) {
          return minutesToTime(b.start) + '-' + minutesToTime(b.end);
        }),
        isFullyBooked: blocks.length >= 10
      });
    });
    
    result.sort(function(a, b) {
      return a.totalBookings - b.totalBookings;
    });
    
    return result;
    
  } catch (error) {
    console.error('Error getting available teams:', error);
    return [];
  }
}

/**
 * üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á
 */
function suggestAlternativeTimeSlots(category, date, startTime, endTime) {
  try {
    const teams = getTeamsByCategory(category);
    if (teams.length === 0) return [];
    
    const duration = timeToMinutes(endTime) - timeToMinutes(startTime);
    const suggestions = [];
    
    const allSlots = [];
    for (let hour = 9; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        if (hour === 19 && minute === 30) break;
        allSlots.push(hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0'));
      }
    }
    
    allSlots.forEach(function(slot) {
      const startMinutes = timeToMinutes(slot);
      const endMinutes = startMinutes + duration;
      
      if (endMinutes > 20 * 60) return;
      
      const endSlot = minutesToTime(endMinutes);
      
      let hasAvailableTeam = false;
      
      for (let i = 0; i < teams.length; i++) {
        if (isTeamAvailable(teams[i].resourceId, date, slot, endSlot)) {
          hasAvailableTeam = true;
          break;
        }
      }
      
      if (hasAvailableTeam) {
        suggestions.push({
          startTime: slot,
          endTime: endSlot,
          duration: duration + ' ‡∏ô‡∏≤‡∏ó‡∏µ'
        });
      }
    });
    
    return suggestions.slice(0, 5);
    
  } catch (error) {
    console.error('Error suggesting alternatives:', error);
    return [];
  }
}

/**
 * ‚úÖ Validate RFI Request
 */
function validateRFIRequest(data) {
  const errors = [];
  
  if (!data.requestDate) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
  if (!data.startTime) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
  if (!data.endTime) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
  if (!data.description) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
  if (!data.location) errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà');
  
  if (data.requestDate) {
    const selectedDate = new Date(data.requestDate + 'T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
      errors.push('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
    }
  }
  
  if (data.startTime && data.endTime) {
    const startMinutes = timeToMinutes(data.startTime);
    const endMinutes = timeToMinutes(data.endTime);
    
    if (endMinutes <= startMinutes) {
      errors.push('‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
    }
    
    const duration = endMinutes - startMinutes;
    if (duration < 30) {
      errors.push('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 30 ‡∏ô‡∏≤‡∏ó‡∏µ');
    }
    
    if (duration > 480) {
      errors.push('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 8 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á');
    }
  }
  
  if (data.startTime) {
    const startMinutes = timeToMinutes(data.startTime);
    if (startMinutes < 9 * 60 || startMinutes >= 19 * 60) {
      errors.push('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 09:00-19:00');
    }
  }
  
  if (data.endTime) {
    const endMinutes = timeToMinutes(data.endTime);
    if (endMinutes > 20 * 60) {
      errors.push('‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20:00');
    }
  }
  
  if (data.requesterEmail && !data.requesterEmail.includes('@')) {
    errors.push('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }
  
  return {
    valid: errors.length === 0,
    errors: errors
  };
}

/**
 * üí¨ ‡∏´‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
 */
function getTeamAssignmentFailureReason(category, date, startTime, endTime) {
  try {
    const teams = getTeamsByCategory(category);
    
    if (teams.length === 0) {
      return {
        reason: 'no_teams_in_category',
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ' + category,
        suggestion: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô'
      };
    }
    
    const unavailableTeams = [];
    
    teams.forEach(function(team) {
      if (!isTeamAvailable(team.resourceId, date, startTime, endTime)) {
        unavailableTeams.push({
          teamName: team.resourceName,
          teamNo: team.teamNo
        });
      }
    });
    
    if (unavailableTeams.length === teams.length) {
      return {
        reason: 'all_teams_busy',
        message: '‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ',
        suggestion: '‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
        details: {
          totalTeams: teams.length,
          busyTeams: unavailableTeams
        }
      };
    }
    
    return {
      reason: 'unknown',
      message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ',
      suggestion: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'
    };
    
  } catch (error) {
    console.error('Error:', error);
    return {
      reason: 'error',
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.toString()
    };
  }
}

/**
 * üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
 */
function testOptimizedFunctions() {
  console.log('========== Test Optimized Functions ==========');
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const date = tomorrow.toISOString().split('T')[0];
  
  // 1. Test getRFIByDate
  console.log('\n1. Testing getRFIByDate()...');
  const rfis = getRFIByDate(date);
  console.log('Found RFIs:', rfis.length);
  
  // 2. Test getAvailableTimeSlots
  console.log('\n2. Testing getAvailableTimeSlots()...');
  const startTime = new Date().getTime();
  const slots = getAvailableTimeSlots(date, 'Survey');
  const endTime = new Date().getTime();
  console.log('Found slots:', slots.length);
  console.log('‚ö° Time taken:', (endTime - startTime) + 'ms');
  
  // 3. Test getNoSlotsReason
  console.log('\n3. Testing getNoSlotsReason()...');
  const reason = getNoSlotsReason(date, 'Survey');
  console.log('Reason:', reason.message);
  
  // 4. Test getAvailableTeamsWithSlots
  console.log('\n4. Testing getAvailableTeamsWithSlots()...');
  const teams = getAvailableTeamsWithSlots(date, 'Survey');
  teams.forEach(function(team) {
    console.log('-', team.teamName + ':', team.totalBookings + ' bookings');
  });
  
  // 5. Test validateRFIRequest
  console.log('\n5. Testing validateRFIRequest()...');
  const testData = {
    requestDate: date,
    startTime: '14:00',
    endTime: '15:00',
    description: 'Test',
    location: 'Test Location',
    requesterEmail: 'test@example.com'
  };
  const validation = validateRFIRequest(testData);
  console.log('Valid:', validation.valid);
  
  console.log('\n========== Test Complete ==========');
}


/**
 * üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Survey_NO
 */
function testSurveyNo() {
  console.log('========== Test Survey_NO ==========');
  
  // Test 1: ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ Survey Work ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏µ‡πà‡∏ï‡∏±‡∏ß
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
  const lastRow = sheet.getLastRow();
  
  if (lastRow > 1) {
    const typeData = sheet.getRange(2, 40, lastRow - 1, 1).getValues();
    const surveyNoData = sheet.getRange(2, 2, lastRow - 1, 1).getValues();
    
    let count = 0;
    console.log('\nüìã Survey Work ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà:');
    
    for (let i = 0; i < typeData.length; i++) {
      const type = String(typeData[i][0] || '').trim();
      const surveyNo = String(surveyNoData[i][0] || '').trim();
      
      if (type === 'Survey Work') {
        count++;
        console.log(count + '. Survey NO:', surveyNo || '(‡πÑ‡∏°‡πà‡∏°‡∏µ)');
      }
    }
    
    console.log('\nTotal Survey Work:', count);
  }
  
  // Test 2: ‡∏î‡∏π‡∏ß‡πà‡∏≤ Order ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡πÑ‡∏´‡∏ô
  const nextOrder = getNextOrderSurvey();
  console.log('\nüìä Next Order_Survey:', nextOrder);
  
  const nextSurveyNo = 'SW-' + String(nextOrder).padStart(4, '0');
  console.log('üìã Next Survey_NO:', nextSurveyNo);
  
  console.log('\n====================================');
}

/**
 * üîç Debug: ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ Status ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
 */
function debugPostponedStatus() {
  try {
    console.log('========== Debug Postponed Status ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('‚ùå RFI_List sheet not found');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    console.log('Total rows:', lastRow);
    
    if (lastRow <= 1) {
      console.log('‚ùå No data rows');
      return;
    }
    
    // ‡∏î‡∏∂‡∏á Column A (ID), B (RFI_NO), O (Status)
    const idData = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    const rfiNoData = sheet.getRange(2, 2, lastRow - 1, 1).getValues();
    const statusData = sheet.getRange(2, 15, lastRow - 1, 1).getValues(); // Column O = index 15
    
    console.log('\nüìä Status Summary:');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    
    const statusCount = {};
    const examples = {};
    
    for (let i = 0; i < idData.length; i++) {
      const id = String(idData[i][0] || '').trim();
      const rfiNo = String(rfiNoData[i][0] || '').trim();
      const status = String(statusData[i][0] || '').trim();
      
      // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
      if (!statusCount[status]) {
        statusCount[status] = 0;
        examples[status] = [];
      }
      statusCount[status]++;
      
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
      if (examples[status].length < 2) {
        examples[status].push(id + ' (' + rfiNo + ')');
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    const sortedStatuses = Object.keys(statusCount).sort((a, b) => statusCount[b] - statusCount[a]);
    
    sortedStatuses.forEach(function(status) {
      const icon = status.toLowerCase().includes('postpone') ? 'üéØ' : 'üìã';
      console.log(icon + ' "' + status + '": ' + statusCount[status] + ' records');
      console.log('   Examples: ' + examples[status].join(', '));
      console.log('');
    });
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "Inspection Postponed"
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    if (statusCount['Inspection Postponed']) {
      console.log('‚úÖ Found "Inspection Postponed": ' + statusCount['Inspection Postponed'] + ' records');
    } else {
      console.log('‚ùå No "Inspection Postponed" found');
      
      // ‡∏´‡∏≤ Status ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô
      const similar = sortedStatuses.filter(s => 
        s.toLowerCase().includes('postpone') || 
        s.toLowerCase().includes('‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô')
      );
      
      if (similar.length > 0) {
        console.log('\n‚ö†Ô∏è Found similar statuses:');
        similar.forEach(s => console.log('   - "' + s + '"'));
      }
    }
    
    console.log('============================================');
    
    // ‡πÅ‡∏™‡∏î‡∏á Alert
    const ui = SpreadsheetApp.getUi();
    let msg = 'Total Records: ' + (lastRow - 1) + '\n\n';
    msg += 'Top 5 Statuses:\n';
    
    for (let i = 0; i < Math.min(5, sortedStatuses.length); i++) {
      const s = sortedStatuses[i];
      msg += '‚Ä¢ "' + s + '": ' + statusCount[s] + ' records\n';
    }
    
    if (statusCount['Inspection Postponed']) {
      msg += '\n‚úÖ "Inspection Postponed": ' + statusCount['Inspection Postponed'];
    } else {
      msg += '\n‚ùå No "Inspection Postponed" found';
    }
    
    ui.alert('Debug Result', msg, ui.ButtonSet.OK);
    
  } catch (error) {
    console.error('‚ùå Error:', error);
  }
}

/**
 * üîç Debug: ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RFI ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
 */
function debugRecentRFI() {
  try {
    console.log('========== Recent 10 RFI ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('RFI_List');
    
    if (!sheet) {
      console.log('‚ùå Sheet not found');
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ùå No data');
      return;
    }
    
    const startRow = Math.max(2, lastRow - 9);
    const numRows = lastRow - startRow + 1;
    
    const data = sheet.getRange(startRow, 1, numRows, 15).getValues();
    
    console.log('Latest ' + numRows + ' records:');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const id = String(row[0] || '').trim();
      const rfiNo = String(row[1] || '').trim();
      const status = String(row[14] || '').trim();
      
      console.log((i + 1) + '. ID: ' + id);
      console.log('   RFI NO: ' + rfiNo);
      console.log('   Status: "' + status + '"');
      console.log('   Is Postponed: ' + (status === 'Inspection Postponed' ? 'YES ‚úÖ' : 'NO'));
      console.log('');
    }
    
    console.log('============================================');
    
  } catch (error) {
    console.error('‚ùå Error:', error);
  }
}

/**
 * üîç Debug: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Calendar Event ‡∏î‡πâ‡∏ß‡∏¢ RFI Number
 */
function debugSearchCalendarEvent() {
  Logger.log('========== Debug: Search Calendar Event ==========');
  
  const testRfiNumber = '10-RFI-0001';  // ‚≠ê RFI Number ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
  
  Logger.log('üîç Searching for RFI Number:', testRfiNumber);
  
  try {
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    
    if (!calendar) {
      Logger.log('‚ùå Cannot access calendar:', CALENDAR_ID);
      return;
    }
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ 60 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ + ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 60);
    
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 60);
    
    const allEvents = calendar.getEvents(startDate, endDate);
    Logger.log('üìä Total events in range:', allEvents.length);
    
    if (allEvents.length === 0) {
      Logger.log('‚ö†Ô∏è No events found in calendar');
      return;
    }
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ event ‡∏ó‡∏µ‡πà‡∏°‡∏µ RFI Number
    const searchPatterns = [
      `RFI #${testRfiNumber}`,
      `RFI-${testRfiNumber}`,
      `#${testRfiNumber}`,
      testRfiNumber
    ];
    
    Logger.log('üîé Search patterns:', searchPatterns.join(', '));
    Logger.log('');
    
    let foundCount = 0;
    
    allEvents.forEach((event, index) => {
      const title = event.getTitle() || '';
      const description = event.getDescription() || '';
      const searchableText = (title + ' ' + description).toLowerCase();
      
      const matches = searchPatterns.some(pattern => 
        searchableText.includes(pattern.toLowerCase())
      );
      
      if (matches) {
        foundCount++;
        Logger.log(`‚úÖ Found Event ${foundCount}:`);
        Logger.log(`   Title: ${title}`);
        Logger.log(`   Date: ${event.getStartTime().toLocaleString('th-TH')}`);
        Logger.log(`   Description: ${description.substring(0, 100)}...`);
        Logger.log('');
      }
    });
    
    Logger.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    Logger.log(`üìä Summary: Found ${foundCount} events for RFI: ${testRfiNumber}`);
    
    if (foundCount === 0) {
      Logger.log('');
      Logger.log('‚ö†Ô∏è No events found! Possible reasons:');
      Logger.log('   1. Calendar Event ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á');
      Logger.log('   2. RFI Number ‡πÉ‡∏ô Calendar ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ô Sheet');
      Logger.log('   3. Event ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á 60 ‡∏ß‡∏±‡∏ô');
      Logger.log('');
      Logger.log('üìã Recent 5 events in calendar:');
      
      for (let i = 0; i < Math.min(5, allEvents.length); i++) {
        const evt = allEvents[i];
        Logger.log(`   ${i + 1}. "${evt.getTitle()}" - ${evt.getStartTime().toLocaleDateString('th-TH')}`);
      }
    }
    
    Logger.log('==================================================');
    
  } catch (error) {
    Logger.log('‚ùå Error:', error.toString());
  }
}


/**
 * ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Contact_Email ‡πÅ‡∏•‡∏∞ Contact_Phone columns
 */
function updateResourcesSheetStructure() {
  try {
    console.log('========== Update Resources Sheet Structure ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Resources');
    
    if (!sheet) {
      console.log('‚ùå Resources sheet not found');
      return;
    }
    
    const lastColumn = sheet.getLastColumn();
    console.log('Current columns:', lastColumn);
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Column F, G, H ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (lastColumn < 6) {
      console.log('Adding Contact_Email column (F)...');
      sheet.getRange(1, 6).setValue('Contact_Email');
    }
    
    if (lastColumn < 7) {
      console.log('Adding Contact_Phone column (G)...');
      sheet.getRange(1, 7).setValue('Contact_Phone');
    }
    
    if (lastColumn < 8) {
      console.log('Adding Color Code column (H)...');
      sheet.getRange(1, 8).setValue('Color Code');
    }
    
    // Format headers
    const headerRange = sheet.getRange(1, 1, 1, 8);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#1877f2');
    headerRange.setFontColor('#ffffff');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á columns
    sheet.setColumnWidth(6, 200);  // Contact_Email
    sheet.setColumnWidth(7, 150);  // Contact_Phone
    sheet.setColumnWidth(8, 100);  // Color Code
    
    console.log('‚úÖ Updated successfully!');
    
    SpreadsheetApp.getUi().alert(
      '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
      '‡πÄ‡∏û‡∏¥‡πà‡∏° columns:\n' +
      '‚Ä¢ F: Contact_Email\n' +
      '‚Ä¢ G: Contact_Phone\n' +
      '‚Ä¢ H: Color Code\n\n' +
      '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡πÉ‡∏ô Column F',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
  } catch (error) {
    console.error('‚ùå Error:', error);
  }
}

function testGetTeamEmailsFixed() {
  console.log('========== Test Get Team Emails ==========');
  
  const testTeams = 'Survey Team A';
  console.log('Testing with teams:', testTeams);
  
  const emails = getTeamEmailsByTeamNames(testTeams);
  
  console.log('Result:', emails.length, 'emails found');
  emails.forEach(function(team) {
    console.log('‚úÖ', team.name, '‚Üí', team.email);
  });
  
  if (emails.length === 0) {
    console.log('‚ö†Ô∏è No emails found - please check:');
    console.log('   1. Resources sheet has Contact_Email column (F)');
    console.log('   2. Teams have email addresses');
    console.log('   3. Status = "Activated"');
  }
  
  console.log('==========================================');
}

/**
 * üîç Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ Sheets ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
function debugListAllSheets() {
  console.log('========== All Sheets in Spreadsheet ==========');
  
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = spreadsheet.getSheets();
  
  console.log('Total sheets:', sheets.length);
  console.log('');
  
  sheets.forEach(function(sheet, index) {
    const name = sheet.getName();
    const nameLength = name.length;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á visible ‡πÅ‡∏•‡∏∞ hidden characters
    let displayName = '';
    for (let i = 0; i < name.length; i++) {
      const char = name.charAt(i);
      const code = name.charCodeAt(i);
      
      if (char === ' ') {
        displayName += '‚ê£';  // ‡πÅ‡∏™‡∏î‡∏á space ‡πÄ‡∏õ‡πá‡∏ô symbol
      } else if (code < 32 || code > 126) {
        displayName += '[' + code + ']';  // ‡πÅ‡∏™‡∏î‡∏á special characters
      } else {
        displayName += char;
      }
    }
    
    console.log((index + 1) + '. "' + displayName + '"');
    console.log('   Original: "' + name + '"');
    console.log('   Length: ' + nameLength + ' characters');
    console.log('   Last Row: ' + sheet.getLastRow());
    console.log('   Last Column: ' + sheet.getLastColumn());
    console.log('');
  });
  
  // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ Resources sheet
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  console.log('Searching for "Resources":');
  
  const resourcesSheet = spreadsheet.getSheetByName('Resources');
  if (resourcesSheet) {
    console.log('‚úÖ Found "Resources" sheet!');
    console.log('   Rows:', resourcesSheet.getLastRow());
    console.log('   Columns:', resourcesSheet.getLastColumn());
  } else {
    console.log('‚ùå Sheet "Resources" NOT FOUND');
    console.log('');
    console.log('üí° Possible reasons:');
    console.log('   1. Sheet name has typo or extra spaces');
    console.log('   2. Sheet name uses different characters');
    console.log('   3. Sheet is in different spreadsheet');
  }
  
  console.log('===============================================');
}

function testGetTeamEmailsDebug() {
  console.log('\n\n');
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë   Test Get Team Emails (Debug Version)    ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  console.log('\n');
  
  const testTeams = 'Survey Team A';
  const emails = getTeamEmailsByTeamNames(testTeams);
  
  console.log('\n');
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë              Final Result                  ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  
  if (emails.length > 0) {
    console.log('‚úÖ SUCCESS! Found', emails.length, 'email(s):');
    emails.forEach(function(team, index) {
      console.log((index + 1) + '.', team.name);
      console.log('   Email:', team.email);
      console.log('   Role:', team.role);
    });
  } else {
    console.log('‚ùå No emails found');
  }
  
  console.log('\n');
}


function manualDebugResources() {
  console.log('========== Manual Debug ==========');
  
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  console.log('Spreadsheet Name:', spreadsheet.getName());
  
  const sheets = spreadsheet.getSheets();
  console.log('Total Sheets:', sheets.length);
  
  sheets.forEach(function(sheet, index) {
    console.log((index + 1) + '. "' + sheet.getName() + '"');
  });
  
  const resourceSheet = spreadsheet.getSheetByName('Resources');
  
  if (resourceSheet) {
    console.log('‚úÖ Resources sheet EXISTS!');
    console.log('   Last Row:', resourceSheet.getLastRow());
    console.log('   Last Column:', resourceSheet.getLastColumn());
  } else {
    console.log('‚ùå Resources sheet NOT FOUND');
  }
  
  console.log('==================================');
}

/**
 * üÜï Test Function ‡πÉ‡∏´‡∏°‡πà - Force Refresh
 */
function testGetTeamEmailsV2() {
  console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë       Test Get Team Emails V2 (NEW)       ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
  
  const testTeamName = 'Survey Team A';
  console.log('üîç Testing with team:', testTeamName);
  console.log('');
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å function ‡∏ï‡∏£‡∏á ‡πÜ
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    console.log('‚úÖ Spreadsheet:', spreadsheet.getName());
    
    const resourceSheet = spreadsheet.getSheetByName('Resources');
    
    if (!resourceSheet) {
      console.log('‚ùå Resources sheet not found!');
      return;
    }
    
    console.log('‚úÖ Resources sheet found!');
    console.log('   Last Row:', resourceSheet.getLastRow());
    console.log('   Last Column:', resourceSheet.getLastColumn());
    console.log('');
    
    const lastRow = resourceSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ùå No data in Resources sheet');
      return;
    }
    
    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: B (Name), E (Status), F (Email)
    const data = resourceSheet.getRange(2, 2, lastRow - 1, 5).getValues();
    
    console.log('üìä Reading data from rows 2 to', lastRow);
    console.log('Total rows to check:', data.length);
    console.log('');
    
    const result = [];
    let checkedCount = 0;
    let activatedCount = 0;
    
    for (let i = 0; i < data.length; i++) {
      checkedCount++;
      
      const resourceName = String(data[i][0] || '').trim();  // Column B
      const subType = String(data[i][1] || '').trim();       // Column C
      const teamNo = data[i][2];                              // Column D
      const status = String(data[i][3] || '').trim();        // Column E
      const contactEmail = String(data[i][4] || '').trim();  // Column F
      
      // Debug first 3 rows
      if (i < 3) {
        console.log('Row ' + (i + 2) + ':');
        console.log('  Name:', resourceName);
        console.log('  Status:', status);
        console.log('  Email:', contactEmail);
        console.log('');
      }
      
      if (status === 'Activated') {
        activatedCount++;
      }
      
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (resourceName === testTeamName && 
          status === 'Activated' && 
          contactEmail && 
          contactEmail.includes('@')) {
        
        result.push({
          email: contactEmail,
          name: resourceName,
          role: 'Team Member'
        });
        
        console.log('‚úÖ FOUND MATCH!');
        console.log('   Name:', resourceName);
        console.log('   Email:', contactEmail);
      }
    }
    
    console.log('');
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('Summary:');
    console.log('  Rows checked:', checkedCount);
    console.log('  Activated teams:', activatedCount);
    console.log('  Matches found:', result.length);
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    
    if (result.length > 0) {
      console.log('');
      console.log('‚úÖ SUCCESS! Found', result.length, 'email(s):');
      result.forEach(function(team, index) {
        console.log((index + 1) + '.', team.name, '‚Üí', team.email);
      });
    } else {
      console.log('');
      console.log('‚ùå No matching emails found');
      console.log('');
      console.log('üí° Please check:');
      console.log('   1. Team name = "' + testTeamName + '" (exact match)');
      console.log('   2. Status = "Activated"');
      console.log('   3. Contact_Email has valid email');
    }
    
  } catch (error) {
    console.error('‚ùå Error:', error.toString());
    console.error('Stack:', error.stack);
  }
  
  console.log('\n');
}

function quickTestTeamEmails() {
  const emails = getTeamEmailsByTeamNames('Survey Team A');
  console.log('Result:', emails.length, 'emails');
  emails.forEach(function(e) {
    console.log('-', e.name, '‚Üí', e.email);
  });
}

function getTeamEmailsByTeamNames(teamNames) {
  try {
    console.log('========== getTeamEmailsByTeamNames START ==========');
    console.log('Input teamNames:', teamNames);
    console.log('Type:', typeof teamNames);
    
    // Check 1: teamNames is valid
    if (!teamNames) {
      console.log('‚ùå No team names provided (null/undefined)');
      return [];
    }
    
    const teamString = String(teamNames).trim();
    console.log('Team string (trimmed):', teamString);
    
    if (teamString === '') {
      console.log('‚ùå Empty team names');
      return [];
    }
    
    // Check 2: Parse team names
    const requestedTeams = teamString.split(',').map(function(t) { 
      return t.trim(); 
    }).filter(function(t) { 
      return t.length > 0; 
    });
    
    console.log('Parsed teams:', JSON.stringify(requestedTeams));
    console.log('Number of teams:', requestedTeams.length);
    
    if (requestedTeams.length === 0) {
      console.log('‚ùå No valid teams after parsing');
      return [];
    }
    
    // Check 3: Access spreadsheet
    console.log('Accessing spreadsheet...');
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    console.log('‚úÖ Spreadsheet name:', spreadsheet.getName());
    
    // Check 4: Get Resources sheet
    console.log('Looking for Resources sheet...');
    const resourceSheet = spreadsheet.getSheetByName('Resources');
    
    if (!resourceSheet) {
      console.log('‚ùå Resources sheet not found!');
      
      // Debug: List all sheets
      const allSheets = spreadsheet.getSheets();
      console.log('Available sheets:', allSheets.map(function(s) { 
        return s.getName(); 
      }).join(', '));
      
      return [];
    }
    
    console.log('‚úÖ Resources sheet found!');
    
    // Check 5: Get data
    const lastRow = resourceSheet.getLastRow();
    const lastColumn = resourceSheet.getLastColumn();
    
    console.log('Last row:', lastRow);
    console.log('Last column:', lastColumn);
    
    if (lastRow <= 1) {
      console.log('‚ö†Ô∏è No data rows in Resources sheet');
      return [];
    }
    
    if (lastColumn < 6) {
      console.log('‚ùå Resources sheet missing columns (need at least 6)');
      console.log('   Current columns:', lastColumn);
      console.log('   Required: 6 (A-F with Contact_Email in column F)');
      return [];
    }
    
    // Check 6: Read data (B-F = Name, SubType, TeamNo, Status, Email)
    console.log('Reading data from rows 2 to', lastRow, '...');
    const data = resourceSheet.getRange(2, 2, lastRow - 1, 5).getValues();
    console.log('‚úÖ Data rows read:', data.length);
    
    // Check 7: Process data
    const teamEmails = [];
    let rowsChecked = 0;
    let activatedCount = 0;
    let matchedCount = 0;
    
    for (let i = 0; i < data.length; i++) {
      rowsChecked++;
      
      const resourceName = String(data[i][0] || '').trim();  // Column B
      const subType = String(data[i][1] || '').trim();       // Column C
      const teamNo = data[i][2];                              // Column D
      const status = String(data[i][3] || '').trim();        // Column E
      const contactEmail = String(data[i][4] || '').trim();  // Column F
      
      // Debug first 3 rows
      if (i < 3) {
        console.log('Row ' + (i + 2) + ':');
        console.log('  Name:', resourceName);
        console.log('  Status:', status);
        console.log('  Email:', contactEmail);
      }
      
      if (status === 'Activated') {
        activatedCount++;
      }
      
      // Check if this team is in requested list
      const isRequested = requestedTeams.indexOf(resourceName) !== -1;
      
      if (isRequested) {
        matchedCount++;
        console.log('‚úì Matched team:', resourceName);
        console.log('  Status:', status);
        console.log('  Email:', contactEmail);
      }
      
      if (isRequested && 
          status === 'Activated' && 
          contactEmail && 
          contactEmail.includes('@')) {
        
        teamEmails.push({
          email: contactEmail,
          name: resourceName,
          role: 'Team Member'
        });
        
        console.log('‚úÖ Added:', resourceName, '‚Üí', contactEmail);
      }
    }
    
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('Summary:');
    console.log('  Rows checked:', rowsChecked);
    console.log('  Activated teams:', activatedCount);
    console.log('  Matched teams:', matchedCount);
    console.log('  Final result:', teamEmails.length, 'emails');
    console.log('========== getTeamEmailsByTeamNames END ==========');
    
    return teamEmails;
    
  } catch (error) {
    console.error('‚ùå‚ùå‚ùå ERROR in getTeamEmailsByTeamNames ‚ùå‚ùå‚ùå');
    console.error('Error message:', error.toString());
    console.error('Error stack:', error.stack);
    return [];
  }
}

/**
 * ‚≠ê ‡∏•‡∏ö Meeting Links ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Description
 */
function removeMeetingLinksFromDescription(description) {
  if (!description) return '';
  
  Logger.log('üßπ Cleaning description from meeting links...');
  
  let cleaned = String(description);
  
  // ‡∏•‡∏ö Google Meet links
  cleaned = cleaned.replace(/https:\/\/meet\.google\.com\/[a-z\-]+/gi, '');
  
  // ‡∏•‡∏ö Zoom links
  cleaned = cleaned.replace(/https:\/\/[^\s]*zoom\.us\/[^\s)]+/gi, '');
  
  // ‡∏•‡∏ö Microsoft Teams links
  cleaned = cleaned.replace(/https:\/\/teams\.microsoft\.com\/[^\s)]+/gi, '');
  
  // ‡∏•‡∏ö "Join with Google Meet" ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
  cleaned = cleaned.replace(/Join (?:with )?Google Meet[^\n]*/gi, '');
  cleaned = cleaned.replace(/‚îÄ{5,}Join with Google Meet‚îÄ{5,}/gi, '');
  
  // ‡∏•‡∏ö "Video call link:" ‡πÅ‡∏•‡∏∞ link ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏°‡∏≤
  cleaned = cleaned.replace(/Video call link:\s*https?:\/\/[^\s]+/gi, '');
  cleaned = cleaned.replace(/Video call link:[^\n]*/gi, '');
  
  // ‡∏•‡∏ö "View your event at:" ‡πÅ‡∏•‡∏∞ link
  cleaned = cleaned.replace(/View your event at:\s*https?:\/\/[^\s]+/gi, '');
  cleaned = cleaned.replace(/View your event at:[^\n]*/gi, '');
  
  // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î divider ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  cleaned = cleaned.replace(/‚îÄ{10,}/g, '');
  cleaned = cleaned.replace(/‚îÅ{10,}/g, '');
  
  // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà 1-2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
  cleaned = cleaned.replace(/\n\n\n+/g, '\n\n');
  
  // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢
  cleaned = cleaned.trim();
  
  Logger.log('‚úÖ Description cleaned');
  
  return cleaned;
}

/**
 * ‚≠ê ‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô User sheet)
 */
function getUserNameFromEmail(email) {
  try {
    console.log('Getting user name for email:', email);
    
    if (!email) {
      return {
        success: false,
        name: '',
        exists: false
      };
    }
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found');
      return {
        success: false,
        name: '',
        exists: false
      };
    }
    
    const lastRow = userSheet.getLastRow();
    
    if (lastRow <= 1) {
      return {
        success: false,
        name: '',
        exists: false
      };
    }
    
    // ‡∏î‡∏∂‡∏á Column B (Email), C (DisplayName), D (Role), E (Status)
    const data = userSheet.getRange(2, 2, lastRow - 1, 4).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const userEmail = String(row[0] || '').trim().toLowerCase();
      const displayName = String(row[1] || '').trim();
      const role = String(row[2] || '').trim();
      const status = String(row[3] || '').trim();
      
      if (userEmail === email.toLowerCase()) {
        // ‚úÖ ‡πÄ‡∏à‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß
        if (role === 'Requester' && status === 'Activated') {
          console.log('Found active requester:', displayName);
          return {
            success: true,
            name: displayName,
            exists: true,
            role: role
          };
        } else {
          // ‡πÄ‡∏à‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡πÅ‡∏ï‡πà Role/Status ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          console.log('Found email but invalid role/status:', role, status);
          return {
            success: false,
            name: '',
            exists: true,
            role: role,
            status: status,
            message: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö RFI (Role: ' + role + ', Status: ' + status + ')'
          };
        }
      }
    }
    
    // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏•‡∏¢
    console.log('Email not found in User sheet');
    return {
      success: true, // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ
      name: '',
      exists: false
    };
    
  } catch (error) {
    console.error('Error getting user name:', error);
    return {
      success: false,
      name: '',
      exists: false,
      error: error.toString()
    };
  }
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: validateAndGetUser() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
 */
function validateAndGetUser(email, name) {
  try {
    console.log('Validating user:', email, name);
    
    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('User');
    
    if (!userSheet) {
      console.log('User sheet not found, creating...');
      createUserSheet();
      return addNewUser(email, name);
    }
    
    const lastRow = userSheet.getLastRow();
    
    if (lastRow <= 1) {
      return addNewUser(email, name);
    }
    
    const data = userSheet.getRange(2, 1, lastRow - 1, 5).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const rowIndex = i + 2; // Row number in sheet
      const userEmail = String(row[1] || '').trim().toLowerCase();
      const existingName = String(row[2] || '').trim();
      const role = String(row[3] || '').trim();
      const status = String(row[4] || '').trim();
      
      if (userEmail === email.toLowerCase()) {
        if (role === 'Requester' && status === 'Activated') {
          // ‚úÖ ‡πÄ‡∏à‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà Active
          
          // ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
          if (name && name !== existingName) {
            console.log('Updating user name from "' + existingName + '" to "' + name + '"');
            userSheet.getRange(rowIndex, 3).setValue(name); // Column C
            
            return {
              success: true,
              email: userEmail,
              name: name, // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
              exists: true,
              nameUpdated: true
            };
          }
          
          // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
          console.log('Found existing active user:', existingName, userEmail);
          return {
            success: true,
            email: userEmail,
            name: existingName,
            exists: true,
            nameUpdated: false
          };
        } else {
          return {
            success: false,
            message: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö RFI (Role: ' + role + ', Status: ' + status + ')'
          };
        }
      }
    }
    
    // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    return addNewUser(email, name);
    
  } catch (error) {
    console.error('Error in validateAndGetUser:', error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + error.toString()
    };
  }
}

/**
 * ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Load Balancing ‡∏û‡∏£‡πâ‡∏≠‡∏° Cache
 */
function testLoadBalancing() {
  console.log('========== Test Load Balancing (with Cache) ==========');
  
  // ‚≠ê Reset cache ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö
  resetWorkloadCache();
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const date = tomorrow.toISOString().split('T')[0];
  
  const timeSlots = [
    ['09:00', '10:00'],
    ['10:00', '11:00'],
    ['11:00', '12:00'],
    ['13:00', '14:00'],
    ['14:00', '15:00']
  ];
  
  console.log('\n‡∏à‡∏≠‡∏á Survey Team 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô:');
  console.log('Date:', date);
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  
  timeSlots.forEach(function(slot, index) {
    const result = assignSurveyTeamAutomatically(date, slot[0], slot[1], true); // ‚≠ê useCache = true
    
    if (result.success) {
      console.log((index + 1) + '.', slot[0] + '-' + slot[1], '‚Üí', 
                  result.teamName, 
                  '(Workload before:', result.workload + ')');
    } else {
      console.log((index + 1) + '.', slot[0] + '-' + slot[1], '‚Üí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á');
    }
  });
  
  console.log('\n======================================');
  console.log('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á:');
  console.log('1. ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ workload ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô');
  console.log('2. ‡∏ñ‡πâ‡∏≤ workload ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏ä‡πâ Round Robin ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô');
  console.log('3. ‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏°‡∏µ workload ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô cache');
  console.log('======================================');
}

/**
 * ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Multi-Work ‡∏û‡∏£‡πâ‡∏≠‡∏° Cache
 */
function testMultiWorkLoadBalancing() {
  console.log('========== Test Multi-Work Load Balancing (with Cache) ==========');
  
  // ‚≠ê Reset cache ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö
  resetWorkloadCache();
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const date = tomorrow.toISOString().split('T')[0];
  
  // ‡∏à‡∏≠‡∏á Survey + Lab 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  const categories = ['Survey', 'Lab'];
  
  console.log('\n‡∏à‡∏≠‡∏á Survey+Lab 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô:');
  console.log('Date:', date);
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  
  const timeSlots = [
    ['09:00', '10:00'],
    ['11:00', '12:00'],
    ['14:00', '15:00']
  ];
  
  timeSlots.forEach(function(slot, index) {
    const result = assignMultipleTeams(categories, date, slot[0], slot[1], null, true); // ‚≠ê useCache = true
    
    if (result.success) {
      console.log((index + 1) + '.', slot[0] + '-' + slot[1], '‚Üí', 
                  result.teamNames,
                  '(Total Workload:', result.totalWorkload + ')');
    } else {
      console.log((index + 1) + '.', slot[0] + '-' + slot[1], '‚Üí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ß‡πà‡∏≤‡∏á');
    }
  });
  
  console.log('\n======================================');
  console.log('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á:');
  console.log('1. ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ total workload ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î');
  console.log('2. ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥ (‡∏Ñ‡∏ß‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô)');
  console.log('3. workload ‡πÉ‡∏ô cache ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
  console.log('======================================');
}

/**
 * üß™ ‡∏î‡∏π Workload ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°
 */
function viewTeamWorkload() {
  console.log('========== Team Workload Report ==========');
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const date = tomorrow.toISOString().split('T')[0];
  
  console.log('Date:', date);
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  
  // Survey Teams
  const surveyTeams = getSurveyTeams();
  console.log('\nüìã Survey Teams:');
  surveyTeams.forEach(function(team) {
    const workload = getTeamWorkload(team.resourceId, date);
    console.log('-', team.resourceName, '(Team No.', team.teamNo + '):', workload, 'tasks');
  });
  
  // Lab Teams
  const labTeams = getTeamsByCategory('Lab');
  console.log('\nüß™ Lab Teams:');
  labTeams.forEach(function(team) {
    const workload = getTeamWorkload(team.resourceId, date);
    console.log('-', team.resourceName, '(Team No.', team.teamNo + '):', workload, 'tasks');
  });
  
  console.log('\n======================================');
}



function testQuickFix() {
  console.log('========== Test Quick Fix ==========');
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const date = tomorrow.toISOString().split('T')[0];
  
  // Test 1: Single Team
  console.log('\n1. Testing Single Team:');
  const result1 = assignTeamAutomatically('Survey', date, '09:00', '10:00');
  console.log('Result:', result1 ? 'OK' : 'UNDEFINED');
  console.log('Success:', result1 ? result1.success : 'N/A');
  
  // Test 2: Multi Team
  console.log('\n2. Testing Multi Team:');
  const result2 = assignTeamAutomatically('Survey,Lab', date, '11:00', '12:00');
  console.log('Result:', result2 ? 'OK' : 'UNDEFINED');
  console.log('Success:', result2 ? result2.success : 'N/A');
  
  // Test 3: Survey Team
  console.log('\n3. Testing Survey Team:');
  const result3 = assignSurveyTeamAutomatically(date, '14:00', '15:00');
  console.log('Result:', result3 ? 'OK' : 'UNDEFINED');
  console.log('Success:', result3 ? result3.success : 'N/A');
  
  console.log('\n====================================');
}


/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Survey Work Event
 */
function testSurveyWorkCalendarEvent() {
  console.log('========== Test Survey Work Calendar Event ==========');
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];
  
  const testData = {
    requestDate: tomorrowStr,
    startTime: '14:00',
    endTime: '15:00',
    description: 'Test Survey Work Event',
    location: 'Test Location',
    requesterName: 'Test User',
    requesterEmail: 'test@example.com',
    assignedTeam: 'Survey Team A'
  };
  
  const result = createSurveyWorkCalendarEvent(testData, 'TEST-001', 'SW-9999');
  
  console.log('========== Result ==========');
  console.log('Success:', result.success);
  
  if (result.success) {
    console.log('‚úÖ Event Created!');
    console.log('Event ID:', result.eventId);
    console.log('Guests:', result.guestsCount);
    console.log('Title:', result.eventTitle);
  } else {
    console.log('‚ùå Failed:', result.message);
  }
  
  console.log('==============================');
}

/**
 * üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Event (Fixed - ‡πÉ‡∏ä‡πâ + ‡πÅ‡∏ó‡∏ô ,)
 */
function findCreatedEvent() {
  Logger.log('========== Finding Event ==========');
  
  const eventId = 'g6ssbsse163n0rc16mm12deo5k';
  
  try {
    const calendar = CalendarApp.getDefaultCalendar();
    
    if (!calendar) {
      Logger.log('‚ùå Cannot access calendar');
      return;
    }
    
    const calName = calendar.getName();
    const calId = calendar.getId();
    
    Logger.log('‚úÖ Calendar Name: ' + calName);
    Logger.log('‚úÖ Calendar ID: ' + calId);
    
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 1);
    
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 30);
    
    Logger.log('Search from: ' + startDate.toLocaleDateString());
    Logger.log('Search to: ' + endDate.toLocaleDateString());
    
    const events = calendar.getEvents(startDate, endDate);
    const eventCount = events.length;
    
    Logger.log('Total events: ' + eventCount);
    Logger.log('');
    
    if (eventCount === 0) {
      Logger.log('‚ùå No events in calendar');
      Logger.log('');
      Logger.log('üîç Trying to find events in wider range...');
      
      // ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
      const wideStart = new Date();
      wideStart.setMonth(wideStart.getMonth() - 1);
      
      const wideEnd = new Date();
      wideEnd.setMonth(wideEnd.getMonth() + 3);
      
      const wideEvents = calendar.getEvents(wideStart, wideEnd);
      Logger.log('Events in wider range: ' + wideEvents.length);
      
      if (wideEvents.length > 0) {
        Logger.log('Found events:');
        for (var i = 0; i < Math.min(5, wideEvents.length); i++) {
          Logger.log((i + 1) + '. ' + wideEvents[i].getTitle());
          Logger.log('   Date: ' + wideEvents[i].getStartTime().toLocaleDateString());
        }
      }
      
      return;
    }
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ event
    let foundCount = 0;
    
    for (let i = 0; i < events.length; i++) {
      const event = events[i];
      const id = event.getId();
      const title = event.getTitle();
      
      if (title.indexOf('Survey Work') !== -1 || id.indexOf(eventId) !== -1) {
        foundCount++;
        Logger.log('');
        Logger.log('‚úÖ FOUND EVENT #' + foundCount + ':');
        Logger.log('   Title: ' + title);
        Logger.log('   ID: ' + id);
        Logger.log('   Start: ' + event.getStartTime().toLocaleString('th-TH'));
        Logger.log('   Location: ' + event.getLocation());
        
        const desc = event.getDescription();
        const descPreview = desc ? desc.substring(0, 100) : '(no description)';
        Logger.log('   Description: ' + descPreview + '...');
        
        const guests = event.getGuestList();
        Logger.log('   Guests: ' + guests.length + ' people');
        
        if (guests.length > 0) {
          for (var g = 0; g < Math.min(3, guests.length); g++) {
            Logger.log('      - ' + guests[g].getEmail());
          }
        }
        
        Logger.log('');
        
        if (id.indexOf(eventId) !== -1) {
          Logger.log('üéØ This is the target event!');
        }
      }
    }
    
    if (foundCount === 0) {
      Logger.log('');
      Logger.log('‚ö†Ô∏è No Survey Work events found');
      Logger.log('');
      Logger.log('üìã All events in range:');
      
      for (let i = 0; i < Math.min(10, events.length); i++) {
        Logger.log((i + 1) + '. ' + events[i].getTitle());
        Logger.log('   ' + events[i].getStartTime().toLocaleDateString());
      }
    } else {
      Logger.log('');
      Logger.log('üìä Summary: Found ' + foundCount + ' Survey Work event(s)');
    }
    
    Logger.log('===================================');
    
  } catch (error) {
    Logger.log('‚ùå Error: ' + error.toString());
    Logger.log('Stack: ' + error.stack);
  }
}


/**
 * üóìÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á Survey Work Calendar (Central)
 */
function createCentralSurveyCalendar() {
  Logger.log('========== Creating Central Survey Work Calendar ==========');
  
  try {
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const allCals = CalendarApp.getAllOwnedCalendars();
    
    for (let i = 0; i < allCals.length; i++) {
      if (allCals[i].getName() === 'Survey Work (Central)') {
        Logger.log('‚úÖ Calendar already exists');
        Logger.log('Name: ' + allCals[i].getName());
        Logger.log('ID: ' + allCals[i].getId());
        Logger.log('Owner: ' + Session.getActiveUser().getEmail());
        
        SpreadsheetApp.getUi().alert(
          'Calendar ID',
          allCals[i].getId(),
          SpreadsheetApp.getUi().ButtonSet.OK
        );
        
        return allCals[i];
      }
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    const calendar = CalendarApp.createCalendar('Survey Work (Central)', {
      summary: 'Central calendar for all Survey Work requests',
      color: CalendarApp.Color.GREEN
    });
    
    Logger.log('‚úÖ Created new calendar');
    Logger.log('Name: ' + calendar.getName());
    Logger.log('ID: ' + calendar.getId());
    Logger.log('Owner: ' + Session.getActiveUser().getEmail());
    
    SpreadsheetApp.getUi().alert(
      'Calendar Created! ‚úÖ',
      'Calendar ID:\n' + calendar.getId() + '\n\nCopy this ID!',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
    return calendar;
    
  } catch (error) {
    Logger.log('‚ùå Error: ' + error.toString());
    SpreadsheetApp.getUi().alert('Error: ' + error.toString());
  }
}
