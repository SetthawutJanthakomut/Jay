/**
 * ========================================
 * HOLIDAY MANAGEMENT SYSTEM
 * ========================================
 * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î - ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡πÄ‡∏™‡∏≤‡∏£‡πå
 * ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Sheet Holiday
 */

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Active (‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)
 */
function getActiveHolidays() {
  try {
    console.log('========== Getting Active Holidays ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holiday');
    
    if (!sheet) {
      console.log('‚ùå Holiday sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ö†Ô∏è No holidays found');
      return [];
    }
    
    // ‡∏î‡∏∂‡∏á Column A-C: Date, Name, Status
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    const holidays = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const date = row[0];
      const name = String(row[1] || '').trim();
      const status = String(row[2] || '').trim();
      
      // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Status = Active/Activated
      if (status !== 'Active' && status !== 'Activated') {
        continue;
      }
      
      if (date && date instanceof Date) {
        const dateStr = formatDate(date);
        
        holidays.push({
          date: dateStr,
          name: name,
          dateObj: new Date(date)
        });
        
        console.log('‚úÖ Holiday:', dateStr, '-', name);
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    holidays.sort(function(a, b) {
      return a.dateObj.getTime() - b.dateObj.getTime();
    });
    
    console.log('üìä Total active holidays:', holidays.length);
    console.log('=========================================');
    
    return holidays;
    
  } catch (error) {
    console.error('‚ùå Error getting holidays:', error);
    return [];
  }
}

/**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)
 */
function isHoliday(dateStr) {
  const holidays = getActiveHolidays();
  
  for (let i = 0; i < holidays.length; i++) {
    if (holidays[i].date === dateStr) {
      return holidays[i];
    }
  }
  
  return null;
}

/**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function isDayBeforeHoliday(dateStr) {
  const holidays = getActiveHolidays();
  const checkDate = new Date(dateStr + 'T00:00:00');
  const tomorrow = new Date(checkDate);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = formatDate(tomorrow);
  
  for (let i = 0; i < holidays.length; i++) {
    if (holidays[i].date === tomorrowStr) {
      return {
        isDayBefore: true,
        holidayName: holidays[i].name,
        holidayDate: holidays[i].date
      };
    }
  }
  
  return { isDayBefore: false };
}

/**
 * ‚≠ê ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
 */
function getNextHoliday(fromDateStr) {
  const holidays = getActiveHolidays();
  const fromDate = new Date(fromDateStr + 'T00:00:00');
  
  for (let i = 0; i < holidays.length; i++) {
    if (holidays[i].dateObj > fromDate) {
      return holidays[i];
    }
  }
  
  return null;
}

/**
 * ‚≠ê ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô
 */
function getConsecutiveHolidayCount(startDateStr) {
  const holidays = getActiveHolidays();
  const holidayDates = holidays.map(function(h) { return h.date; });
  
  let count = 0;
  let checkDate = new Date(startDateStr + 'T00:00:00');
  
  while (true) {
    const dateStr = formatDate(checkDate);
    
    if (holidayDates.indexOf(dateStr) !== -1) {
      count++;
      checkDate.setDate(checkDate.getDate() + 1);
    } else {
      break;
    }
  }
  
  return count;
}

/**
 * ‚≠ê ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
 */
function getNextWorkday(fromDateStr) {
  const holidays = getActiveHolidays();
  const holidayDates = holidays.map(function(h) { return h.date; });
  
  let checkDate = new Date(fromDateStr + 'T00:00:00');
  checkDate.setDate(checkDate.getDate() + 1);
  
  let daysChecked = 0;
  const maxDays = 14; // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
  
  while (daysChecked < maxDays) {
    const dateStr = formatDate(checkDate);
    
    // ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î = ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£
    if (holidayDates.indexOf(dateStr) === -1) {
      const dayOfWeek = checkDate.getDay();
      const dayName = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'][dayOfWeek];
      
      return {
        date: dateStr,
        dateThai: formatDateThai(dateStr),
        dayName: dayName,
        suggest: '‡∏ß‡∏±‡∏ô' + dayName + '‡∏ó‡∏µ‡πà ' + formatDateThai(dateStr)
      };
    }
    
    checkDate.setDate(checkDate.getDate() + 1);
    daysChecked++;
  }
  
  return {
    date: formatDate(checkDate),
    dateThai: formatDateThai(formatDate(checkDate)),
    suggest: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏° QC'
  };
}

/**
 * ‚≠ê MAIN: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (FIXED)
 */
function canBookDate(targetDateStr, inspectionType) {
  try {
    console.log('========== Checking if can book ==========');
    console.log('Target Date:', targetDateStr);
    console.log('Inspection Type:', inspectionType);
    
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const today = formatDate(now);
    
    const targetDate = new Date(targetDateStr + 'T00:00:00');
    const todayDate = new Date(today + 'T00:00:00');
    
    // ========================================
    // üö´ Rule 0: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)
    // ========================================
    const targetHoliday = isHoliday(targetDateStr);
    if (targetHoliday) {
      console.log('‚ùå Target date is holiday:', targetHoliday.name);
      
      const nextWorkday = getNextWorkday(targetDateStr);
      
      return {
        allowed: false,
        reason: 'target_is_holiday',
        title: '‚ùå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î',
        message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ' + targetHoliday.name + '\n' +
                'üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ\n' +
                'üíº ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå - ‡πÄ‡∏™‡∏≤‡∏£‡πå\n\n' +
                'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest,
        holidayName: targetHoliday.name,
        nextWorkday: nextWorkday.date,
        canBookFromThai: nextWorkday.dateThai
      };
    }
    
    // ========================================
    // üö´ Rule 1: ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î 00:00-13:00 - ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡πÄ‡∏•‡∏¢
    // ‚úÖ FIXED: ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    // ========================================
    const holidayToday = isHoliday(today);
    
    if (holidayToday && currentHour < 13) {
      console.log('‚ùå Currently in holiday (before 13:00)');
      
      // ‚úÖ FIX: ‡πÉ‡∏ä‡πâ getNextWorkday ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á‡πÜ
      const nextWorkday = getNextWorkday(today);
      
      // ‚úÖ FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô
      const consecutiveCount = getConsecutiveHolidayCount(today);
      let consecutiveMessage = '';
      
      if (consecutiveCount > 1) {
        consecutiveMessage = '\nüéâ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô';
      }
      
      return {
        allowed: false,
        reason: 'holiday_morning',
        title: 'üéâ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î',
        message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ' + holidayToday.name + consecutiveMessage + '\n' +
                '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 00:00-13:00 ‡∏ô.\n\n' +
                'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n' +
                '‚Ä¢ ‡∏£‡∏≠‡∏à‡∏ô‡∏ñ‡∏∂‡∏á 13:00 ‡∏ô. ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n' +
                '‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≠‡∏á' + nextWorkday.suggest + ' ‚Üê ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
        holidayName: holidayToday.name,
        nextWorkday: nextWorkday.date,
        nextWorkdayThai: nextWorkday.dateThai,
        canBookFrom: today + ' 13:00',
        consecutiveDays: consecutiveCount
      };
    }
    
    // ========================================
    // üö´ Rule 2: ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î 13:00+ - ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
    // ‚úÖ FIXED: ‡πÉ‡∏ä‡πâ getNextWorkday ‡πÅ‡∏ó‡∏ô
    // ========================================
    if (holidayToday && currentHour >= 13) {
      const tomorrow = new Date(todayDate);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = formatDate(tomorrow);
      
      if (targetDateStr === tomorrowStr) {
        console.log('‚ùå Holiday 13:00+ cannot book tomorrow');
        
        // ‚úÖ FIX: ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏≤‡∏Å tomorrow
        const nextWorkday = getNextWorkday(tomorrowStr);
        
        // ‚úÖ FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô
        const consecutiveCount = getConsecutiveHolidayCount(today);
        let consecutiveMessage = '';
        
        if (consecutiveCount > 1) {
          consecutiveMessage = '\nüéâ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô';
        }
        
        return {
          allowed: false,
          reason: 'holiday_afternoon_tomorrow',
          title: 'üéâ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏´‡∏•‡∏±‡∏á 13:00)',
          message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ' + holidayToday.name + consecutiveMessage + '\n' +
                  '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                  '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ\n\n' +
                  'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest + ' ‚Üê ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
          holidayName: holidayToday.name,
          canBookFrom: nextWorkday.date,
          canBookFromThai: nextWorkday.dateThai,
          consecutiveDays: consecutiveCount
        };
      }
    }
    
    // ========================================
    // üö´ Rule 3: ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏¢‡∏∏‡∏î 13:00+ - ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á 2 ‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    // ‚úÖ FIXED: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô
    // ========================================
    const dayBeforeCheck = isDayBeforeHoliday(today);
    
    if (dayBeforeCheck.isDayBefore && currentHour >= 13) {
      const tomorrow = new Date(todayDate);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = formatDate(tomorrow);
      
      const dayAfterTomorrow = new Date(tomorrow);
      dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);
      const dayAfterTomorrowStr = formatDate(dayAfterTomorrow);
      
      // ‚úÖ FIX: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô
      const consecutiveCount = getConsecutiveHolidayCount(tomorrowStr);
      
      // ‚úÖ FIX: ‡∏ñ‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏ß‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏´‡∏¢‡∏∏‡∏î + 1 ‡∏ß‡∏±‡∏ô
      let blockedDate = new Date(tomorrowStr + 'T00:00:00');
      const blockedDates = [];
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î + 1 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
      for (let i = 0; i <= consecutiveCount; i++) {
        blockedDates.push(formatDate(blockedDate));
        blockedDate.setDate(blockedDate.getDate() + 1);
      }
      
      console.log('Blocked dates:', blockedDates);
      
      if (blockedDates.indexOf(targetDateStr) !== -1) {
        console.log('‚ùå Day before holiday 13:00+ cannot book blocked dates');
        
        // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ
        const lastBlockedDate = blockedDates[blockedDates.length - 1];
        const nextWorkday = getNextWorkday(lastBlockedDate);
        
        return {
          allowed: false,
          reason: 'day_before_holiday',
          title: 'üìÖ ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î',
          message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ: ' + dayBeforeCheck.holidayName + 
                  '\nüéâ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô' +
                  '\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                  '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á ' + formatDateThai(lastBlockedDate) + '\n\n' +
                  'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest + ' ‚Üê ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
          holidayName: dayBeforeCheck.holidayName,
          holidayDate: dayBeforeCheck.holidayDate,
          canBookFrom: nextWorkday.date,
          canBookFromThai: nextWorkday.dateThai,
          consecutiveDays: consecutiveCount,
          blockedDates: blockedDates
        };
      }
    }
    
    // ========================================
    // ‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ
    // ========================================
    console.log('‚úÖ Can book this date');
    
    // üí° Warning ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß
    const nextHoliday = getNextHoliday(targetDateStr);
    if (nextHoliday) {
      const daysUntilHoliday = Math.ceil(
        (nextHoliday.dateObj.getTime() - targetDate.getTime()) / (1000 * 60 * 60 * 24)
      );
      
      if (daysUntilHoliday <= 2 && daysUntilHoliday > 0) {
        const consecutiveCount = getConsecutiveHolidayCount(nextHoliday.date);
        
        if (consecutiveCount >= 2) {
          return {
            allowed: true,
            warning: true,
            title: '‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ' + formatDateThai(targetDateStr) + '\n' +
                    'üéâ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ' + nextHoliday.name + ' (' + formatDateThai(nextHoliday.date) + ')\n' +
                    'üìÜ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô\n\n' +
                    'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô',
            nextHoliday: nextHoliday,
            consecutiveDays: consecutiveCount,
            daysUntil: daysUntilHoliday
          };
        }
      }
    }
    
    return {
      allowed: true
    };
    
  } catch (error) {
    console.error('‚ùå Error checking booking:', error);
    return {
      allowed: true,
      error: error.toString()
    };
  }
}

/**
 * ========================================
 * SUNDAY MANAGEMENT
 * ========================================
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÉ‡∏ô Sheet Holiday
 */

/**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÉ‡∏ô Sheet ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
 */
function checkSundaysInYear(year) {
  try {
    console.log('========== Checking Sundays in Year', year, '==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holiday');
    
    if (!sheet) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Holiday"');
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return {
        total: 0,
        existing: 0,
        missing: 52
      };
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    
    // ‡∏´‡∏≤ Sunday ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏õ‡∏µ
    let date = new Date(year, 0, 1);
    while (date.getDay() !== 0) {
      date.setDate(date.getDate() + 1);
    }
    
    const allSundays = [];
    while (date.getFullYear() === year) {
      allSundays.push(formatDate(date));
      date.setDate(date.getDate() + 7);
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÉ‡∏ô Sheet ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const existingSundays = [];
    
    for (let i = 0; i < data.length; i++) {
      const rowDate = data[i][0];
      const name = String(data[i][1] || '').trim();
      
      if (rowDate instanceof Date && name === '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå') {
        const dateStr = formatDate(rowDate);
        if (allSundays.indexOf(dateStr) !== -1) {
          existingSundays.push(dateStr);
        }
      }
    }
    
    console.log('Total Sundays in year:', allSundays.length);
    console.log('Existing in Sheet:', existingSundays.length);
    console.log('Missing:', allSundays.length - existingSundays.length);
    
    return {
      total: allSundays.length,
      existing: existingSundays.length,
      missing: allSundays.length - existingSundays.length,
      existingDates: existingSundays,
      allDates: allSundays
    };
    
  } catch (error) {
    console.error('‚ùå Error checking Sundays:', error);
    throw error;
  }
}

/**
 * ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
 */
function addMissingSundaysForYear(year) {
  try {
    console.log('========== Adding Missing Sundays for Year', year, '==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holiday');
    
    if (!sheet) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Holiday"');
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Sunday ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
    const checkResult = checkSundaysInYear(year);
    
    if (checkResult.missing === 0) {
      console.log('‚úÖ All Sundays already exist in Sheet');
      return {
        success: true,
        added: 0,
        message: '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏õ‡∏µ ' + year + ' ‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'
      };
    }
    
    // ‡∏´‡∏≤ Sunday ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    const missingSundays = [];
    
    for (let i = 0; i < checkResult.allDates.length; i++) {
      const dateStr = checkResult.allDates[i];
      
      if (checkResult.existingDates.indexOf(dateStr) === -1) {
        const dateObj = new Date(dateStr + 'T00:00:00');
        missingSundays.push([
          dateObj,
          '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå',
          'Active'
        ]);
      }
    }
    
    if (missingSundays.length === 0) {
      return {
        success: true,
        added: 0,
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°'
      };
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á Sheet
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow + 1, 1, missingSundays.length, 3).setValues(missingSundays);
    
    console.log('‚úÖ Added', missingSundays.length, 'missing Sundays');
    
    return {
      success: true,
      added: missingSundays.length,
      message: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß ' + missingSundays.length + ' ‡∏ß‡∏±‡∏ô'
    };
    
  } catch (error) {
    console.error('‚ùå Error adding Sundays:', error);
    return {
      success: false,
      message: error.toString()
    };
  }
}

/**
 * üöÄ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ) - UI Version
 */
function updateSundaysUI() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ‡∏ñ‡∏≤‡∏°‡∏õ‡∏µ
    const response = ui.prompt(
      'üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå',
      '‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡πÄ‡∏ä‡πà‡∏ô 2025, 2026):',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    const yearInput = response.getResponseText().trim();
    const year = parseInt(yearInput);
    
    if (!year || isNaN(year) || year < 2000 || year > 2100) {
      ui.alert(
        '‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (2000-2100)',
        ui.ButtonSet.OK
      );
      return;
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const checkResult = checkSundaysInYear(year);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    const confirmResponse = ui.alert(
      'üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏õ‡∏µ ' + year,
      'üìÖ ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + checkResult.total + ' ‡∏ß‡∏±‡∏ô\n' +
      '‚úÖ ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ' + checkResult.existing + ' ‡∏ß‡∏±‡∏ô\n' +
      '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ: ' + checkResult.missing + ' ‡∏ß‡∏±‡∏ô\n\n' +
      (checkResult.missing > 0 ? 
        '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?' : 
        '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°'),
      ui.ButtonSet.YES_NO
    );
    
    if (confirmResponse !== ui.Button.YES || checkResult.missing === 0) {
      return;
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
    const result = addMissingSundaysForYear(year);
    
    if (result.success && result.added > 0) {
      ui.alert(
        '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
        'üìÖ ‡∏õ‡∏µ: ' + year + '\n' +
        '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß: ' + result.added + ' ‡∏ß‡∏±‡∏ô\n' +
        'üìã Status: Active\n\n' +
        'üí° ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
        ui.ButtonSet.OK
      );
    } else if (result.success && result.added === 0) {
      ui.alert(
        '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ',
        result.message,
        ui.ButtonSet.OK
      );
    } else {
      ui.alert(
        '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚ùå',
        result.message,
        ui.ButtonSet.OK
      );
    }
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      error.toString(),
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}

/**
 * üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
 */
function testSundaySystem() {
  console.log('========== Testing Sunday System ==========');
  
  const testYear = 2025;
  
  console.log('\n1Ô∏è‚É£ Check Sundays in year', testYear);
  const checkResult = checkSundaysInYear(testYear);
  console.log('Result:', checkResult);
  
  console.log('\n========== Test Complete ==========');
  
  SpreadsheetApp.getUi().alert(
    '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‚úÖ',
    '‡∏õ‡∏µ ' + testYear + ':\n' +
    '‚Ä¢ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + checkResult.total + ' ‡∏ß‡∏±‡∏ô\n' +
    '‚Ä¢ ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ' + checkResult.existing + ' ‡∏ß‡∏±‡∏ô\n' +
    '‚Ä¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ: ' + checkResult.missing + ' ‡∏ß‡∏±‡∏ô\n\n' +
    '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Logs',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}
