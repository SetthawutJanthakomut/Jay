/**
 * ========================================
 * HOLIDAY MANAGEMENT SYSTEM (FIXED)
 * ========================================
 * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î - ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡πÄ‡∏™‡∏≤‡∏£‡πå
 * ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Sheet Holiday
 * 
 * üîß FIXED: External ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‚Üí ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ +2
 */

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Active (‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)
 */
function getActiveHolidays() {
  try {
    console.log('========== Getting Active Holidays ==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holiday');
    
    if (!sheet) {
      console.log('‚ùå Holiday sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('‚ö†Ô∏è No holidays found');
      return [];
    }
    
    // ‡∏î‡∏∂‡∏á Column A-C: Date, Name, Status
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    const holidays = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const date = row[0];
      const name = String(row[1] || '').trim();
      const status = String(row[2] || '').trim();
      
      // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Status = Active/Activated
      if (status !== 'Active' && status !== 'Activated') {
        continue;
      }
      
      if (date && date instanceof Date) {
        const dateStr = formatDate(date);
        
        holidays.push({
          date: dateStr,
          name: name,
          dateObj: new Date(date)
        });
        
        console.log('‚úÖ Holiday:', dateStr, '-', name);
      }
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    holidays.sort(function(a, b) {
      return a.dateObj.getTime() - b.dateObj.getTime();
    });
    
    console.log('üìä Total active holidays:', holidays.length);
    console.log('=========================================');
    
    return holidays;
    
  } catch (error) {
    console.error('‚ùå Error getting holidays:', error);
    return [];
  }
}

/**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)
 */
function isHoliday(dateStr) {
  const holidays = getActiveHolidays();
  
  for (let i = 0; i < holidays.length; i++) {
    if (holidays[i].date === dateStr) {
      return holidays[i];
    }
  }
  
  return null;
}

/**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function isDayBeforeHoliday(dateStr) {
  const holidays = getActiveHolidays();
  const checkDate = new Date(dateStr + 'T00:00:00');
  const tomorrow = new Date(checkDate);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = formatDate(tomorrow);
  
  for (let i = 0; i < holidays.length; i++) {
    if (holidays[i].date === tomorrowStr) {
      return {
        isDayBefore: true,
        holidayName: holidays[i].name,
        holidayDate: holidays[i].date
      };
    }
  }
  
  return { isDayBefore: false };
}

/**
 * ‚≠ê ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
 */
function getNextHoliday(fromDateStr) {
  const holidays = getActiveHolidays();
  const fromDate = new Date(fromDateStr + 'T00:00:00');
  
  for (let i = 0; i < holidays.length; i++) {
    if (holidays[i].dateObj > fromDate) {
      return holidays[i];
    }
  }
  
  return null;
}

/**
 * ‚≠ê ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô
 */
function getConsecutiveHolidayCount(startDateStr) {
  const holidays = getActiveHolidays();
  const holidayDates = holidays.map(function(h) { return h.date; });
  
  let count = 0;
  let checkDate = new Date(startDateStr + 'T00:00:00');
  
  while (true) {
    const dateStr = formatDate(checkDate);
    
    if (holidayDates.indexOf(dateStr) !== -1) {
      count++;
      checkDate.setDate(checkDate.getDate() + 1);
    } else {
      break;
    }
  }
  
  return count;
}

/**
 * ‚≠ê ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
 */
function getNextWorkday(fromDateStr) {
  const holidays = getActiveHolidays();
  const holidayDates = holidays.map(function(h) { return h.date; });
  
  let checkDate = new Date(fromDateStr + 'T00:00:00');
  checkDate.setDate(checkDate.getDate() + 1);
  
  let daysChecked = 0;
  const maxDays = 14; // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
  
  while (daysChecked < maxDays) {
    const dateStr = formatDate(checkDate);
    
    // ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î = ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£
    if (holidayDates.indexOf(dateStr) === -1) {
      const dayOfWeek = checkDate.getDay();
      const dayName = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'][dayOfWeek];
      
      return {
        date: dateStr,
        dateThai: formatDateThai(dateStr),
        dayName: dayName,
        suggest: '‡∏ß‡∏±‡∏ô' + dayName + '‡∏ó‡∏µ‡πà ' + formatDateThai(dateStr)
      };
    }
    
    checkDate.setDate(checkDate.getDate() + 1);
    daysChecked++;
  }
  
  return {
    date: formatDate(checkDate),
    dateThai: formatDateThai(formatDate(checkDate)),
    suggest: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏° QC'
  };
}

/**
 * ‚≠ê MAIN: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Internal, External, Survey)
 */
function canBookDate(targetDateStr, inspectionType) {
  try {
    console.log('========== Checking if can book ==========');
    console.log('Target Date:', targetDateStr);
    console.log('Inspection Type:', inspectionType);
    
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const today = formatDate(now);
    
    const targetDate = new Date(targetDateStr + 'T00:00:00');
    const todayDate = new Date(today + 'T00:00:00');
    
    // ========================================
    // üö´ Rule 0: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡πÅ‡∏¢‡∏Å Internal/External/Survey)
    // ========================================
    const targetHoliday = isHoliday(targetDateStr);
    if (targetHoliday) {
      console.log('Target date is holiday:', targetHoliday.name);
      
      if (inspectionType === 'internal' || inspectionType === 'survey') {
        // ========================================
        // üè¢ INTERNAL & üó∫Ô∏è SURVEY: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)
        // ========================================
        
        const holidayToday = isHoliday(today);
        
        // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (holidayToday) {
          // ‚ùå ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)
          console.log('‚ùå ' + inspectionType + ': Today is holiday, cannot book any holiday');
          
          const nextWorkday = getNextWorkday(today);
          const consecutiveCount = getConsecutiveHolidayCount(today);
          let consecutiveMessage = '';
          
          if (consecutiveCount > 1) {
            consecutiveMessage = '\nüéâ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô';
          }
          
          const typeLabel = inspectionType === 'survey' ? 'Survey Work' : 'Internal';
          const typeIcon = inspectionType === 'survey' ? 'üó∫Ô∏è' : 'üè¢';
          
          return {
            allowed: false,
            reason: 'today_holiday_cannot_book_holiday',
            title: 'üéâ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (' + typeLabel + ')',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ' + holidayToday.name + consecutiveMessage + '\n' +
                    '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                    '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ (' + typeLabel + ')\n\n' +
                    'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest + ' ‚Üê ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ\n\n' +
                    'üìå ' + typeIcon + ' ' + typeLabel + ':\n' +
                    '   ‚Ä¢ ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)\n' +
                    '   ‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
            holidayName: holidayToday.name,
            nextWorkday: nextWorkday.date,
            nextWorkdayThai: nextWorkday.dateThai,
            consecutiveDays: consecutiveCount
          };
        }
        
        // ‚úÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
        const targetDateObj = new Date(targetDateStr + 'T00:00:00');
        const todayDateObj = new Date(today + 'T00:00:00');
        const daysDiff = Math.ceil((targetDateObj.getTime() - todayDateObj.getTime()) / (1000 * 60 * 60 * 24));
        
        console.log('Days difference:', daysDiff);
        console.log('Current hour:', currentHour);
        console.log('Today is workday, checking booking conditions for holiday');
        
        const typeLabel = inspectionType === 'survey' ? 'Survey Work' : 'Internal';
        const typeIcon = inspectionType === 'survey' ? 'üó∫Ô∏è' : 'üè¢';
        
        // ‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (Internal & Survey):
        // 1. ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‚â•1 ‡∏ß‡∏±‡∏ô (daysDiff >= 1)
        // 2. ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ (daysDiff = 1) ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô.
        
        if (daysDiff === 1 && currentHour >= 13) {
          // ‚ùå ‡∏à‡∏≠‡∏á‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏±‡∏á 13:00 ‡∏ô. ‡πÅ‡∏•‡πâ‡∏ß
          console.log('‚ùå ' + inspectionType + ': Too late to book tomorrow holiday');
          
          const nextWorkday = getNextWorkday(targetDateStr);
          
          return {
            allowed: false,
            reason: 'too_late_book_holiday',
            title: '‚è∞ ‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ' + targetHoliday.name + ' (' + formatDateThai(targetDateStr) + ')\n' +
                    '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                    '‚ùå ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏¢‡∏∏‡∏î)\n\n' +
                    'üí° ' + typeIcon + ' ' + typeLabel + ': ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á:\n' +
                    '   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£\n' +
                    '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‚â•1 ‡∏ß‡∏±‡∏ô\n' +
                    '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏¢‡∏∏‡∏î\n\n' +
                    'üíº ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest + ' (‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£)',
            holidayName: targetHoliday.name,
            nextWorkday: nextWorkday.date,
            canBookFromThai: nextWorkday.dateThai
          };
          
        } else if (daysDiff === 1 && currentHour < 13) {
          // ‚úÖ ‡∏à‡∏≠‡∏á‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. - ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï!
          console.log('‚úÖ ' + inspectionType + ': Allowed to book tomorrow holiday (before 13:00)');
          
          return {
            allowed: true,
            warning: true,
            title: '‚úÖ ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ (' + typeLabel + ')',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ' + targetHoliday.name + ' (' + formatDateThai(targetDateStr) + ')\n' +
                    '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô. (‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. ‚úì)\n' +
                    '‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ (' + typeIcon + ' ' + typeLabel + ')\n\n' +
                    'üí° ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:\n' +
                    '   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‚úì\n' +
                    '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏ß‡∏±‡∏ô ‚úì\n' +
                    '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. ‚úì\n' +
                    '   ‚Ä¢ Calendar ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
            holidayName: targetHoliday.name
          };
          
        } else if (daysDiff > 1) {
          // ‚úÖ ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ >1 ‡∏ß‡∏±‡∏ô - ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï!
          console.log('‚úÖ ' + inspectionType + ': Allowed to book holiday (advanced booking)');
          
          return {
            allowed: true,
            warning: true,
            title: '‚úÖ ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ (' + typeLabel + ')',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ' + targetHoliday.name + ' (' + formatDateThai(targetDateStr) + ')\n' +
                    '‚è∞ ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤: ' + daysDiff + ' ‡∏ß‡∏±‡∏ô\n' +
                    '‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ (' + typeIcon + ' ' + typeLabel + ')\n\n' +
                    'üí° ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:\n' +
                    '   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‚úì\n' +
                    '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‚â•1 ‡∏ß‡∏±‡∏ô ‚úì\n' +
                    '   ‚Ä¢ Calendar ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
            holidayName: targetHoliday.name
          };
          
        } else {
          // ‚ùå ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (daysDiff = 0) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
          console.log('‚ùå ' + inspectionType + ': Cannot book holiday on the same day');
          
          const nextWorkday = getNextWorkday(targetDateStr);
          
          return {
            allowed: false,
            reason: 'same_day_holiday',
            title: '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ' + targetHoliday.name + '\n' +
                    '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ\n\n' +
                    'üí° ' + typeIcon + ' ' + typeLabel + ': ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á:\n' +
                    '   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£\n' +
                    '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‚â•1 ‡∏ß‡∏±‡∏ô\n' +
                    '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô 13:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏¢‡∏∏‡∏î\n\n' +
                    'üíº ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest + ' (‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£)',
            holidayName: targetHoliday.name,
            nextWorkday: nextWorkday.date,
            canBookFromThai: nextWorkday.dateThai
          };
        }
        
      } else {
        // ========================================
        // ü§ù EXTERNAL: ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
        // ========================================
        console.log('‚ùå External: Target date is holiday - not allowed');
        
        const nextWorkday = getNextWorkday(targetDateStr);
        
        return {
          allowed: false,
          reason: 'target_is_holiday',
          title: '‚ùå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (External)',
          message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ' + targetHoliday.name + '\n' +
                  'üö´ External Inspection ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ\n' +
                  'üíº ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå - ‡πÄ‡∏™‡∏≤‡∏£‡πå\n\n' +
                  'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest,
          holidayName: targetHoliday.name,
          nextWorkday: nextWorkday.date,
          canBookFromThai: nextWorkday.dateThai
        };
      }
    }
    
    // ========================================
    // ‚úÖ ‡πÅ‡∏¢‡∏Å Logic ‡∏ï‡∏≤‡∏° Inspection Type
    // ========================================
    
    if (inspectionType === 'internal' || inspectionType === 'survey') {
      // ========================================
      // üè¢ INTERNAL & üó∫Ô∏è SURVEY (Lead Time: 30 ‡∏ô‡∏≤‡∏ó‡∏µ)
      // ========================================
      
      const holidayToday = isHoliday(today);
      
      // üö´ Rule 1: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏¢‡∏∏‡∏î ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (09:00-17:00)
      if (holidayToday) {
        const isWorkingHours = (currentHour >= 9 && currentHour < 17);
        
        const typeLabel = inspectionType === 'survey' ? 'Survey Work' : 'Internal';
        const typeIcon = inspectionType === 'survey' ? 'üó∫Ô∏è' : 'üè¢';
        
        if (isWorkingHours && targetDateStr === today) {
          // ‚úÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î + ‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ + ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï!
          console.log('‚úÖ ' + inspectionType + ': Today is holiday but within working hours (09:00-17:00), same-day booking allowed');
          
          return {
            allowed: true,
            warning: true,
            title: '‚úÖ ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ (' + typeLabel + ' - ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£)',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: ' + holidayToday.name + ' (' + formatDateThai(today) + ')\n' +
                    '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                    '‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (09:00-17:00) ‚Üí ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!\n\n' +
                    'üí° ' + typeIcon + ' ' + typeLabel + ':\n' +
                    '   ‚Ä¢ Same-day booking ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (09:00-17:00) ‚úì\n' +
                    '   ‚Ä¢ Calendar ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
            holidayName: holidayToday.name
          };
          
        } else if (!isWorkingHours) {
          // ‚ùå ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≠‡∏á
          console.log('‚ùå ' + inspectionType + ': Today is holiday but outside working hours');
          
          const nextWorkday = getNextWorkday(today);
          const consecutiveCount = getConsecutiveHolidayCount(today);
          let consecutiveMessage = '';
          
          if (consecutiveCount > 1) {
            consecutiveMessage = '\nüéâ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô';
          }
          
          return {
            allowed: false,
            reason: 'today_holiday_outside_hours',
            title: '‚è∞ ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (' + typeLabel + ')',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ' + holidayToday.name + consecutiveMessage + '\n' +
                    '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                    '‚ùå ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (09:00-17:00)\n\n' +
                    'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest + ' ‚Üê ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ\n\n' +
                    'üìå ' + typeIcon + ' ' + typeLabel + ':\n' +
                    '   ‚Ä¢ ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 09:00-17:00 ‡∏ô.\n' +
                    '   ‚Ä¢ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß',
            holidayName: holidayToday.name,
            nextWorkday: nextWorkday.date,
            nextWorkdayThai: nextWorkday.dateThai,
            consecutiveDays: consecutiveCount
          };
        }
      }
      
      // ‚úÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‚Üí ‡πÑ‡∏°‡πà‡∏°‡∏µ Rule ‡∏≠‡∏∑‡πà‡∏ô
      console.log('‚úÖ ' + inspectionType + ': Today is workday, no additional restrictions');
      
    } else {
      // ========================================
      // ü§ù EXTERNAL INSPECTION (Lead Time: ‚â•1 ‡∏ß‡∏±‡∏ô)
      // ========================================
      
      const holidayToday = isHoliday(today);
      
      if (holidayToday) {
        console.log('‚ùå External: Currently in holiday (any time)');
        
        const firstWorkday = getNextWorkday(today);
        const nextBookableDate = new Date(firstWorkday.date + 'T00:00:00');
        nextBookableDate.setDate(nextBookableDate.getDate() + 1);
        const nextBookable = getNextWorkday(formatDate(new Date(nextBookableDate.getTime() - 24*60*60*1000)));
        
        const consecutiveCount = getConsecutiveHolidayCount(today);
        let consecutiveMessage = '';
        
        if (consecutiveCount > 1) {
          consecutiveMessage = '\nüéâ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô';
        }
        
        return {
          allowed: false,
          reason: 'holiday_today_external',
          title: 'üéâ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (External)',
          message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ' + holidayToday.name + consecutiveMessage + '\n' +
                  '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                  '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á External ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î\n' +
                  'üìã External Lead Time: ‚â•1 ‡∏ß‡∏±‡∏ô (‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£)\n\n' +
                  'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextBookable.suggest + ' ‚Üê ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î\n\n' +
                  'üìå ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:\n' +
                  '   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ' + firstWorkday.dateThai + '\n' +
                  '   ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á Lead Time +1 ‡∏ß‡∏±‡∏ô ‚Üí ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ' + nextBookable.dateThai,
          holidayName: holidayToday.name,
          nextWorkday: nextBookable.date,
          nextWorkdayThai: nextBookable.dateThai,
          consecutiveDays: consecutiveCount
        };
      }
      
      const dayBeforeCheck = isDayBeforeHoliday(today);
      
      if (dayBeforeCheck.isDayBefore && currentHour >= 13) {
        const tomorrow = new Date(todayDate);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = formatDate(tomorrow);
        
        const consecutiveCount = getConsecutiveHolidayCount(tomorrowStr);
        
        let blockedDate = new Date(tomorrowStr + 'T00:00:00');
        const blockedDates = [];
        
        for (let i = 0; i <= consecutiveCount; i++) {
          blockedDates.push(formatDate(blockedDate));
          blockedDate.setDate(blockedDate.getDate() + 1);
        }
        
        console.log('Blocked dates (External only):', blockedDates);
        
        if (blockedDates.indexOf(targetDateStr) !== -1) {
          console.log('‚ùå External: Day before holiday 13:00+ cannot book blocked dates');
          
          const lastBlockedDate = blockedDates[blockedDates.length - 1];
          const nextWorkday = getNextWorkday(lastBlockedDate);
          
          return {
            allowed: false,
            reason: 'day_before_holiday_external',
            title: 'üìÖ ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (External)',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ: ' + dayBeforeCheck.holidayName + 
                    '\nüéâ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô' +
                    '\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + currentHour + ':' + String(currentMinute).padStart(2, '0') + ' ‡∏ô.\n' +
                    '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á ' + formatDateThai(lastBlockedDate) + '\n' +
                    'üìã External Lead Time: ‚â•1 ‡∏ß‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)\n\n' +
                    'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏à‡∏≠‡∏á' + nextWorkday.suggest + ' ‚Üê ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
            holidayName: dayBeforeCheck.holidayName,
            holidayDate: dayBeforeCheck.holidayDate,
            canBookFrom: nextWorkday.date,
            canBookFromThai: nextWorkday.dateThai,
            consecutiveDays: consecutiveCount,
            blockedDates: blockedDates
          };
        }
      }
    }
    
    // ‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ
    console.log('‚úÖ Can book this date');
    
    const nextHoliday = getNextHoliday(targetDateStr);
    if (nextHoliday) {
      const daysUntilHoliday = Math.ceil(
        (nextHoliday.dateObj.getTime() - targetDate.getTime()) / (1000 * 60 * 60 * 24)
      );
      
      if (daysUntilHoliday <= 2 && daysUntilHoliday > 0) {
        const consecutiveCount = getConsecutiveHolidayCount(nextHoliday.date);
        
        if (consecutiveCount >= 2) {
          return {
            allowed: true,
            warning: true,
            title: '‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß',
            message: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ' + formatDateThai(targetDateStr) + '\n' +
                    'üéâ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ' + nextHoliday.name + ' (' + formatDateThai(nextHoliday.date) + ')\n' +
                    'üìÜ ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ' + consecutiveCount + ' ‡∏ß‡∏±‡∏ô\n\n' +
                    'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô',
            nextHoliday: nextHoliday,
            consecutiveDays: consecutiveCount,
            daysUntil: daysUntilHoliday
          };
        }
      }
    }
    
    return {
      allowed: true
    };
    
  } catch (error) {
    console.error('‚ùå Error checking booking:', error);
    return {
      allowed: true,
      error: error.toString()
    };
  }
}


/**
 * ========================================
 * SUNDAY MANAGEMENT
 * ========================================
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÉ‡∏ô Sheet Holiday
 */

/**
 * ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÉ‡∏ô Sheet ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
 */
function checkSundaysInYear(year) {
  try {
    console.log('========== Checking Sundays in Year', year, '==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holiday');
    
    if (!sheet) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Holiday"');
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return {
        total: 0,
        existing: 0,
        missing: 52
      };
    }
    
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    
    // ‡∏´‡∏≤ Sunday ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏õ‡∏µ
    let date = new Date(year, 0, 1);
    while (date.getDay() !== 0) {
      date.setDate(date.getDate() + 1);
    }
    
    const allSundays = [];
    while (date.getFullYear() === year) {
      allSundays.push(formatDate(date));
      date.setDate(date.getDate() + 7);
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÉ‡∏ô Sheet ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const existingSundays = [];
    
    for (let i = 0; i < data.length; i++) {
      const rowDate = data[i][0];
      const name = String(data[i][1] || '').trim();
      
      if (rowDate instanceof Date && name === '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå') {
        const dateStr = formatDate(rowDate);
        if (allSundays.indexOf(dateStr) !== -1) {
          existingSundays.push(dateStr);
        }
      }
    }
    
    console.log('Total Sundays in year:', allSundays.length);
    console.log('Existing in Sheet:', existingSundays.length);
    console.log('Missing:', allSundays.length - existingSundays.length);
    
    return {
      total: allSundays.length,
      existing: existingSundays.length,
      missing: allSundays.length - existingSundays.length,
      existingDates: existingSundays,
      allDates: allSundays
    };
    
  } catch (error) {
    console.error('‚ùå Error checking Sundays:', error);
    throw error;
  }
}

/**
 * ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
 */
function addMissingSundaysForYear(year) {
  try {
    console.log('========== Adding Missing Sundays for Year', year, '==========');
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holiday');
    
    if (!sheet) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet "Holiday"');
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Sunday ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
    const checkResult = checkSundaysInYear(year);
    
    if (checkResult.missing === 0) {
      console.log('‚úÖ All Sundays already exist in Sheet');
      return {
        success: true,
        added: 0,
        message: '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏õ‡∏µ ' + year + ' ‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'
      };
    }
    
    // ‡∏´‡∏≤ Sunday ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    const missingSundays = [];
    
    for (let i = 0; i < checkResult.allDates.length; i++) {
      const dateStr = checkResult.allDates[i];
      
      if (checkResult.existingDates.indexOf(dateStr) === -1) {
        const dateObj = new Date(dateStr + 'T00:00:00');
        missingSundays.push([
          dateObj,
          '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå',
          'Active'
        ]);
      }
    }
    
    if (missingSundays.length === 0) {
      return {
        success: true,
        added: 0,
        message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°'
      };
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á Sheet
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow + 1, 1, missingSundays.length, 3).setValues(missingSundays);
    
    console.log('‚úÖ Added', missingSundays.length, 'missing Sundays');
    
    return {
      success: true,
      added: missingSundays.length,
      message: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß ' + missingSundays.length + ' ‡∏ß‡∏±‡∏ô'
    };
    
  } catch (error) {
    console.error('‚ùå Error adding Sundays:', error);
    return {
      success: false,
      message: error.toString()
    };
  }
}

/**
 * üöÄ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ) - UI Version
 */
function updateSundaysUI() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // ‡∏ñ‡∏≤‡∏°‡∏õ‡∏µ
    const response = ui.prompt(
      'üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå',
      '‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡πÄ‡∏ä‡πà‡∏ô 2025, 2026):',
      ui.ButtonSet.OK_CANCEL
    );
    
    if (response.getSelectedButton() !== ui.Button.OK) {
      return;
    }
    
    const yearInput = response.getResponseText().trim();
    const year = parseInt(yearInput);
    
    if (!year || isNaN(year) || year < 2000 || year > 2100) {
      ui.alert(
        '‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (2000-2100)',
        ui.ButtonSet.OK
      );
      return;
    }
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const checkResult = checkSundaysInYear(year);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    const confirmResponse = ui.alert(
      'üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏õ‡∏µ ' + year,
      'üìÖ ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + checkResult.total + ' ‡∏ß‡∏±‡∏ô\n' +
      '‚úÖ ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ' + checkResult.existing + ' ‡∏ß‡∏±‡∏ô\n' +
      '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ: ' + checkResult.missing + ' ‡∏ß‡∏±‡∏ô\n\n' +
      (checkResult.missing > 0 ? 
        '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?' : 
        '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°'),
      ui.ButtonSet.YES_NO
    );
    
    if (confirmResponse !== ui.Button.YES || checkResult.missing === 0) {
      return;
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
    const result = addMissingSundaysForYear(year);
    
    if (result.success && result.added > 0) {
      ui.alert(
        '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
        'üìÖ ‡∏õ‡∏µ: ' + year + '\n' +
        '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß: ' + result.added + ' ‡∏ß‡∏±‡∏ô\n' +
        'üìã Status: Active\n\n' +
        'üí° ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
        ui.ButtonSet.OK
      );
    } else if (result.success && result.added === 0) {
      ui.alert(
        '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ',
        result.message,
        ui.ButtonSet.OK
      );
    } else {
      ui.alert(
        '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚ùå',
        result.message,
        ui.ButtonSet.OK
      );
    }
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    SpreadsheetApp.getUi().alert(
      '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      error.toString(),
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}

/**
 * üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
 */
function testSundaySystem() {
  console.log('========== Testing Sunday System ==========');
  
  const testYear = 2025;
  
  console.log('\n1Ô∏è‚É£ Check Sundays in year', testYear);
  const checkResult = checkSundaysInYear(testYear);
  console.log('Result:', checkResult);
  
  console.log('\n========== Test Complete ==========');
  
  SpreadsheetApp.getUi().alert(
    '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‚úÖ',
    '‡∏õ‡∏µ ' + testYear + ':\n' +
    '‚Ä¢ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + checkResult.total + ' ‡∏ß‡∏±‡∏ô\n' +
    '‚Ä¢ ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ' + checkResult.existing + ' ‡∏ß‡∏±‡∏ô\n' +
    '‚Ä¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ: ' + checkResult.missing + ' ‡∏ß‡∏±‡∏ô\n\n' +
    '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Logs',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}
