// Version 0 17/10/2025 13:41
// à¹ƒà¸ªà¹ˆ Spreadsheet ID à¸‚à¸­à¸‡ Survey System
const SURVEY_SPREADSHEET_ID = '1rWMUNNDbbLbHljs2GsU6fzrJDjHsutS7nMvElGUNTQk';
const CALENDAR_ID = 'primary';

// ====== UPDATED: à¹€à¸à¸´à¹ˆà¸¡ uniqueId, SurveyEmail à¹à¸¥à¸° Assigned_Inspector parameter ======
function createSurveyFromRFI(uniqueId, rfiId, date, startTime, endTime, description, location, requesterName, requesterEmail, note, guest, SurveyEmail, Assigned_Inspector) {
  const rfiData = {
    uniqueId: uniqueId || '',
    rfiId: rfiId || '',
    date: date || '',
    startTime: startTime || '',
    endTime: endTime || '',
    description: description || '',
    location: location || '',
    requesterName: requesterName || '',
    requesterEmail: requesterEmail || '',
    note: note || '',
    guest: guest || '',
    surveyEmail: SurveyEmail || '',  // âœ… à¹€à¸à¸´à¹ˆà¸¡ Survey Email
    assignedInspector: Assigned_Inspector || ''  // âœ… à¹€à¸à¸´à¹ˆà¸¡ Assigned Inspector
  };
  
  return processRFItoSurvey(rfiData);
}

function processRFItoSurvey(rfiData) {
  try {
    console.log('========== processRFItoSurvey START ==========');
    console.log('Received data:', JSON.stringify(rfiData));
    
    if (!rfiData || typeof rfiData !== 'object') {
      return createErrorResponse('INVALID_INPUT', 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
    }
    
    const surveyData = {
      uniqueId: rfiData.uniqueId || rfiData.unique_id || '',
      rfiId: rfiData.rfiId || rfiData.RFI_ID || rfiData.rfi_id || '',
      date: rfiData.date || rfiData.surveyDate || rfiData.survey_date || '',
      startTime: rfiData.startTime || rfiData.timeStart || rfiData.start_time || '',
      endTime: rfiData.endTime || rfiData.timeEnd || rfiData.end_time || '',
      description: rfiData.description || rfiData.workDescription || rfiData.work_description || '',
      location: rfiData.location || rfiData.workLocation || rfiData.work_location || '',
      requesterName: rfiData.requesterName || rfiData.contactName || rfiData.requester_name || '',
      requesterEmail: rfiData.requesterEmail || rfiData.contactEmail || rfiData.requester_email || '',
      note: rfiData.note || rfiData.notes || rfiData.additional_notes || '',
      guest: rfiData.guest || rfiData.guests || rfiData.guest_emails || '',
      surveyEmail: rfiData.surveyEmail || rfiData.survey_email || '',
      assignedInspector: rfiData.assignedInspector || rfiData.assigned_inspector || ''  // âœ… à¹€à¸à¸´à¹ˆà¸¡ Assigned Inspector
    };
    
    console.log('Converted data:', JSON.stringify(surveyData));
    
    // Validate required fields
    const validation = validateSurveyData(surveyData);
    if (!validation.success) {
      return validation;
    }
    
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‡à¸²à¸™à¸—à¸µà¹ˆà¸‹à¹‰à¸­à¸™à¸—à¸±à¸š
    const conflicts = findConflictingJobs(surveyData.date, surveyData.startTime, surveyData.endTime);
    const hasConflict = conflicts.length > 0;
    
    if (hasConflict) {
      console.log('âš ï¸ WARNING: Found ' + conflicts.length + ' conflicting jobs');
      conflicts.forEach(function(job) {
        console.log('   Conflict: Row ' + job.rowNumber + ' - ' + job.description);
      });
    }
    
    // à¸šà¸±à¸™à¸—à¸¶à¸à¸‡à¸²à¸™ Survey
    const saveResult = saveWorkRequirementFromRFI(surveyData, hasConflict, conflicts);
    
    if (!saveResult.success) {
      return createErrorResponse('SAVE_ERROR', saveResult.message || 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸šà¸±à¸™à¸—à¸¶à¸à¸‡à¸²à¸™à¹„à¸”à¹‰');
    }
    
    // à¹„à¸®à¹„à¸¥à¸—à¹Œà¹à¸–à¸§à¸–à¹‰à¸²à¸¡à¸µà¸„à¸§à¸²à¸¡à¸‚à¸±à¸”à¹à¸¢à¹‰à¸‡
    if (hasConflict) {
      highlightConflictingRow(saveResult.workId);
    }
    
    // à¸šà¸±à¸™à¸—à¸¶à¸ RFI mapping
    if (surveyData.rfiId) {
      saveRFIMapping(surveyData.rfiId, saveResult.workId);
    }
    
    console.log('========== SUCCESS: Work ID = ' + saveResult.workId + ' ==========');
    
    return {
      success: true,
      workId: saveResult.workId,
      uniqueId: surveyData.uniqueId,
      rfiCalendarEventId: saveResult.rfiCalendarEventId || '',
      hasConflict: hasConflict,
      conflictCount: conflicts.length,
      message: hasConflict ? 
        'à¸ªà¸£à¹‰à¸²à¸‡à¸‡à¸²à¸™ Survey à¸ªà¸³à¹€à¸£à¹‡à¸ˆ (âš ï¸ à¸¡à¸µà¸‡à¸²à¸™à¸‹à¹‰à¸­à¸™à¸—à¸±à¸š ' + conflicts.length + ' à¸‡à¸²à¸™ - à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š)' : 
        'à¸ªà¸£à¹‰à¸²à¸‡à¸‡à¸²à¸™ Survey à¸ªà¸³à¹€à¸£à¹‡à¸ˆ',
      timestamp: new Date().toISOString(),
      conflicts: hasConflict ? formatConflictsForAppSheet(conflicts) : [],
      data: {
        date: surveyData.date,
        time: surveyData.startTime + ' - ' + surveyData.endTime,
        location: surveyData.location,
        requester: surveyData.requesterName
      }
    };
    
  } catch (error) {
    console.error('âŒ Error in processRFItoSurvey:', error);
    return createErrorResponse('SYSTEM_ERROR', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ' + error.toString());
  }
}

function validateSurveyData(data) {
  const required = {
    'uniqueId': 'ID',
    'date': 'à¸§à¸±à¸™à¸—à¸µà¹ˆ',
    'startTime': 'à¹€à¸§à¸¥à¸²à¹€à¸£à¸´à¹ˆà¸¡',
    'endTime': 'à¹€à¸§à¸¥à¸²à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”',
    'description': 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸‡à¸²à¸™',
    'location': 'à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ',
    'requesterName': 'à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸­'
  };
  
  const missing = [];
  
  for (var field in required) {
    if (!data[field] || String(data[field]).trim() === '') {
      missing.push(required[field]);
    }
  }
  
  if (missing.length > 0) {
    return createErrorResponse('MISSING_FIELDS', 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸„à¸£à¸š: ' + missing.join(', '));
  }
  
  // Validate date format (YYYY-MM-DD)
  if (!/^\d{4}-\d{2}-\d{2}$/.test(data.date)) {
    return createErrorResponse('INVALID_DATE', 'à¸£à¸¹à¸›à¹à¸šà¸šà¸§à¸±à¸™à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ YYYY-MM-DD)');
  }
  
  // Validate time format (HH:MM)
  if (!/^\d{2}:\d{2}$/.test(data.startTime)) {
    return createErrorResponse('INVALID_TIME', 'à¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸§à¸¥à¸²à¹€à¸£à¸´à¹ˆà¸¡à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ HH:MM)');
  }
  
  if (!/^\d{2}:\d{2}$/.test(data.endTime)) {
    return createErrorResponse('INVALID_TIME', 'à¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸§à¸¥à¸²à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ HH:MM)');
  }
  
  const startMinutes = timeToMinutes(data.startTime);
  const endMinutes = timeToMinutes(data.endTime);
  
  if (endMinutes <= startMinutes) {
    return createErrorResponse('INVALID_TIME_RANGE', 'à¹€à¸§à¸¥à¸²à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¸•à¹‰à¸­à¸‡à¸¡à¸²à¸à¸à¸§à¹ˆà¸²à¹€à¸§à¸¥à¸²à¹€à¸£à¸´à¹ˆà¸¡');
  }
  
  if (data.requesterEmail && data.requesterEmail.trim() !== '') {
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.requesterEmail)) {
      return createErrorResponse('INVALID_EMAIL', 'à¸£à¸¹à¸›à¹à¸šà¸šà¸­à¸µà¹€à¸¡à¸¥à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
    }
  }
  
  return { success: true };
}

function findConflictingJobs(date, startTime, endTime) {
  try {
    const sheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).getSheetByName('requirement');
    if (!sheet) return [];
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) return [];
    
    const data = sheet.getRange(2, 2, lastRow - 1, 10).getValues();
    
    const newStartMinutes = timeToMinutes(startTime);
    const newEndMinutes = timeToMinutes(endTime);
    
    const conflicts = [];
    
    data.forEach(function(row, index) {
      if (!row[0] || !row[1] || !row[2]) return;
      
      const rowDate = formatDate(new Date(row[0]));
      const status = row[9] || 'à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£';
      
      if (status === 'à¸¢à¸à¹€à¸¥à¸´à¸' || status === JOB_STATUS.CANCELLED) return;
      if (rowDate !== date) return;
      
      const existingStartMinutes = timeToMinutes(formatTime(row[1]));
      const existingEndMinutes = timeToMinutes(formatTime(row[2]));
      
      if (newStartMinutes < existingEndMinutes && newEndMinutes > existingStartMinutes) {
        conflicts.push({
          rowNumber: index + 2,
          description: row[3] || '',
          startTime: formatTime(row[1]),
          endTime: formatTime(row[2]),
          location: row[4] || '',
          requester: row[5] || '',
          status: status
        });
      }
    });
    
    return conflicts;
    
  } catch (error) {
    console.error('Error finding conflicts:', error);
    return [];
  }
}

// âœ… SIMPLIFIED: à¸ªà¸£à¹‰à¸²à¸‡à¹à¸„à¹ˆ RFI Calendar à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (Primary Calendar)
function saveWorkRequirementFromRFI(data, hasConflict) {
  try {
    let sheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).getSheetByName('requirement');
    
    if (!sheet) {
      sheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).insertSheet('requirement');
      sheet.getRange(1, 1, 1, 13).setValues([
        ['ID', 'à¸§à¸±à¸™à¸—à¸µà¹ˆ', 'à¹€à¸§à¸¥à¸²à¹€à¸£à¸´à¹ˆà¸¡', 'à¹€à¸§à¸¥à¸²à¸ˆà¸š', 'à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸‡à¸²à¸™', 'à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ', 'à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰ requirement', 
         'à¹€à¸¡à¸¥ requirement', 'à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸', 'à¸—à¸µà¸¡à¸‡à¸²à¸™', 'à¸ªà¸–à¸²à¸™à¸°', 'Calendar Event ID', 'à¸­à¸±à¸›à¹€à¸”à¸•à¸¥à¹ˆà¸²à¸ªà¸¸à¸”']
      ]);
      sheet.getRange(1, 1, 1, 13).setFontWeight('bold');
    }
    
    // âœ… à¸ªà¸£à¹‰à¸²à¸‡à¹à¸„à¹ˆ RFI Calendar Event (Primary Calendar)
    let rfiCalendarEventId = null;
    try {
      rfiCalendarEventId = createRFICalendarEvent(data);
      console.log('âœ… RFI Calendar Event created:', rfiCalendarEventId);
    } catch (calendarError) {
      console.error('Failed to create RFI calendar event:', calendarError);
    }
    
    const lastRow = sheet.getLastRow();
    const nextRow = lastRow + 1;
    const currentTime = new Date();
    
    // à¸ªà¸£à¹‰à¸²à¸‡ note à¸à¸£à¹‰à¸­à¸¡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸‹à¹‰à¸­à¸™ + à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¹à¸–à¸§
    let noteText = data.note || '';
    
    if (hasConflict) {
      const conflicts = findConflictingJobs(data.date, data.startTime, data.endTime);
      
      let conflictDetails = `âš ï¸ à¸‡à¸²à¸™ RFI #${data.rfiId || 'N/A'} à¸¡à¸µà¸‡à¸²à¸™à¸‹à¹‰à¸­à¸™à¸—à¸±à¸š ${conflicts.length} à¸‡à¸²à¸™:\n`;
      conflicts.forEach(function(job, index) {
        conflictDetails += (index + 1) + '. [à¹à¸–à¸§ ' + job.rowNumber + '] "' + job.description + '" ';
        conflictDetails += '(' + job.startTime + '-' + job.endTime + ') ';
        conflictDetails += 'à¸œà¸¹à¹‰à¸‚à¸­: ' + job.requester + '\n';
      });
      
      noteText = conflictDetails + '\nğŸ“‹ à¸ˆà¸²à¸ RFI System\n' + (noteText ? 'à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡: ' + noteText : '');
    } else {
      noteText = `ğŸ“‹ à¸ˆà¸²à¸ RFI System | RFI #${data.rfiId || 'N/A'}`;
      if (noteText && data.note) {
        noteText += ' | ' + data.note;
      }
    }
    
    const conflictsForEmail = hasConflict ? findConflictingJobs(data.date, data.startTime, data.endTime) : [];
    
    const fullDescription = data.rfiId ? 
      `RFI #${data.rfiId} - ${data.description}` : 
      data.description;
    
    // âœ… 13 columns
    const newRowData = [
      data.uniqueId,
      data.date,
      data.startTime,
      data.endTime,
      fullDescription,
      data.location || '',
      data.requesterName,
      data.requesterEmail || '',
      noteText,
      '',
      'à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£',
      rfiCalendarEventId || '',
      currentTime
    ];
    
    sheet.getRange(nextRow, 1, 1, 13).setValues([newRowData]);
    
    // âœ… à¸ªà¹ˆà¸‡à¸­à¸µà¹€à¸¡à¸¥à¹à¸„à¹ˆ Survey Email (à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡à¸–à¸¶à¸‡ RFI Participants)
    let emailSent = false;
    try {
      emailSent = sendWorkNotificationToSurveyEmail(data, rfiCalendarEventId, hasConflict, conflictsForEmail);
    } catch (emailError) {
      console.error('Failed to send email:', emailError);
    }
    
    return {
      success: true,
      workId: nextRow,
      rfiCalendarEventId: rfiCalendarEventId,
      emailSent: emailSent
    };
    
  } catch (error) {
    console.error('Error in saveWorkRequirementFromRFI:', error);
    return {
      success: false,
      message: 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ' + error.toString()
    };
  }
}

// âœ… à¸”à¸¶à¸‡à¸ªà¸µà¸ˆà¸²à¸ Resources Sheet (à¹€à¸‰à¸à¸²à¸°à¸—à¸µà¸¡à¸—à¸µà¹ˆà¸£à¸°à¸šà¸¸à¹ƒà¸™ assignedInspector)
function getTeamColors(assignedInspector) {
  try {
    // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸—à¸µà¸¡ return à¸§à¹ˆà¸²à¸‡
    if (!assignedInspector || String(assignedInspector).trim() === '') {
      console.log('âš ï¸ No assigned inspector');
      return {};
    }
    
    // à¹à¸¢à¸à¸—à¸µà¸¡à¸ˆà¸²à¸ assignedInspector
    const teamString = String(assignedInspector).trim();
    const requestedTeams = teamString.split(',').map(t => t.trim()).filter(t => t.length > 0);
    
    if (requestedTeams.length === 0) {
      console.log('âš ï¸ No valid teams in assigned inspector');
      return {};
    }
    
    console.log(`ğŸ” Looking for colors for teams: ${requestedTeams.join(', ')}`);
    
    const sheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).getSheetByName('Resources');
    
    if (!sheet) {
      console.log('âš ï¸ Resources sheet not found, using default colors');
      return {};
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('âš ï¸ No data in Resources sheet');
      return {};
    }
    
    // à¸­à¹ˆà¸²à¸™ column B (Team Name) à¹à¸¥à¸° column H (Color)
    const teamData = sheet.getRange(2, 2, lastRow - 1, 1).getValues(); // Column B = 2
    const colorData = sheet.getRange(2, 8, lastRow - 1, 1).getValues(); // Column H = 8
    
    const teamColors = {};
    
    // à¸„à¹‰à¸™à¸«à¸²à¹€à¸‰à¸à¸²à¸°à¸—à¸µà¸¡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£
    for (let i = 0; i < teamData.length; i++) {
      const teamName = String(teamData[i][0] || '').trim();
      const colorValue = String(colorData[i][0] || '').trim(); // âœ… à¹€à¸à¹‡à¸šà¹€à¸›à¹‡à¸™ Hex Code à¸•à¸²à¸¡à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™
      
      // à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸—à¸µà¸¡à¸™à¸µà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
      if (requestedTeams.includes(teamName) && colorValue) {
        teamColors[teamName] = getCalendarColor(colorValue);
        console.log(`âœ… Team: ${teamName} â†’ Color: ${colorValue}`);
      }
    }
    
    // à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸¡à¸µà¸—à¸µà¸¡à¹„à¸«à¸™à¸«à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­
    requestedTeams.forEach(function(team) {
      if (!teamColors[team]) {
        console.log(`âš ï¸ Color not found for team: ${team} (using default BLUE)`);
        teamColors[team] = CalendarApp.EventColor.BLUE;
      }
    });
    
    console.log(`âœ… Loaded ${Object.keys(teamColors).length} team colors`);
    return teamColors;
    
  } catch (error) {
    console.error('Error loading team colors:', error);
    return {};
  }
}

// à¹à¸›à¸¥à¸‡ Hex Color Code à¹€à¸›à¹‡à¸™ CalendarApp.EventColor à¸—à¸µà¹ˆà¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸”
function getCalendarColor(colorHex) {
  // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¸ªà¸µà¹à¸šà¸šà¹€à¸”à¸´à¸¡ (à¸ªà¸³à¸«à¸£à¸±à¸š backward compatibility)
  const colorNameMap = {
    'PALE_BLUE': CalendarApp.EventColor.PALE_BLUE,
    'PALE_GREEN': CalendarApp.EventColor.PALE_GREEN,
    'MAUVE': CalendarApp.EventColor.MAUVE,
    'PALE_RED': CalendarApp.EventColor.PALE_RED,
    'YELLOW': CalendarApp.EventColor.YELLOW,
    'ORANGE': CalendarApp.EventColor.ORANGE,
    'CYAN': CalendarApp.EventColor.CYAN,
    'GRAY': CalendarApp.EventColor.GRAY,
    'BLUE': CalendarApp.EventColor.BLUE,
    'GREEN': CalendarApp.EventColor.GREEN,
    'RED': CalendarApp.EventColor.RED
  };
  
  const colorUpper = String(colorHex).toUpperCase();
  if (colorNameMap[colorUpper]) {
    return colorNameMap[colorUpper];
  }
  
  // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ Hex Color Code (#FF6B6B)
  if (colorHex && colorHex.toString().startsWith('#')) {
    return hexToCalendarColor(colorHex);
  }
  
  // Default
  return CalendarApp.EventColor.BLUE;
}

// à¹à¸›à¸¥à¸‡ Hex Color à¹€à¸›à¹‡à¸™ RGB
function hexToRGB(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

// à¸„à¸³à¸™à¸§à¸“à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸ªà¸µ (Color Distance)
function colorDistance(rgb1, rgb2) {
  return Math.sqrt(
    Math.pow(rgb1.r - rgb2.r, 2) +
    Math.pow(rgb1.g - rgb2.g, 2) +
    Math.pow(rgb1.b - rgb2.b, 2)
  );
}

// à¹à¸›à¸¥à¸‡ Hex Color à¹€à¸›à¹‡à¸™ CalendarApp.EventColor à¸—à¸µà¹ˆà¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸”
function hexToCalendarColor(hexColor) {
  const inputRGB = hexToRGB(hexColor);
  if (!inputRGB) {
    console.log('âš ï¸ Invalid hex color:', hexColor);
    return CalendarApp.EventColor.BLUE;
  }
  
  // Google Calendar à¸ªà¸µà¸—à¸µà¹ˆà¸¡à¸µ (à¸„à¹ˆà¸²à¸›à¸£à¸°à¸¡à¸²à¸“ RGB)
  const calendarColors = [
    { name: 'PALE_BLUE', color: CalendarApp.EventColor.PALE_BLUE, rgb: {r: 161, g: 194, b: 250} },
    { name: 'PALE_GREEN', color: CalendarApp.EventColor.PALE_GREEN, rgb: {r: 183, g: 225, b: 205} },
    { name: 'MAUVE', color: CalendarApp.EventColor.MAUVE, rgb: {r: 162, g: 137, b: 209} },
    { name: 'PALE_RED', color: CalendarApp.EventColor.PALE_RED, rgb: {r: 244, g: 164, b: 164} },
    { name: 'YELLOW', color: CalendarApp.EventColor.YELLOW, rgb: {r: 251, g: 233, b: 131} },
    { name: 'ORANGE', color: CalendarApp.EventColor.ORANGE, rgb: {r: 255, g: 183, b: 134} },
    { name: 'CYAN', color: CalendarApp.EventColor.CYAN, rgb: {r: 137, g: 218, b: 235} },
    { name: 'GRAY', color: CalendarApp.EventColor.GRAY, rgb: {r: 158, g: 158, b: 158} },
    { name: 'BLUE', color: CalendarApp.EventColor.BLUE, rgb: {r: 66, g: 133, b: 244} },
    { name: 'GREEN', color: CalendarApp.EventColor.GREEN, rgb: {r: 51, g: 182, b: 121} },
    { name: 'RED', color: CalendarApp.EventColor.RED, rgb: {r: 234, g: 67, b: 53} }
  ];
  
  // à¸«à¸²à¸ªà¸µà¸—à¸µà¹ˆà¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸”
  let closestColor = calendarColors[0];
  let minDistance = colorDistance(inputRGB, calendarColors[0].rgb);
  
  for (let i = 1; i < calendarColors.length; i++) {
    const distance = colorDistance(inputRGB, calendarColors[i].rgb);
    if (distance < minDistance) {
      minDistance = distance;
      closestColor = calendarColors[i];
    }
  }
  
  console.log(`ğŸ¨ ${hexColor} â†’ ${closestColor.name}`);
  return closestColor.color;
}

// âœ… FIXED: à¸ªà¸£à¹‰à¸²à¸‡ RFI Calendar Event à¸à¸£à¹‰à¸­à¸¡à¸ªà¸µà¹à¸¥à¸°à¸Šà¸·à¹ˆà¸­à¸—à¸µà¸¡
// âœ… FIXED: à¸ªà¸£à¹‰à¸²à¸‡ RFI Calendar Event à¸à¸£à¹‰à¸­à¸¡à¸ªà¸µà¹à¸¥à¸°à¸Šà¸·à¹ˆà¸­à¸—à¸µà¸¡
function createRFICalendarEvent(data) {
  try {
    console.log('========== Creating RFI Calendar Event (Primary) ==========');
    console.log('Guest parameter:', data.guest);
    console.log('Requester email:', data.requesterEmail);
    console.log('Assigned Inspector:', data.assignedInspector); // âœ… à¹€à¸à¸´à¹ˆà¸¡ log
    
    const startDateTime = new Date(data.date + 'T' + data.startTime + ':00');
    const endDateTime = new Date(data.date + 'T' + data.endTime + ':00');
    
    // âœ… à¸ªà¸£à¹‰à¸²à¸‡ Title à¸à¸£à¹‰à¸­à¸¡à¸Šà¸·à¹ˆà¸­à¸—à¸µà¸¡
    let title = data.rfiId ? 
      `ğŸ“‹ RFI #${data.rfiId} - ${data.description}` : 
      `ğŸ“‹ Survey Work - ${data.description}`;
    
    // âœ… à¹€à¸à¸´à¹ˆà¸¡à¸Šà¸·à¹ˆà¸­à¸—à¸µà¸¡à¹ƒà¸™ Title
    if (data.assignedInspector && String(data.assignedInspector).trim() !== '') {
      const teams = String(data.assignedInspector).trim().split(',').map(t => t.trim());
      const teamText = teams.join(', ');
      title += ` [${teamText}]`;
      console.log('âœ… Team added to title:', teamText);
    }
    
    let description = 'ğŸ“‹ à¸‡à¸²à¸™ RFI Work Requirement\n';
    description += 'ğŸ‘¤ à¸œà¸¹à¹‰ requirement: ' + data.requesterName + '\n';
    description += 'ğŸ“ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”: ' + data.description + '\n';
    description += 'ğŸ“ à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ: ' + data.location + '\n';
    description += 'â° à¹€à¸§à¸¥à¸²: ' + data.startTime + ' - ' + data.endTime + ' à¸™.\n';
    
    // âœ… à¹€à¸à¸´à¹ˆà¸¡à¸Šà¸·à¹ˆà¸­à¸—à¸µà¸¡à¹ƒà¸™ Description
    if (data.assignedInspector && String(data.assignedInspector).trim() !== '') {
      description += 'ğŸ‘¥ à¸—à¸µà¸¡à¸‡à¸²à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š: ' + data.assignedInspector + '\n';
      console.log('âœ… Team added to description');
    }
    
    if (data.note) {
      description += 'ğŸ“Œ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸: ' + data.note + '\n';
    }
    if (data.guest) {
      description += 'ğŸ‘¥ Guests: ' + data.guest + '\n';
    }
    description += 'ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡: ' + new Date().toLocaleString('th-TH');
    
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    if (!calendar) {
      throw new Error('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡ Primary Calendar à¹„à¸”à¹‰');
    }
    
    const event = calendar.createEvent(title, startDateTime, endDateTime, {
      description: description,
      location: data.location || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸'
    });
    
    // âœ… à¸•à¸±à¹‰à¸‡à¸ªà¸µà¸•à¸²à¸¡à¸—à¸µà¸¡
    if (data.assignedInspector && String(data.assignedInspector).trim() !== '') {
      console.log('ğŸ¨ Setting color for team:', data.assignedInspector);
      
      const teams = String(data.assignedInspector).trim().split(',').map(t => t.trim());
      const teamColors = getTeamColors(data.assignedInspector);
      
      // à¹ƒà¸Šà¹‰à¸ªà¸µà¸‚à¸­à¸‡à¸—à¸µà¸¡à¹à¸£à¸à¸—à¸µà¹ˆà¸à¸š
      if (teams.length > 0 && teamColors[teams[0]]) {
        event.setColor(teamColors[teams[0]]);
        console.log('âœ… Color set successfully for:', teams[0]);
      } else {
        console.log('âš ï¸ No color found, using default BLUE');
        event.setColor(CalendarApp.EventColor.BLUE);
      }
    } else {
      // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸—à¸µà¸¡ à¹ƒà¸Šà¹‰à¸ªà¸µà¸™à¹‰à¸³à¹€à¸‡à¸´à¸™à¹€à¸›à¹‡à¸™ default
      event.setColor(CalendarApp.EventColor.BLUE);
      console.log('â„¹ï¸ No team assigned, using default BLUE');
    }
    
    // à¹€à¸à¸´à¹ˆà¸¡ Guests
    const guestEmails = [];
    
    if (data.guest) {
      const guestString = String(data.guest).trim();
      if (guestString !== '' && guestString.toLowerCase() !== 'null') {
        const customGuests = guestString
          .split(/[,;\n]/)
          .map(e => e.trim())
          .filter(e => e.length > 0 && e.includes('@'));
        
        guestEmails.push(...customGuests);
      }
    }
    
    if (data.requesterEmail && String(data.requesterEmail).includes('@')) {
      const reqEmail = String(data.requesterEmail).trim();
      if (!guestEmails.includes(reqEmail)) {
        guestEmails.push(reqEmail);
      }
    }
    
    const uniqueGuests = [...new Set(guestEmails)];
    
    if (uniqueGuests.length > 0) {
      uniqueGuests.forEach(function(email) {
        try {
          event.addGuest(email);
          console.log('âœ” Added guest to RFI calendar:', email);
        } catch (guestAddError) {
          console.error('âœ— Failed to add guest:', email);
        }
      });
    }
    
    event.addEmailReminder(60);
    event.addEmailReminder(15);
    
    console.log('âœ… RFI Calendar event created:', event.getId());
    console.log('âœ… Title:', title);
    
    return event.getId();
    
  } catch (error) {
    console.error('Error creating RFI calendar event:', error);
    throw error;
  }
}

// âœ… à¸ªà¹ˆà¸‡à¸­à¸µà¹€à¸¡à¸¥à¹à¸„à¹ˆ Survey Email (parameter SurveyEmail à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™)
function sendWorkNotificationToSurveyEmail(data, rfiEventId, hasConflict, conflicts) {
  try {
    console.log('========== SEND EMAIL TO SURVEY EMAIL ==========');
    console.log('Survey Email:', data.surveyEmail);
    
    const quota = checkEmailQuota();
    console.log('ğŸ“Š Current email quota:', quota);
    
    if (quota <= 1) {
      console.log('âŒ Email quota too low');
      return false;
    }
    
    // âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µ Survey Email à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    if (!data.surveyEmail || String(data.surveyEmail).trim() === '' || !String(data.surveyEmail).includes('@')) {
      console.log('âŒ No valid Survey Email found');
      return false;
    }
    
    const surveyEmailClean = String(data.surveyEmail).trim();
    
    const subject = hasConflict ? 
      'âš ï¸ à¸‡à¸²à¸™ Survey à¹ƒà¸«à¸¡à¹ˆ (à¸¡à¸µà¸‡à¸²à¸™à¸‹à¹‰à¸­à¸™à¸—à¸±à¸š ' + conflicts.length + ' à¸‡à¸²à¸™)' : 
      'ğŸ“‹ à¸‡à¸²à¸™ Survey à¹ƒà¸«à¸¡à¹ˆ';
    
    const emailBody = createSurveyEmailHTML(data, rfiEventId, hasConflict, conflicts);
    
    console.log('ğŸ“¤ Sending to Survey Email:', surveyEmailClean);
    
    const sent = safeSendEmail({
      to: surveyEmailClean,
      subject: subject,
      htmlBody: emailBody,
      name: 'Survey Work Requirement System',
      replyTo: getAdminEmail()
    });
    
    if (sent) {
      console.log('âœ… Survey Email sent successfully');
    } else {
      console.log('âŒ Email failed');
    }
    
    return sent;
    
  } catch (error) {
    console.error('âŒ Error sending Survey Email:', error);
    return false;
  }
}

function createSurveyEmailHTML(data, rfiEventId, hasConflict, conflicts) {
  let conflictWarning = '';
  
  if (hasConflict && conflicts && conflicts.length > 0) {
    let conflictTable = '<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">';
    conflictTable += '<tr style="background-color: #ffe5cc;">';
    conflictTable += '<th style="border: 1px solid #ff9800; padding: 8px;">à¹à¸–à¸§à¸—à¸µà¹ˆ</th>';
    conflictTable += '<th style="border: 1px solid #ff9800; padding: 8px;">à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸‹à¹‰à¸­à¸™à¸—à¸±à¸š</th>';
    conflictTable += '<th style="border: 1px solid #ff9800; padding: 8px;">à¹€à¸§à¸¥à¸²</th>';
    conflictTable += '<th style="border: 1px solid #ff9800; padding: 8px;">à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ</th>';
    conflictTable += '<th style="border: 1px solid #ff9800; padding: 8px;">à¸œà¸¹à¹‰à¸‚à¸­</th>';
    conflictTable += '</tr>';
    
    conflicts.forEach(function(job) {
      conflictTable += '<tr>';
      conflictTable += '<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">' + job.rowNumber + '</td>';
      conflictTable += '<td style="border: 1px solid #ddd; padding: 8px;">' + job.description + '</td>';
      conflictTable += '<td style="border: 1px solid #ddd; padding: 8px;">' + job.startTime + ' - ' + job.endTime + '</td>';
      conflictTable += '<td style="border: 1px solid #ddd; padding: 8px;">' + job.location + '</td>';
      conflictTable += '<td style="border: 1px solid #ddd; padding: 8px;">' + job.requester + '</td>';
      conflictTable += '</tr>';
    });
    
    conflictTable += '</table>';
    
    conflictWarning = `
    <div style="background-color: #fff3cd; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0;">
      <h3 style="color: #ff6b35; margin-top: 0;">âš ï¸ à¸„à¸³à¹€à¸•à¸·à¸­à¸™: à¸¡à¸µà¸‡à¸²à¸™à¸‹à¹‰à¸­à¸™à¸—à¸±à¸š ${conflicts.length} à¸‡à¸²à¸™</h3>
      <p>à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£</p>
      ${conflictTable}
    </div>`;
  }
  
  const emailBody = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
h2 { color: ${hasConflict ? '#ff6b35' : '#2c5aa0'}; }
table { border-collapse: collapse; width: 100%; margin: 10px 0; }
td, th { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #f2f2f2; font-weight: bold; }
</style>
</head>
<body>
<h2>ğŸ“‹ à¹à¸ˆà¹‰à¸‡à¸‡à¸²à¸™ Survey à¹ƒà¸«à¸¡à¹ˆ</h2>
<p>à¹€à¸£à¸µà¸¢à¸™ Survey Team</p>
${conflictWarning}
<h3>à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸‡à¸²à¸™</h3>
<table>
<tr><th>à¸£à¸²à¸¢à¸à¸²à¸£</th><th>à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”</th></tr>
${data.rfiId ? '<tr><th>RFI Number</th><td><strong>RFI #' + data.rfiId + '</strong></td></tr>' : ''}
<tr><th>à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸‡à¸²à¸™</th><td>${data.description}</td></tr>
<tr><th>à¸§à¸±à¸™à¸—à¸µà¹ˆ</th><td>${formatDateThai(data.date)}</td></tr>
<tr><th>à¹€à¸§à¸¥à¸²</th><td><strong>${data.startTime} - ${data.endTime} à¸™.</strong></td></tr>
<tr><th>à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ</th><td>${data.location}</td></tr>
<tr><th>à¸œà¸¹à¹‰à¸‚à¸­</th><td>${data.requesterName}</td></tr>
${data.requesterEmail ? '<tr><th>à¸­à¸µà¹€à¸¡à¸¥à¸œà¸¹à¹‰à¸‚à¸­</th><td>' + data.requesterEmail + '</td></tr>' : ''}
${data.guest ? '<tr><th>à¸œà¸¹à¹‰à¸£à¹ˆà¸§à¸¡à¸‡à¸²à¸™</th><td>' + data.guest + '</td></tr>' : ''}
${data.note ? '<tr><th>à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</th><td>' + data.note + '</td></tr>' : ''}
</table>

${rfiEventId ? '<p style="background-color: #f3e5f5; padding: 10px; border-radius: 5px;">ğŸ”— Calendar Event ID: ' + rfiEventId + '</p>' : ''}

<hr>
<p style="color: #666; font-size: 12px;">
  à¸­à¸µà¹€à¸¡à¸¥à¸™à¸µà¹‰à¸ªà¹ˆà¸‡à¸–à¸¶à¸‡ Survey Team<br>
  à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡: ${new Date().toLocaleString('th-TH')}
</p>
</body>
</html>`;
  
  return emailBody;
}

function highlightConflictingRow(rowIndex) {
  try {
    const sheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).getSheetByName('requirement');
    if (!sheet || !rowIndex) return false;
    
    sheet.getRange(rowIndex, 1, 1, 13).setBackground('#FFE5CC');
    
    const noteCell = sheet.getRange(rowIndex, 9);
    noteCell.setFontColor('#CC0000');
    noteCell.setFontWeight('bold');
    
    console.log('âœ… Highlighted conflicting row:', rowIndex);
    return true;
    
  } catch (error) {
    console.error('Error highlighting row:', error);
    return false;
  }
}

function saveRFIMapping(rfiId, workId) {
  try {
    let sheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).getSheetByName('RFI_Survey_Mapping');
    
    if (!sheet) {
      sheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).insertSheet('RFI_Survey_Mapping');
      sheet.getRange(1, 1, 1, 4).setValues([
        ['RFI ID', 'Survey Work ID', 'Created Date', 'Status']
      ]);
      sheet.getRange(1, 1, 1, 4).setFontWeight('bold').setBackground('#f0f0f0');
    }
    
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow + 1, 1, 1, 4).setValues([[
      rfiId,
      workId,
      new Date(),
      'Active'
    ]]);
    
    console.log('RFI mapping saved:', rfiId, '->', workId);
    return true;
  } catch (error) {
    console.error('Error saving mapping:', error);
    return false;
  }
}

function formatConflictsForAppSheet(conflicts) {
  if (!conflicts || conflicts.length === 0) return [];
  
  return conflicts.map(function(job) {
    return {
      row: job.rowNumber,
      description: job.description,
      time: job.startTime + ' - ' + job.endTime,
      location: job.location,
      requester: job.requester,
      status: job.status
    };
  });
}

// ===== POSTPONE RFI INSPECTION (SIMPLIFIED - Primary Calendar à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™) =====

function postponeRFIInspection(
  rfiNumber, 
  Description, 
  newDate, 
  newStartTime, 
  newEndTime, 
  postponeReason = '', 
  requesterEmail = '',
  guestEmails = '',
  newLocation = '', 
  Assigned_Inspector = '',  // âœ… à¹€à¸à¸´à¹ˆà¸¡ parameter
  sendEmail = true, 
  searchDays = 60
) {
  Logger.log(`ğŸ“… [SIMPLIFIED] Starting RFI postponement for: ${rfiNumber}`);
  Logger.log(`ğŸ‘¥ Assigned Inspector: ${Assigned_Inspector}`);
  
  const validation = validatePostponeInputs(rfiNumber, Description, newDate, newStartTime, newEndTime);
  if (!validation.valid) {
    Logger.log(`âŒ Validation failed: ${validation.error}`);
    return {
      success: false,
      error: validation.error,
      rfiNumber: rfiNumber,
      rfiDescription: Description,
      eventsFound: 0,
      eventsUpdated: 0,
      emailsSent: false
    };
  }

  const cleanRfiNumber = rfiNumber.trim();
  const cleanDescription = Description ? Description.trim() : '';
  
  let result = {
    success: false,
    rfiNumber: cleanRfiNumber,
    rfiDescription: cleanDescription,
    rfiEventsFound: 0,
    rfiEventsUpdated: 0,
    emailsSent: false,
    participants: [],
    updatedRFIEvents: [],
    error: null,
    message: '',
    originalDate: null,
    newDate: newDate,
    newStartTime: newStartTime,
    newEndTime: newEndTime
  };

  try {
    // Step 1: à¸„à¹‰à¸™à¸«à¸² Calendar Events à¹ƒà¸™ Primary Calendar
    Logger.log("ğŸ” Step 1: Searching Primary Calendar Events...");
    const rfiSearchResult = searchCalendarEventsByRFIAndDescription(cleanRfiNumber, cleanDescription, CALENDAR_ID, searchDays);
    
    if (rfiSearchResult.success && rfiSearchResult.events.length > 0) {
      result.rfiEventsFound = rfiSearchResult.events.length;
      result.originalDate = rfiSearchResult.events[0].startTime.toDateString();
      Logger.log(`âœ… Found ${result.rfiEventsFound} RFI calendar events`);
    } else {
      result.error = `No calendar events found for RFI: ${cleanRfiNumber} / ${cleanDescription}`;
      result.message = result.error;
      Logger.log(`âš ï¸ ${result.error}`);
      return result;
    }

    // Step 2: à¸ªà¸£à¹‰à¸²à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆà¹à¸¥à¸°à¹€à¸§à¸¥à¸²à¹ƒà¸«à¸¡à¹ˆ
    Logger.log("â° Step 2: Creating new date/time...");
    const newDateTime = createNewDateTime(newDate, newStartTime, newEndTime);
    
    if (!newDateTime.valid) {
      result.error = newDateTime.error;
      result.message = result.error;
      return result;
    }

    // Step 3: à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸£à¸±à¸šà¸ˆà¸²à¸ Parameters
    Logger.log("ğŸ‘¥ Step 3: Preparing participant list...");
    const allParticipants = new Set();

    if (requesterEmail && String(requesterEmail).trim() !== '' && String(requesterEmail).includes('@')) {
      allParticipants.add(String(requesterEmail).trim());
    }

    if (guestEmails) {
      const guestString = String(guestEmails).trim();
      if (guestString !== '' && guestString.toLowerCase() !== 'null') {
        const guestList = guestString
          .split(/[,;\n]/)
          .map(email => email.trim())
          .filter(email => email.length > 0 && email.includes('@'));
        
        guestList.forEach(email => allParticipants.add(email));
      }
    }

    result.participants = Array.from(allParticipants);
    Logger.log(`ğŸ‘¥ Total participants: ${result.participants.length}`);

    // Step 4: à¸­à¸±à¸›à¹€à¸”à¸• Primary Calendar Events
    Logger.log("ğŸ“ Step 4: Updating Primary Calendar Events...");
    
    for (let i = 0; i < rfiSearchResult.events.length; i++) {
      const eventInfo = rfiSearchResult.events[i];
      
      try {
        const updateSuccess = updateCalendarEventV2(
          eventInfo,
          CALENDAR_ID,
          newDateTime.startTime,
          newDateTime.endTime,
          postponeReason,
          newLocation,
          Assigned_Inspector  // âœ… à¸ªà¹ˆà¸‡ Assigned_Inspector
        );
        
        if (updateSuccess.success) {
          result.rfiEventsUpdated++;
          result.updatedRFIEvents.push({
            eventId: eventInfo.eventId,
            title: updateSuccess.newTitle,
            calendarType: 'RFI'
          });
          Logger.log(`âœ… Event updated: "${eventInfo.title}"`);
        }
        
      } catch (updateError) {
        Logger.log(`âŒ Error updating event: ${updateError.toString()}`);
      }
    }

    // Step 5: à¸ªà¹ˆà¸‡à¸­à¸µà¹€à¸¡à¸¥à¹à¸ˆà¹‰à¸‡à¸à¸²à¸£à¹€à¸¥à¸·à¹ˆà¸­à¸™à¸™à¸±à¸” (à¸–à¸¶à¸‡ RFI Participants à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™)
    if (sendEmail && result.rfiEventsUpdated > 0) {
      Logger.log("ğŸ“§ Step 5: Sending postponement notifications...");
      
      const emailResult = sendPostponementNotification(
        cleanRfiNumber,
        cleanDescription,
        postponeReason,
        result.updatedRFIEvents,
        requesterEmail,
        guestEmails
      );
      
      result.emailsSent = emailResult.success;
      Logger.log(`ğŸ“§ Email: ${emailResult.success ? 'SENT' : 'FAILED'}`);
      Logger.log(`ğŸ“§ Total recipients: ${emailResult.totalRecipients || 0}`);
    }

    // à¸à¸³à¸«à¸™à¸”à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
    result.success = result.rfiEventsUpdated > 0;
    
    if (result.success) {
      result.message = `Postponed ${result.rfiEventsUpdated} event(s) to ${newDate} ${newStartTime}-${newEndTime}`;
    } else {
      result.message = `No appointments were postponed for RFI ${cleanRfiNumber}`;
    }

  } catch (error) {
    result.error = error.toString();
    result.message = `Error postponing RFI ${cleanRfiNumber}: ${result.error}`;
    Logger.log(`âŒ Unexpected error: ${result.error}`);
  }

  // à¹à¸ªà¸”à¸‡à¸ªà¸£à¸¸à¸›à¸œà¸¥
  Logger.log("\n" + "=".repeat(50));
  Logger.log("ğŸ“… RFI POSTPONEMENT SUMMARY (SIMPLIFIED):");
  Logger.log(`ğŸ†” RFI Number: ${result.rfiNumber}`);
  Logger.log(`ğŸ“… New Date: ${result.newDate} ${result.newStartTime}-${result.newEndTime}`);
  Logger.log(`ğŸ“… Events Updated: ${result.rfiEventsUpdated}/${result.rfiEventsFound}`);
  Logger.log(`ğŸ“§ Emails Sent: ${result.emailsSent ? 'YES' : 'NO'}`);
  Logger.log(`âœ… Overall Success: ${result.success ? 'YES' : 'NO'}`);

  return result;
}

// ===== CANCEL RFI INSPECTION (SIMPLIFIED - Primary Calendar à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™) =====

function cancelRFIInspection(
  rfiNumber,
  Description,
  cancelReason = '',
  requesterEmail = '',
  guestEmails = '',
  sendEmail = true,
  searchDays = 60
) {
  Logger.log(`ğŸš« [SIMPLIFIED] Starting RFI cancellation for: ${rfiNumber}`);
  
  if (!rfiNumber || rfiNumber.trim() === '') {
    return {
      success: false,
      error: 'RFI Number is required',
      rfiNumber: rfiNumber,
      eventsFound: 0,
      eventsDeleted: 0,
      emailsSent: false
    };
  }

  const cleanRfiNumber = rfiNumber.trim();
  const cleanDescription = Description ? Description.trim() : '';
  
  let result = {
    success: false,
    rfiNumber: cleanRfiNumber,
    rfiDescription: cleanDescription,
    rfiEventsFound: 0,
    rfiEventsDeleted: 0,
    emailsSent: false,
    participants: [],
    deletedRFIEvents: [],
    error: null,
    message: ''
  };

  try {
    // Step 1: à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸£à¸±à¸šà¸­à¸µà¹€à¸¡à¸¥
    Logger.log("ğŸ‘¥ Step 1: Preparing participant list...");
    const allParticipants = new Set();
    
    if (requesterEmail && String(requesterEmail).trim() !== '' && String(requesterEmail).includes('@')) {
      allParticipants.add(String(requesterEmail).trim());
    }
    
    if (guestEmails) {
      const guestString = String(guestEmails).trim();
      if (guestString !== '' && guestString.toLowerCase() !== 'null') {
        const guestList = guestString
          .split(/[,;\n]/)
          .map(email => email.trim())
          .filter(email => email.length > 0 && email.includes('@'));
        
        guestList.forEach(email => allParticipants.add(email));
      }
    }

    result.participants = Array.from(allParticipants);
    Logger.log(`ğŸ‘¥ Total participants: ${result.participants.length}`);

    // Step 2: à¸„à¹‰à¸™à¸«à¸² Primary Calendar Events
    Logger.log("ğŸ” Step 2: Searching Primary Calendar Events...");
    const rfiSearchResult = searchCalendarEventsByRFIAndDescription(cleanRfiNumber, cleanDescription, CALENDAR_ID, searchDays);
    
    if (rfiSearchResult.success && rfiSearchResult.events.length > 0) {
      result.rfiEventsFound = rfiSearchResult.events.length;
      Logger.log(`âœ… Found ${result.rfiEventsFound} calendar events`);
    } else {
      result.error = `No calendar events found for RFI: ${cleanRfiNumber} / ${cleanDescription}`;
      result.message = result.error;
      Logger.log(`âš ï¸ ${result.error}`);
      return result;
    }

    // Step 3: à¸¥à¸š Primary Calendar Events
    Logger.log("ğŸ—‘ï¸ Step 3: Deleting Primary Calendar Events...");
    
    for (let i = 0; i < rfiSearchResult.events.length; i++) {
      const eventInfo = rfiSearchResult.events[i];
      
      try {
        const deleteSuccess = deleteCalendarEventV2(eventInfo, CALENDAR_ID);
        
        if (deleteSuccess.success) {
          result.rfiEventsDeleted++;
          result.deletedRFIEvents.push({
            eventId: eventInfo.eventId,
            title: eventInfo.title,
            calendarType: 'RFI'
          });
          Logger.log(`âœ… Event deleted: "${eventInfo.title}"`);
        }
        
      } catch (deleteError) {
        Logger.log(`âŒ Error deleting event: ${deleteError.toString()}`);
      }
    }

    // Step 4: à¸ªà¹ˆà¸‡à¸­à¸µà¹€à¸¡à¸¥à¹à¸ˆà¹‰à¸‡à¸à¸²à¸£à¸¢à¸à¹€à¸¥à¸´à¸ (à¸–à¸¶à¸‡ RFI Participants à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™)
    if (sendEmail && result.rfiEventsDeleted > 0) {
      Logger.log("ğŸ“§ Step 4: Sending cancellation notifications...");
      
      const emailResult = sendCancellationNotification(
        cleanRfiNumber,
        cleanDescription,
        cancelReason,
        result.deletedRFIEvents,
        requesterEmail,
        guestEmails
      );
      
      result.emailsSent = emailResult.success;
      Logger.log(`ğŸ“§ Email: ${emailResult.success ? 'SENT' : 'FAILED'}`);
      Logger.log(`ğŸ“§ Total recipients: ${emailResult.totalRecipients || 0}`);
    }

    // à¸à¸³à¸«à¸™à¸”à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
    result.success = result.rfiEventsDeleted > 0;
    
    if (result.success) {
      result.message = `Cancelled RFI ${cleanRfiNumber}: ${result.rfiEventsDeleted} event(s) deleted`;
    } else {
      result.message = `No changes made for RFI ${cleanRfiNumber}`;
    }

  } catch (error) {
    result.error = error.toString();
    result.message = `Error cancelling RFI ${cleanRfiNumber}: ${result.error}`;
    Logger.log(`âŒ Unexpected error: ${result.error}`);
  }

  // à¹à¸ªà¸”à¸‡à¸ªà¸£à¸¸à¸›à¸œà¸¥
  Logger.log("\n" + "=".repeat(50));
  Logger.log("ğŸš« RFI CANCELLATION SUMMARY (SIMPLIFIED):");
  Logger.log(`ğŸ†” RFI Number: ${result.rfiNumber}`);
  Logger.log(`ğŸ—‘ï¸ Events Deleted: ${result.rfiEventsDeleted}/${result.rfiEventsFound}`);
  Logger.log(`ğŸ“§ Emails Sent: ${result.emailsSent ? 'YES' : 'NO'}`);
  Logger.log(`âœ… Overall Success: ${result.success ? 'YES' : 'NO'}`);

  return result;
}

// ===== HELPER FUNCTIONS =====

function searchCalendarEventsByRFIAndDescription(rfiNumber, description, calendarId, searchDays = 60) {
  Logger.log(`ğŸ” Searching calendar "${calendarId}" for RFI Number: ${rfiNumber}`);
  
  try {
    const calendar = CalendarApp.getCalendarById(calendarId);
    if (!calendar) {
      throw new Error(`Cannot access calendar: ${calendarId}`);
    }

    const startDate = new Date();
    startDate.setDate(startDate.getDate() - searchDays);
    
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + searchDays);
    
    const allEvents = calendar.getEvents(startDate, endDate);
    Logger.log(`ğŸ“Š Total events in range: ${allEvents.length}`);
    
    if (allEvents.length === 0) {
      return { success: false, message: 'No events found in date range', events: [] };
    }

    const matchingEvents = [];
    
    const rfiSearchPatterns = [
      `RFI #${rfiNumber}`,
      `RFI-${rfiNumber}`,
      `#${rfiNumber}`,
      rfiNumber
    ];
    
    allEvents.forEach((event, index) => {
      try {
        const title = event.getTitle() || '';
        const eventDescription = event.getDescription() || '';
        const searchableText = (title + ' ' + eventDescription).toLowerCase();
        
        const rfiMatch = rfiSearchPatterns.some(pattern => 
          searchableText.includes(pattern.toLowerCase())
        );
        
        if (rfiMatch) {
          Logger.log(`âœ… Found matching event: "${title}"`);
          
          matchingEvents.push({
            event: event,
            eventId: event.getId(),
            title: title,
            description: eventDescription,
            startTime: event.getStartTime(),
            endTime: event.getEndTime(),
            location: event.getLocation() || '',
            created: event.getDateCreated(),
            lastUpdated: event.getLastUpdated()
          });
        }
        
      } catch (eventError) {
        Logger.log(`âš ï¸ Error processing event ${index + 1}: ${eventError.toString()}`);
      }
    });
    
    matchingEvents.sort((a, b) => b.created - a.created);
    
    return {
      success: matchingEvents.length > 0,
      message: `Found ${matchingEvents.length} events for RFI: ${rfiNumber}`,
      events: matchingEvents
    };
    
  } catch (error) {
    Logger.log(`âŒ Error searching calendar events: ${error.toString()}`);
    return { success: false, error: error.toString(), events: [] };
  }
}

function updateCalendarEventV2(eventInfo, calendarId, newStartTime, newEndTime, postponeReason, newLocation, assignedInspector) {
  Logger.log(`ğŸ“ Updating event in "${calendarId}": ${eventInfo.eventId}`);
  
  try {
    const calendar = CalendarApp.getCalendarById(calendarId);
    if (!calendar) {
      return { success: false, error: `Cannot access calendar: ${calendarId}` };
    }
    
    const event = calendar.getEventById(eventInfo.eventId);
    
    if (!event) {
      return { success: false, error: `Event not found: ${eventInfo.eventId}` };
    }

    const originalStartTime = event.getStartTime();
    const originalEndTime = event.getEndTime();
    const originalLocation = event.getLocation();
    const originalDescription = event.getDescription() || '';
    
    event.setTime(newStartTime, newEndTime);
    Logger.log(`âœ… Updated time: ${newStartTime} - ${newEndTime}`);
    
    const finalLocation = newLocation && newLocation.trim() !== '' ? newLocation.trim() : originalLocation;
    if (finalLocation) {
      event.setLocation(finalLocation);
      Logger.log(`ğŸ“ Updated location: ${finalLocation}`);
    }
    
    const currentTitle = event.getTitle();
    let newTitle = currentTitle;
    
    if (!currentTitle.includes('ğŸ“… POSTPONED')) {
      newTitle = `ğŸ“… POSTPONED - ${currentTitle}`;
      event.setTitle(newTitle);
      Logger.log(`ğŸ·ï¸ Updated title: ${newTitle}`);
    }
    
    // âœ… à¸”à¸¶à¸‡à¸—à¸µà¸¡à¸‡à¸²à¸™à¸ˆà¸²à¸ title à¹€à¸”à¸´à¸¡ (à¸–à¹‰à¸²à¸¡à¸µ [Team Name])
    const teamMatch = currentTitle.match(/\[([^\]]+)\]$/);
    const currentTeam = teamMatch ? teamMatch[1] : null;
    
    // âœ… à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸µà¸–à¹‰à¸²à¸¡à¸µà¸—à¸µà¸¡à¸‡à¸²à¸™à¹ƒà¸«à¸¡à¹ˆ
    if (assignedInspector && String(assignedInspector).trim() !== '') {
      const teams = String(assignedInspector).trim().split(',').map(t => t.trim());
      const teamColors = getTeamColors(assignedInspector);  // âœ… à¸ªà¹ˆà¸‡ assignedInspector
      
      // à¸–à¹‰à¸² event à¸™à¸µà¹‰à¸¡à¸µà¸—à¸µà¸¡à¹€à¸”à¸´à¸¡ à¹ƒà¸«à¹‰à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸µà¸•à¸²à¸¡à¸—à¸µà¸¡à¹€à¸”à¸´à¸¡
      if (currentTeam && teams.includes(currentTeam) && teamColors[currentTeam]) {
        event.setColor(teamColors[currentTeam]);
        Logger.log(`ğŸ¨ Updated color for team: ${currentTeam}`);
      } else if (teams.length > 0 && teamColors[teams[0]]) {
        // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸—à¸µà¸¡à¹€à¸”à¸´à¸¡ à¹ƒà¸Šà¹‰à¸ªà¸µà¸‚à¸­à¸‡à¸—à¸µà¸¡à¹à¸£à¸
        event.setColor(teamColors[teams[0]]);
        Logger.log(`ğŸ¨ Set color for team: ${teams[0]}`);
      }
    }
    
    const postponementRecord = `
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
ğŸ“… INSPECTION POSTPONED
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â° Original Schedule:
   ğŸ“… ${originalStartTime.toLocaleDateString('th-TH', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
   })}
   ğŸ•’ ${originalStartTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })} - ${originalEndTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })}
   ğŸ“ ${originalLocation || 'No location'}

ğŸ”„ New Schedule:
   ğŸ“… ${newStartTime.toLocaleDateString('th-TH', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
   })}
   ğŸ•’ ${newStartTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })} - ${newEndTime.toLocaleTimeString('th-TH', { 
      hour: '2-digit', 
      minute: '2-digit' 
   })}
   ğŸ“ ${finalLocation || 'No location'}

${assignedInspector && String(assignedInspector).trim() !== '' ? `ğŸ‘¥ à¸—à¸µà¸¡à¸‡à¸²à¸™à¸•à¸£à¸§à¸ˆ: ${assignedInspector}\n` : ''}
${postponeReason ? `ğŸ’¬ Reason:\n   ${postponeReason}\n` : ''}
ğŸ“Œ Postponed on: ${new Date().toLocaleString('th-TH')}
ğŸ¤– Updated by: AppSheet RFI System (Simplified)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
`;
    
    const newDescription = postponementRecord + '\n' + originalDescription;
    event.setDescription(newDescription);
    
    Logger.log(`âœ… Event updated successfully in ${calendarId}`);
    
    return {
      success: true,
      newTitle: newTitle,
      newLocation: finalLocation
    };
    
  } catch (error) {
    Logger.log(`âŒ Error updating event: ${error.toString()}`);
    return {
      success: false,
      error: error.toString()
    };
  }
}

function deleteCalendarEventV2(eventInfo, calendarId) {
  Logger.log(`ğŸ—‘ï¸ Deleting event from "${calendarId}": ${eventInfo.eventId}`);
  
  try {
    const calendar = CalendarApp.getCalendarById(calendarId);
    if (!calendar) {
      return { success: false, error: `Cannot access calendar: ${calendarId}` };
    }
    
    const event = calendar.getEventById(eventInfo.eventId);
    
    if (!event) {
      return { success: false, error: `Event not found: ${eventInfo.eventId}` };
    }

    event.deleteEvent();
    Logger.log(`âœ… Event deleted from ${calendarId}: "${eventInfo.title}"`);
    
    return {
      success: true,
      eventId: eventInfo.eventId,
      title: eventInfo.title
    };
    
  } catch (error) {
    Logger.log(`âŒ Error deleting event: ${error.toString()}`);
    return {
      success: false,
      error: error.toString()
    };
  }
}

function sendPostponementNotification(rfiNumber, Description, postponeReason, updatedEvents, requesterEmail, guestEmails) {
  Logger.log(`ğŸ“§ Sending postponement notification to RFI Participants`);
  
  try {
    const quota = checkEmailQuota();
    if (quota <= 0) {
      Logger.log('âŒ Email quota exceeded');
      return { success: false, message: "Email quota exceeded" };
    }

    const allRecipients = new Set();
    
    if (requesterEmail && String(requesterEmail).trim() !== '' && String(requesterEmail).includes('@')) {
      allRecipients.add(String(requesterEmail).trim());
      Logger.log(`ğŸ“§ Added requester: ${String(requesterEmail).trim()}`);
    }
    
    if (guestEmails) {
      const guestString = String(guestEmails).trim();
      if (guestString !== '' && guestString.toLowerCase() !== 'null') {
        const guestList = guestString
          .split(/[,;\n]/)
          .map(email => email.trim())
          .filter(email => email.length > 0 && email.includes('@'));
        
        guestList.forEach(email => {
          allRecipients.add(email);
          Logger.log(`ğŸ“§ Added guest: ${email}`);
        });
      }
    }
    
    const finalRecipients = Array.from(allRecipients);
    
    if (finalRecipients.length === 0) {
      Logger.log('âŒ No recipients found');
      return { success: false, message: "No recipients" };
    }
    
    Logger.log(`ğŸ“§ Total recipients: ${finalRecipients.length}`);

    const subject = `ğŸ“… POSTPONED - RFI #${rfiNumber} Inspection Rescheduled`;
    
    let eventsList = '<ul>';
    updatedEvents.forEach(evt => {
      eventsList += `<li><strong>${evt.title}</strong></li>`;
    });
    eventsList += '</ul>';
    
    const htmlMessage = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { color: #ff6b35; }
table { border-collapse: collapse; width: 100%; margin: 10px 0; }
td, th { border: 1px solid #ddd; padding: 8px; }
th { background-color: #f2f2f2; }
.info-box { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; }
</style></head>
<body>
<h2>ğŸ“… RFI Inspection Postponed</h2>

<div class="info-box">
  <strong>âš ï¸ Important Notice:</strong> The scheduled inspection has been postponed.
</div>

<h3>RFI Details:</h3>
<table>
<tr><th style="width: 30%;">RFI Number</th><td><strong>${rfiNumber}</strong></td></tr>
<tr><th>Description</th><td>${Description}</td></tr>
${postponeReason ? `<tr><th>Reason for Postponement</th><td>${postponeReason}</td></tr>` : ''}
</table>

<h3>Updated Calendar Events:</h3>
${eventsList}

<p style="margin-top: 20px;"><strong>Note:</strong> Please check your calendar for the new schedule details.</p>

<hr>
<p style="color: #666; font-size: 12px;">
ğŸ“¨ <strong>Recipients:</strong> RFI Participants<br>
ğŸ¤– Sent by: RFI System (Simplified) - Postponement Notification<br>
ğŸ• Time: ${new Date().toLocaleString('th-TH')}
</p>
</body>
</html>`;
    
    const recipientList = finalRecipients.join(',');
    
    const sent = safeSendEmail({
      to: recipientList,
      subject: subject,
      htmlBody: htmlMessage,
      name: 'RFI System - Postponement Notification'
    });
    
    Logger.log(`ğŸ“§ Postponement email: ${sent ? 'SENT' : 'FAILED'}`);
    Logger.log(`ğŸ“§ Sent to ${finalRecipients.length} recipients`);
    
    return {
      success: sent,
      totalSent: sent ? finalRecipients.length : 0,
      totalRecipients: finalRecipients.length
    };
    
  } catch (error) {
    Logger.log(`âŒ Email error: ${error.toString()}`);
    return { success: false, error: error.toString() };
  }
}

function sendCancellationNotification(rfiNumber, Description, cancelReason, deletedEvents, requesterEmail, guestEmails) {
  Logger.log(`ğŸ“§ Sending cancellation notification to RFI Participants`);
  
  try {
    const quota = checkEmailQuota();
    if (quota <= 0) {
      Logger.log('âŒ Email quota exceeded');
      return { success: false, message: "Email quota exceeded" };
    }

    const allRecipients = new Set();
    
    if (requesterEmail && String(requesterEmail).trim() !== '' && String(requesterEmail).includes('@')) {
      allRecipients.add(String(requesterEmail).trim());
      Logger.log(`ğŸ“§ Added requester: ${String(requesterEmail).trim()}`);
    }
    
    if (guestEmails) {
      const guestString = String(guestEmails).trim();
      if (guestString !== '' && guestString.toLowerCase() !== 'null') {
        const guestList = guestString
          .split(/[,;\n]/)
          .map(email => email.trim())
          .filter(email => email.length > 0 && email.includes('@'));
        
        guestList.forEach(email => {
          allRecipients.add(email);
          Logger.log(`ğŸ“§ Added guest: ${email}`);
        });
      }
    }
    
    const finalRecipients = Array.from(allRecipients);
    
    if (finalRecipients.length === 0) {
      Logger.log('âŒ No recipients found');
      return { success: false, message: "No recipients" };
    }
    
    Logger.log(`ğŸ“§ Total recipients: ${finalRecipients.length}`);

    const subject = `ğŸš« CANCELLED - RFI #${rfiNumber} Inspection Cancelled`;
    
    let eventsList = '<ul>';
    deletedEvents.forEach(evt => {
      eventsList += `<li><strong>${evt.title}</strong></li>`;
    });
    eventsList += '</ul>';
    
    const htmlMessage = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { color: #dc3545; }
table { border-collapse: collapse; width: 100%; margin: 10px 0; }
td, th { border: 1px solid #ddd; padding: 8px; }
th { background-color: #f2f2f2; }
.alert-box { background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; }
</style></head>
<body>
<h2>ğŸš« RFI Inspection Cancelled</h2>

<div class="alert-box">
  <strong>âš ï¸ Important Notice:</strong> The scheduled inspection has been <strong>cancelled</strong>.
</div>

<h3>RFI Details:</h3>
<table>
<tr><th style="width: 30%;">RFI Number</th><td><strong>${rfiNumber}</strong></td></tr>
<tr><th>Description</th><td>${Description}</td></tr>
${cancelReason ? `<tr><th>Reason for Cancellation</th><td>${cancelReason}</td></tr>` : ''}
</table>

<h3>Deleted Calendar Events:</h3>
${eventsList}

<p style="margin-top: 20px;"><strong>Note:</strong> All related calendar events have been removed.</p>

<hr>
<p style="color: #666; font-size: 12px;">
ğŸ“¨ <strong>Recipients:</strong> RFI Participants<br>
ğŸ¤– Sent by: RFI System (Simplified) - Cancellation Notification<br>
ğŸ• Time: ${new Date().toLocaleString('th-TH')}
</p>
</body>
</html>`;
    
    const recipientList = finalRecipients.join(',');
    
    const sent = safeSendEmail({
      to: recipientList,
      subject: subject,
      htmlBody: htmlMessage,
      name: 'RFI System - Cancellation Notification'
    });
    
    Logger.log(`ğŸ“§ Cancellation email: ${sent ? 'SENT' : 'FAILED'}`);
    Logger.log(`ğŸ“§ Sent to ${finalRecipients.length} recipients`);
    
    return {
      success: sent,
      totalSent: sent ? finalRecipients.length : 0,
      totalRecipients: finalRecipients.length
    };
    
  } catch (error) {
    Logger.log(`âŒ Email error: ${error.toString()}`);
    return { success: false, error: error.toString() };
  }
}

// ===== VALIDATION & UTILITY FUNCTIONS =====

function validatePostponeInputs(rfiNumber, Description, newDate, newStartTime, newEndTime) {
  if (!rfiNumber || rfiNumber.trim() === '') {
    return { valid: false, error: "RFI Number is required" };
  }

  if (!Description || Description.trim() === '') {
    return { valid: false, error: "RFI Description is required" };
  }

  if (!newDate || newDate.trim() === '') {
    return { valid: false, error: "New date is required" };
  }

  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(newDate)) {
    return { valid: false, error: "Date must be in YYYY-MM-DD format" };
  }

  const inputDate = new Date(newDate);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  if (inputDate < today) {
    return { valid: false, error: "New date cannot be in the past" };
  }

  const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
  
  if (!newStartTime || !timeRegex.test(newStartTime)) {
    return { valid: false, error: "Start time must be in HH:MM format" };
  }
  
  if (!newEndTime || !timeRegex.test(newEndTime)) {
    return { valid: false, error: "End time must be in HH:MM format" };
  }

  const startMinutes = timeToMinutes(newStartTime);
  const endMinutes = timeToMinutes(newEndTime);
  
  if (startMinutes >= endMinutes) {
    return { valid: false, error: "Start time must be before end time" };
  }

  return { valid: true };
}

function createNewDateTime(dateStr, startTimeStr, endTimeStr) {
  try {
    const startDate = new Date(dateStr + 'T00:00:00+07:00');
    const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
    startDate.setHours(startHours, startMinutes, 0, 0);
    
    const endDate = new Date(dateStr + 'T00:00:00+07:00');
    const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
    endDate.setHours(endHours, endMinutes, 0, 0);
    
    return {
      valid: true,
      startTime: startDate,
      endTime: endDate
    };
    
  } catch (error) {
    return {
      valid: false,
      error: `Invalid date/time format: ${error.toString()}`
    };
  }
}

function timeToMinutes(timeString) {
  if (!timeString) return 0;
  const parts = timeString.split(':');
  return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function formatDate(date) {
  if (!date) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
}

function formatTime(timeValue) {
  if (!timeValue) return '';
  
  if (typeof timeValue === 'string') {
    return timeValue;
  }
  
  if (timeValue instanceof Date) {
    const hours = String(timeValue.getHours()).padStart(2, '0');
    const minutes = String(timeValue.getMinutes()).padStart(2, '0');
    return hours + ':' + minutes;
  }
  
  if (typeof timeValue === 'number') {
    const totalMinutes = Math.round(timeValue * 24 * 60);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
  }
  
  return timeValue.toString();
}

function formatDateThai(dateString) {
  if (!dateString) return '';
  
  const months = [
    'à¸¡à¸à¸£à¸²à¸„à¸¡', 'à¸à¸¸à¸¡à¸ à¸²à¸à¸±à¸™à¸˜à¹Œ', 'à¸¡à¸µà¸™à¸²à¸„à¸¡', 'à¹€à¸¡à¸©à¸²à¸¢à¸™', 'à¸à¸¤à¸©à¸ à¸²à¸„à¸¡', 'à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™',
    'à¸à¸£à¸à¸à¸²à¸„à¸¡', 'à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡', 'à¸à¸±à¸™à¸¢à¸²à¸¢à¸™', 'à¸•à¸¸à¸¥à¸²à¸„à¸¡', 'à¸à¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™', 'à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡'
  ];
  
  const date = new Date(dateString + 'T00:00:00');
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear() + 543;
  
  return day + ' ' + month + ' ' + year;
}

function createErrorResponse(code, message) {
  return {
    success: false,
    error: code,
    message: message,
    timestamp: new Date().toISOString()
  };
}

function getEmailList() {
  try {
    let emailSheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).getSheetByName('Email');
    
    if (!emailSheet) {
      emailSheet = SpreadsheetApp.openById(SURVEY_SPREADSHEET_ID).insertSheet('Email');
      emailSheet.getRange(1, 1, 1, 3).setValues([
        ['Email', 'Role', 'Name']
      ]);
      emailSheet.getRange(1, 1, 1, 3).setFontWeight('bold');
      
      return [{
        email: 'surveymarine048@gmail.com',
        role: 'Admin', 
        name: 'à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š'
      }];
    }
    
    const lastRow = emailSheet.getLastRow();
    if (lastRow <= 1) {
      return [{
        email: 'surveymarine048@gmail.com',
        role: 'Admin', 
        name: 'à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š'
      }];
    }
    
    const emailData = emailSheet.getRange(2, 1, lastRow - 1, 3).getValues();
    const emailList = [];
    
    for (let i = 0; i < emailData.length; i++) {
      const email = String(emailData[i][0] || '').trim();
      const role = String(emailData[i][1] || '').trim();
      const name = String(emailData[i][2] || '').trim();
      
      if (email && email.includes('@') && email.length > 5) {
        emailList.push({
          email: email,
          role: role,
          name: name
        });
      }
    }
    
    if (emailList.length === 0) {
      return [{
        email: 'surveymarine048@gmail.com',
        role: 'Admin', 
        name: 'à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š'
      }];
    }
    
    return emailList;
    
  } catch (error) {
    console.error('Error getting email list:', error);
    return [{
      email: 'surveymarine048@gmail.com',
      role: 'Admin', 
      name: 'à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š'
    }];
  }
}

function getAdminEmail() {
  try {
    const emailList = getEmailList();
    const admin = emailList.find(emailInfo => emailInfo.role === 'Admin');
    
    if (admin && admin.email) {
      return admin.email;
    }
    
    if (emailList.length > 0 && emailList[0].email) {
      return emailList[0].email;
    }
    
    return 'surveymarine048@gmail.com';
    
  } catch (error) {
    console.error('Error getting admin email:', error);
    return 'surveymarine048@gmail.com';
  }
}

function checkEmailQuota() {
  try {
    const remainingQuota = MailApp.getRemainingDailyQuota();
    console.log('Remaining email quota:', remainingQuota);
    return remainingQuota;
  } catch (error) {
    console.error('Error checking email quota:', error);
    return 0;
  }
}

function safeSendEmail(emailParams) {
  try {
    const quota = checkEmailQuota();
    if (quota <= 0) {
      console.log('Email quota exceeded, skipping email');
      return false;
    }
    
    MailApp.sendEmail(emailParams);
    return true;
  } catch (error) {
    console.error('Error sending email:', error);
    return false;
  }
}

const JOB_STATUS = {
  PENDING: 'à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£',
  ASSIGNED: 'à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢à¸—à¸µà¸¡à¹à¸¥à¹‰à¸§',
  IN_PROGRESS: 'à¸à¸³à¸¥à¸±à¸‡à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£',
  COMPLETED: 'à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™',
  CANCELLED: 'à¸¢à¸à¹€à¸¥à¸´à¸'
};

// ===== TEST FUNCTIONS =====

function testIntegration() {
  const testData = {
    uniqueId: 'TEST-UNIQUE-001',
    rfiId: 'RFI-TEST-001',
    date: '2025-01-20',
    startTime: '10:00',
    endTime: '12:00',
    description: 'à¸—à¸”à¸ªà¸­à¸šà¸£à¸°à¸šà¸š Integration Simplified',
    location: 'à¸ªà¸³à¸™à¸±à¸à¸‡à¸²à¸™à¸—à¸”à¸ªà¸­à¸š',
    requesterName: 'à¸œà¸¹à¹‰à¸—à¸”à¸ªà¸­à¸š',
    requesterEmail: 'test@example.com',
    note: 'à¸—à¸”à¸ªà¸­à¸šà¸ªà¹ˆà¸‡à¸­à¸µà¹€à¸¡à¸¥à¹à¸„à¹ˆ Survey Email à¹à¸¥à¸°à¹à¸¢à¸à¸ªà¸µà¸•à¸²à¸¡à¸—à¸µà¸¡',
    guest: 'guest1@example.com, guest2@example.com',
    surveyEmail: 'survey@example.com',
    assignedInspector: 'Survey Team A,Lab Team B'  // âœ… à¸—à¸”à¸ªà¸­à¸šà¸«à¸¥à¸²à¸¢à¸—à¸µà¸¡
  };
  
  const result = processRFItoSurvey(testData);
  console.log(JSON.stringify(result, null, 2));
  return result;
}

function testPostpone() {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];
  
  const result = postponeRFIInspection(
    "RFI-TEST-001",
    "Test RFI Description",
    tomorrowStr,
    "14:00",
    "16:00",
    "Testing simplified postponement",
    "requester@test.com",
    "guest1@test.com,guest2@test.com",
    "New Test Location",
    "Survey Team A,Lab Team B",  // âœ… à¸—à¸”à¸ªà¸­à¸šà¸«à¸¥à¸²à¸¢à¸—à¸µà¸¡
    false,
    30
  );
  
  Logger.log(JSON.stringify(result, null, 2));
  return result;
}

function testCancel() {
  const result = cancelRFIInspection(
    "RFI-TEST-001",
    "Test RFI Description",
    "Testing simplified cancellation",
    "requester@test.com",
    "guest1@test.com,guest2@test.com",
    false,
    30
  );
  
  Logger.log(JSON.stringify(result, null, 2));
  return result;
}

function testCalendarAccess() {
  try {
    const cal1 = CalendarApp.getCalendarById('primary');
    Logger.log('Primary Calendar: ' + (cal1 ? 'OK' : 'FAIL'));
    
    if (cal1) {
      Logger.log('Primary Calendar Name: ' + cal1.getName());
    }
  } catch (error) {
    Logger.log('Error: ' + error.toString());
  }
}

// âœ… à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¹à¸›à¸¥à¸‡à¸ªà¸µ Hex à¹€à¸›à¹‡à¸™ Calendar Color
function testColorConversion() {
  const testColors = [
    '#FF6B6B',  // à¸ªà¸µà¹à¸”à¸‡
    '#4ECDC4',  // à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¸¡à¸´à¹‰à¸™à¸•à¹Œ
    '#45B7D1',  // à¸ªà¸µà¸Ÿà¹‰à¸²
    '#FFA07A',  // à¸ªà¸µà¸ªà¹‰à¸¡
    '#FFD93D',  // à¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡
    '#95E1D3',  // à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¸­à¹ˆà¸­à¸™
    '#A29BFE',  // à¸ªà¸µà¸¡à¹ˆà¸§à¸‡
    '#DFE6E9',  // à¸ªà¸µà¹€à¸—à¸²
    '#6C5CE7',  // à¸ªà¸µà¸¡à¹ˆà¸§à¸‡à¹€à¸‚à¹‰à¸¡
    '#00B894',  // à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§
    '#E74C3C'   // à¸ªà¸µà¹à¸”à¸‡à¹€à¸‚à¹‰à¸¡
  ];
  
  Logger.log('========== COLOR CONVERSION TEST ==========');
  testColors.forEach(function(hex) {
    const rgb = hexToRGB(hex);
    Logger.log(`${hex} â†’ RGB(${rgb.r}, ${rgb.g}, ${rgb.b})`);
    hexToCalendarColor(hex); // à¸ˆà¸°à¹à¸ªà¸”à¸‡ console.log à¸”à¹‰à¸²à¸™à¹ƒà¸™
  });
  Logger.log('========== TEST COMPLETE ==========');
}
