<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Survey Work Requirement System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Kanit', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 25%, #4ade80 50%, #22c55e 75%, #16a34a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 20px;
      padding: 40px 35px;
      box-shadow: 0 20px 60px rgba(22, 163, 74, 0.3);
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    h1 {
      text-align: center;
      font-size: 32px;
      font-weight: 600;
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #4ade80 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      font-size: 16px;
      font-weight: 300;
      color: #666;
      margin-bottom: 30px;
    }

    .info-box {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-left: 4px solid #16a34a;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 25px;
      font-size: 14px;
      color: #065f46;
    }

    .info-box strong {
      color: #16a34a;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }
    
    label span {
      color: #16a34a;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e4e6eb;
      background: #ffffff;
      border-radius: 10px;
      font-family: 'Kanit', sans-serif;
      font-size: 15px;
      transition: all 0.3s ease;
      color: #333;
    }
    
    textarea {
      height: 90px;
      resize: vertical;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      background: white;
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }
    
    input::placeholder, textarea::placeholder {
      color: #999;
      font-weight: 300;
    }
    
    option {
      color: #333;
      font-weight: 400;
    }
    
    input:disabled, select:disabled, textarea:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f5f6f7;
    }
    
    .loading-select {
      background-color: #f5f6f7 !important;
      color: #666 !important;
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #4ade80 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: 'Kanit', sans-serif;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(22, 163, 74, 0.4);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 10px;
      border: 3px solid rgba(22, 163, 74, 0.2);
      border-top-color: #16a34a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading p {
      color: #666;
      font-weight: 300;
    }
    
    .message {
      padding: 12px 16px;
      margin-top: 20px;
      border-radius: 10px;
      text-align: center;
      display: none;
      font-size: 14px;
      animation: slideIn 0.3s ease-out;
      white-space: pre-line;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    
    .error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    
    .info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }
    
    .warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    
    .time-info {
      font-size: 12px;
      color: #16a34a;
      margin-top: 5px;
      font-style: italic;
    }
    
    .footer-info {
      text-align: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e4e6eb;
    }
    
    .footer-info p {
      color: #666;
      font-size: 14px;
      margin: 5px 0;
    }
    
    .footer-info .version {
      color: #999;
      font-size: 12px;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #16a34a 0%, #22c55e 100%);
      border-radius: 10px;
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 30px 20px;
      }
      
      h1 {
        font-size: 26px;
      }
      
      .subtitle {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
   <div class="header-section" style="text-align: center; margin-bottom: 30px;">
      <!-- Icon Container -->
      <div style="display: inline-flex; align-items: center; justify-content: center; width: 65px; height: 65px; background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); border-radius: 16px; margin-bottom: 12px; box-shadow: 0 6px 20px rgba(22, 163, 74, 0.3);">
        <span style="font-size: 36px;">üó∫Ô∏è</span>
      </div>
      
      <!-- Title with Icon Decoration -->
      <h1>
        <span style="display: inline-flex; align-items: center; gap: 10px;">
          Survey Work System
          <span style="font-size: 20px; color: #16a34a;">‚úì</span>
        </span>
      </h1>
      <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á Survey Work Requirement</p>
    </div>
    
    <div class="info-box">
      <strong>üìå ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</strong> ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 30 ‡∏ô‡∏≤‡∏ó‡∏µ<br>
      <strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:</strong> 09:00 - 20:00 ‡∏ô.<br>
      <strong>üë• ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô:</strong> Survey Teams ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    </div>
    
    <form id="surveyWorkForm">
      <div class="form-group">
        <label for="requestDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ <span>*</span></label>
        <input type="date" id="requestDate" name="requestDate" required>
      </div>
      
      <div class="form-group">
        <label for="workType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô <span>*</span></label>
        <select id="workType" name="workType" required>
          <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... --</option>
        </select>
        <div class="time-info">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô Survey ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>
      </div>
      
      <div class="form-group">
        <label for="startTime">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <span>*</span></label>
        <select id="startTime" name="startTime" required disabled>
          <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>
        </select>
        <div class="time-info">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>
      </div>
      
      <div class="form-group">
        <label for="endTime">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span>*</span></label>
        <select id="endTime" name="endTime" required disabled>
          <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>
        </select>
        <div class="time-info">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô +1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
      </div>
      
      <div class="form-group">
        <label for="description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Survey Work <span>*</span></label>
        <textarea id="description" name="description" required placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô Survey ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"></textarea>
      </div>
      
      <div class="form-group">
        <label for="location">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà <span>*</span></label>
        <input type="text" id="location" name="location" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">
      </div>
      
      <div class="form-group">
        <label for="requesterName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ <span>*</span></label>
        <input type="text" id="requesterName" name="requesterName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      
      <div class="form-group">
        <label for="requesterEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ <span>*</span></label>
        <input type="email" id="requesterEmail" name="requesterEmail" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">
      </div>
      
      <button type="submit" id="submitBtn">‡∏™‡πà‡∏á Survey Work Request</button>
    </form>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>
    
    <div id="message" class="message"></div>
    
    <div class="footer-info">
      <p>Survey Work Requirement System</p>
      <p class="version">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏µ‡∏° Survey ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    </div>
  </div>
  
  <script>
    window.onload = function() {
      setMinDate();
      loadWorkTypes();
      showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á Survey Work', 'info');
    };
    
    function setMinDate() {
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      const dateString = tomorrow.getFullYear() + '-' + 
                        String(tomorrow.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(tomorrow.getDate()).padStart(2, '0');
      document.getElementById('requestDate').setAttribute('min', dateString);
    }
    
    function loadWorkTypes() {
      const workTypeSelect = document.getElementById('workType');
      workTypeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô... --</option>';
      workTypeSelect.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(workTypes) {
          workTypeSelect.innerHTML = '';
          
          if (!workTypes || workTypes.length === 0) {
            workTypeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>';
            showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet "Work"', 'warning');
          } else {
            workTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>';
            
            workTypes.forEach(function(workType) {
              const option = document.createElement('option');
              option.value = workType;
              option.textContent = workType;
              workTypeSelect.appendChild(option);
            });
            
            workTypeSelect.disabled = false;
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading work types:', error);
          workTypeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
          showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô', 'error');
        })
        .getWorkTypeList();
    }
    
    function showMessage(text, type, duration) {
      if (typeof duration === 'undefined') duration = 5000;
      
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = 'message ' + type;
      messageDiv.style.display = 'block';
      
      setTimeout(function() {
        messageDiv.style.display = 'none';
      }, duration);
    }
    
    document.getElementById('requestDate').addEventListener('change', updateAvailableSlots);
    document.getElementById('startTime').addEventListener('change', updateEndTimeSlots);
    document.getElementById('surveyWorkForm').addEventListener('submit', handleSubmit);
    
    function updateAvailableSlots() {
      const date = document.getElementById('requestDate').value;
      const startTimeSelect = document.getElementById('startTime');
      const endTimeSelect = document.getElementById('endTime');
      
      setSelectLoading(startTimeSelect, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á...');
      resetEndTimeSelect();
      
      if (date) {
        const selectedDate = new Date(date + 'T00:00:00');
        const today = new Date();
        const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
        
        if (selectedDateOnly <= todayDateOnly) {
          startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
          startTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ --</option>';
          startTimeSelect.disabled = true;
          showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', 'warning');
          return;
        }
        
        google.script.run
          .withSuccessHandler(function(availableSlots) {            
            startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
            startTimeSelect.innerHTML = '';
            
            if (!availableSlots || availableSlots.length === 0) {
              startTimeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á --</option>';
              startTimeSelect.disabled = true;
              showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'warning');
            } else {
              startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô --</option>';
              
              availableSlots.forEach(function(slot) {
                const option = document.createElement('option');
                option.value = slot;
                option.textContent = slot + ' ‡∏ô.';
                startTimeSelect.appendChild(option);
              });
              
              startTimeSelect.disabled = false;
            }
          })
          .withFailureHandler(function(error) {
            console.error('Error getting available slots:', error);
            startTimeSelect.className = startTimeSelect.className.replace(' loading-select', '');
            startTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
            startTimeSelect.disabled = true;
            showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á: ' + error.message, 'error');
          })
          .getSurveyAvailableTimeSlots(date);
      } else {
        startTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>';
        startTimeSelect.disabled = true;
      }
    }
    
    function updateEndTimeSlots() {
      const date = document.getElementById('requestDate').value;
      const startTime = document.getElementById('startTime').value;
      const endTimeSelect = document.getElementById('endTime');
      
      if (!startTime) {
        resetEndTimeSelect();
        return;
      }
      
      setSelectLoading(endTimeSelect, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î...');
      
      if (date && startTime) {
        google.script.run
          .withSuccessHandler(function(availableEndTimes) {
            endTimeSelect.className = endTimeSelect.className.replace(' loading-select', '');
            endTimeSelect.innerHTML = '';
            
            if (!availableEndTimes || availableEndTimes.length === 0) {
              endTimeSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á --</option>';
              endTimeSelect.disabled = true;
              showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', 'warning');
            } else {
              endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î --</option>';
              
              const startHour = parseInt(startTime.split(':')[0]);
              const startMinute = parseInt(startTime.split(':')[1]);
              const defaultEndTime = (startHour + 1).toString().padStart(2, '0') + ':' + 
                                   startMinute.toString().padStart(2, '0');
              
              availableEndTimes.forEach(function(time) {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time + ' ‡∏ô.';
                if (time === defaultEndTime) {
                  option.selected = true;
                }
                endTimeSelect.appendChild(option);
              });
              
              endTimeSelect.disabled = false;
              
              if (availableEndTimes.includes(defaultEndTime)) {
                showMessage('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ' + defaultEndTime + ' ‡∏ô. (1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)', 'info', 3000);
              }
            }
          })
          .withFailureHandler(function(error) {
            console.error('Error getting end times:', error);
            endTimeSelect.className = endTimeSelect.className.replace(' loading-select', '');
            endTimeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';
            endTimeSelect.disabled = true;
            showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ' + error.message, 'error');
          })
          .getSurveyAvailableEndTimes(date, startTime);
      }
    }
    
    function setSelectLoading(selectElement, loadingText) {
      selectElement.innerHTML = '<option value="">' + loadingText + '</option>';
      selectElement.className += ' loading-select';
      selectElement.disabled = true;
    }
    
    function resetEndTimeSelect() {
      const endTimeSelect = document.getElementById('endTime');
      endTimeSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>';
      endTimeSelect.disabled = true;
    }
    
    function handleSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.querySelector('.loading');
      
      const formData = {
        requestDate: document.getElementById('requestDate').value,
        workType: document.getElementById('workType').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        description: document.getElementById('description').value.trim(),
        location: document.getElementById('location').value.trim(),
        requesterName: document.getElementById('requesterName').value.trim(),
        requesterEmail: document.getElementById('requesterEmail').value.trim()
      };
      
      const requiredFields = ['requestDate', 'workType', 'startTime', 'endTime', 'description', 'location', 'requesterName', 'requesterEmail'];
      const missingFields = requiredFields.filter(field => !formData[field]);
      
      if (missingFields.length > 0) {
        showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }
      
      submitBtn.disabled = true;
      loading.style.display = 'block';
      
      google.script.run
        .withSuccessHandler(function(result) {
          loading.style.display = 'none';
          submitBtn.disabled = false;
          
          if (result && result.success) {
            showMessage(result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Survey Work Request ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success', 8000);
            resetForm();
          } else {
            const errorMessage = result && result.message ? result.message : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
            showMessage(errorMessage, 'error');
          }
        })
        .withFailureHandler(function(error) {
          loading.style.display = 'none';
          submitBtn.disabled = false;
          const errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + (error.message || error.toString());
          showMessage(errorMessage, 'error');
        })
        .saveSurveyWorkRequirement(formData);
    }
    
    function resetForm() {
      document.getElementById('surveyWorkForm').reset();
      document.getElementById('startTime').innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô --</option>';
      document.getElementById('startTime').disabled = true;
      resetEndTimeSelect();
      loadWorkTypes();
      setMinDate();
    }
  </script>
</body>
</html>
